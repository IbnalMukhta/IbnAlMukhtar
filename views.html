<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --navy: #001F3F;
            --orange: #FF8C00;
            --light-bg: #f4f7f9;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0, 31, 63, 0.08);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            color: var(--navy);
        }

        /* Header Layout */
        header {
            background: linear-gradient(135deg, var(--navy) 0%, #003366 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            border-bottom-left-radius: 50px;
            border-bottom-right-radius: 50px;
            box-shadow: var(--shadow);
        }

        header h1 { margin: 0; font-weight: 900; font-size: 28px; }
        header p { opacity: 0.8; margin-top: 10px; }

        .container {
            max-width: 1200px;
            margin: -40px auto 50px;
            padding: 0 20px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 30px; color: var(--orange); margin-bottom: 15px; display: block; }
        .stat-card h3 { font-size: 16px; color: #666; margin: 0; }
        .stat-card .number { font-size: 35px; font-weight: 800; margin: 10px 0; color: var(--navy); }
        
        /* Chart Section */
        .chart-container {
            background: var(--white);
            padding: 30px;
            border-radius: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-refresh {
            background: var(--orange);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .btn-refresh:hover { background: #e67e00; }

        canvas { max-height: 400px; }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
            header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>

<header>
    <h1><i class="fas fa-chart-line"></i> Ù…Ø±ÙƒØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±</h1>
    <p>Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ù„Ø²ÙˆØ§Ø±</p>
</header>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <h3>Ø²ÙˆØ§Ø± Ø§Ù„ÙŠÙˆÙ…</h3>
            <div class="number" id="todayCount">0</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-calendar-week"></i>
            <h3>Ø²ÙˆØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
            <div class="number" id="weekCount">0</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-user-friends"></i>
            <h3>Ø²ÙˆØ§Ø± Ø§Ù„Ø´Ù‡Ø±</h3>
            <div class="number" id="monthCount">0</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-globe"></i>
            <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…</h3>
            <div class="number" id="totalCount">0</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h2 style="margin:0; font-size:18px;">ðŸ“ˆ Ù…Ù†Ø­Ù†Ù‰ Ù†Ø´Ø§Ø· Ø§Ù„Ø²ÙˆØ§Ø± (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h2>
            <button class="btn-refresh" onclick="loadDashboard()">
                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
            </button>
        </div>
        <canvas id="visitorChart"></canvas>
    </div>
</div>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Supabase
    const URL = 'https://ukjgzbgzzmlprnhlwgpr.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVramd6Ymd6em1scHJuaGx3Z3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM4NzAsImV4cCI6MjA4MTIyOTg3MH0.A-xvwqyDxwxDTeiB8nBgOwrJTPLWenYlO99nxbgobTw';
    const sb = supabase.createClient(URL, KEY);

    let myChart;

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø£Ø±Ù‚Ø§Ù…
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    async function loadDashboard() {
        const now = new Date();
        const todayStart = new Date(now.setHours(0,0,0,0)).toISOString();
        const weekStart = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString();
        const monthStart = new Date(new Date().setMonth(new Date().getMonth() - 1)).toISOString();

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
        const { count: today } = await sb.from('visits').select('*', { count: 'exact', head: true }).gt('visited_at', todayStart);
        const { count: week } = await sb.from('visits').select('*', { count: 'exact', head: true }).gt('visited_at', weekStart);
        const { count: month } = await sb.from('visits').select('*', { count: 'exact', head: true }).gt('visited_at', monthStart);
        const { count: total } = await sb.from('visits').select('*', { count: 'exact', head: true });

        // ØªØ´ØºÙŠÙ„ Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        animateValue(document.getElementById('todayCount'), 0, today || 0, 1000);
        animateValue(document.getElementById('weekCount'), 0, week || 0, 1000);
        animateValue(document.getElementById('monthCount'), 0, month || 0, 1000);
        animateValue(document.getElementById('totalCount'), 0, total || 0, 1000);

        loadChartData();
    }

    async function loadChartData() {
        // Ø¬Ù„Ø¨ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù… Ø¨Ø´ÙƒÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        const { data: visits } = await sb.from('visits').select('visited_at');
        
        const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        const counts = new Array(7).fill(0);
        const labels = [];

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            labels.push(days[d.getDay()]);
            
            const dayStart = new Date(d.setHours(0,0,0,0));
            const dayEnd = new Date(d.setHours(23,59,59,999));

            const dailyVisits = visits.filter(v => {
                const vDate = new Date(v.visited_at);
                return vDate >= dayStart && vDate <= dayEnd;
            });
            counts[6-i] = dailyVisits.length;
        }

        renderChart(labels, counts);
    }

    function renderChart(labels, data) {
        const ctx = document.getElementById('visitorChart').getContext('2d');
        
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª',
                    data: data,
                    borderColor: '#FF8C00',
                    backgroundColor: 'rgba(255, 140, 0, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#001F3F',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { display: false } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    loadDashboard();
</script>
</body>
</html>
