<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¹Ø¯Ø§Ø¯ Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #010409; color: white; font-family: 'Tajawal', sans-serif; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; padding: 20px; }
        .stat-box { background: #0d1117; padding: 30px; border-radius: 25px; border: 2px solid #30363d; text-align: center; min-width: 220px; }
        .label { font-size: 1.1rem; color: #8b949e; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .number { font-size: 4rem; font-weight: 900; margin: 0; color: #FF8C00; }
        .live-color { color: #238636; }
        .today-color { color: #58a6ff; }
        .dot { height: 10px; width: 10px; background: #238636; border-radius: 50%; animation: pulse 1.5s infinite; }
        .refresh-btn { margin-top: 20px; padding: 10px 20px; background: #21262d; border: 1px solid #30363d; color: #c9d1d9; border-radius: 8px; cursor: pointer; font-family: inherit; transition: 0.3s; }
        .refresh-btn:hover { background: #30363d; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="stat-box">
            <div class="label"><div class="dot"></div> Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</div>
            <p class="number live-color" id="live-count">0</p>
        </div>

        <div class="stat-box">
            <div class="label">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <p class="number today-color" id="today-count">0</p>
        </div>

        <div class="stat-box">
            <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙˆØ§Ø±</div>
            <p class="number" id="total-count">0</p>
        </div>
    </div>

    <button class="refresh-btn" onclick="updateStats()">ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ</button>

    <script>
        const SUPABASE_URL = 'https://mpcuradmirhcfmwvsylt.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_MJRUl3ON-d61CnFsJ-pFJA_Nbbpg_gZ';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØµÙØ­)
        async function logUniqueVisit() {
            const isReturningUser = localStorage.getItem('is_old_visitor');
            
            if (!isReturningUser) {
                try {
                    const { error } = await sb.from('visits').insert([{ page_path: window.location.pathname }]);
                    if (!error) localStorage.setItem('is_old_visitor', 'true');
                } catch (e) { console.error(e); }
            }
        }

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        async function updateStats() {
            try {
                // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
                const now = new Date();
                
                // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„Ø³Ø§Ø¹Ø© 00:00:00)
                const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                
                // Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ø¢Ù†
                const fiveMinAgo = new Date(now.getTime() - 5 * 60000).toISOString();

                // ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø£Ø¯Ø§Ø¡
                const [totalRes, todayRes, liveRes] = await Promise.all([
                    sb.from('visits').select('*', { count: 'exact', head: true }),
                    sb.from('visits').select('*', { count: 'exact', head: true }).gt('created_at', startOfToday),
                    sb.from('visits').select('*', { count: 'exact', head: true }).gt('created_at', fiveMinAgo)
                ]);

                if (!totalRes.error) document.getElementById('total-count').innerText = totalRes.count.toLocaleString();
                if (!todayRes.error) document.getElementById('today-count').innerText = todayRes.count.toLocaleString();
                if (!liveRes.error) document.getElementById('live-count').innerText = liveRes.count.toLocaleString();

            } catch (e) { console.error("Update Error:", e); }
        }

        // Ø§Ù„ØªØ´ØºÙŠÙ„
        logUniqueVisit().then(updateStats);
        setInterval(updateStats, 60000); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
    </script>
</body>
</html>
