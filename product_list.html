<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root { 
      --primary: #c6a047; 
      --primary-light: #fff9e6;
      --primary-dark: #b18c34; 
      --bg-color: #f8f9fa; 
      --card-bg: #ffffff; 
      --text-color: #333; 
      --error-color: #dc3545; 
      --success-color: #28a745;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --gray: #6c757d;
      --light-gray: #f8f9fa;
    }
    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      margin: 0; 
      padding: 0; 
    }
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: var(--bg-color); 
      color: var(--text-color); 
      margin: 0; 
      padding: 70px 0 100px; 
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    header { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      height: 60px; 
      background: #fff; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 0 15px; 
      box-shadow: 0 2px 15px rgba(0,0,0,0.08); 
      z-index: 1000; 
      border-bottom: 2px solid var(--primary);
    }
    header h1 { 
      margin: 0; 
      font-size: 16px; 
      color: var(--primary); 
      font-weight: 800; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .admin-nav {
      display: flex;
      gap: 5px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
      flex: 1;
    }
    .nav-link { 
      text-decoration: none; 
      font-size: 12px; 
      font-weight: bold; 
      color: #333; 
      background: #eee; 
      padding: 5px 10px; 
      border-radius: 15px; 
      transition: all 0.3s; 
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      min-width: fit-content;
    }
    .nav-link:hover { background: var(--primary); color: #fff; }
    .nav-link.active-tab { background: var(--primary); color: #fff; }
    
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      font-size: 20px;
      color: var(--primary);
      cursor: pointer;
      padding: 5px;
    }

    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 16px; 
    }
    .card { 
      background: var(--card-bg); 
      border-radius: 16px; 
      padding: 20px; 
      margin-bottom: 20px; 
      border: 1px solid #f0f0f0; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
    }
    h2 { 
      margin-top: 0; 
      color: #333; 
      border-bottom: 1px solid #eee; 
      padding-bottom: 12px; 
      margin-bottom: 20px; 
      font-size: 18px; 
      display: flex;
      align-items: center;
      gap: 10px;
    }
    h3 { color: #555; font-size: 16px; margin: 20px 0 12px; }
    
    .filters-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .filter-item {
      display: flex;
      flex-direction: column;
      min-width: 180px;
      flex: 1;
    }
    .filter-item label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 13px;
    }
    .filter-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: white;
      font-family: 'Tajawal';
      font-size: 13px;
    }
    .search-container {
      position: relative;
      flex: 2;
      min-width: 250px;
    }
    .search-input {
      width: 100%;
      padding: 8px 12px 8px 35px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: 'Tajawal';
      font-size: 13px;
    }
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 14px;
    }
    
    /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù */
    .function-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 5px;
    }
    .function-tab {
      padding: 12px 20px;
      background: #f0f0f0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .function-tab:hover {
      background: #e6e6e6;
    }
    .function-tab.active {
      background: var(--primary);
      color: white;
    }
    
    /* Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .products-table-container {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid #eee;
      margin-top: 20px;
    }
    .products-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }
    .products-table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: right;
      font-weight: 700;
      color: #333;
      border-bottom: 2px solid #eee;
      white-space: nowrap;
      font-size: 13px;
    }
    .products-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      font-size: 13px;
    }
    .products-table tr:hover {
      background-color: #f9f9f9;
    }
    
    .product-image-cell {
      width: 60px;
    }
    .product-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    
    .product-name {
      font-weight: 600;
      color: #333;
      max-width: 200px;
      font-size: 14px;
    }
    .product-price {
      font-weight: 700;
      color: var(--primary);
      font-size: 14px;
    }
    .product-category {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 11px;
      display: inline-block;
    }
    
    /* Ù‚Ø³Ù… ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .refresh-container {
      display: none;
    }
    
    .refresh-toolbar {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #eaeaea;
      flex-wrap: wrap;
    }
    
    .refresh-search-box { 
      flex: 1; 
      padding: 12px 18px; 
      border: 2px solid #eaeaea; 
      border-radius: 10px; 
      font-family: inherit; 
      font-size: 15px;
      outline: none;
      transition: all 0.3s;
      background: var(--light-gray);
      min-width: 200px;
    }
    .refresh-search-box:focus { 
      border-color: var(--primary); 
      background: var(--card-bg);
      box-shadow: 0 0 0 3px rgba(198, 160, 71, 0.1);
    }
    
    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªÙ†Ø´ÙŠØ· */
    .refresh-products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }

    .refresh-product-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 12px;
      text-align: center;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      box-shadow: 0 3px 8px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .refresh-product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-color: var(--primary);
    }
    
    .refresh-product-card.selected {
      border-color: var(--primary);
      background: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(198, 160, 71, 0.2);
    }

    .refresh-product-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #f5f5f5, #eaeaea);
      border: 1px solid #f0f0f0;
    }

    .refresh-product-card h4 {
      margin: 5px 0;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-color);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
      flex-grow: 1;
    }
    
    /* Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ù„ØªÙ†Ø´ÙŠØ· */
    .refresh-select-badge {
      position: absolute; 
      top: 8px; 
      right: 8px;
      background: rgba(255,255,255,0.9); 
      color: var(--gray);
      width: 28px; 
      height: 28px; 
      border-radius: 50%;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 12px; 
      z-index: 10;
      transition: all 0.3s;
      border: 2px solid #ddd;
    }

    .selected .refresh-select-badge {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 3px 8px rgba(198, 160, 71, 0.3);
    }

    .refresh-select-badge i { 
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s;
    }
    
    .selected .refresh-select-badge i { 
      opacity: 1;
      transform: scale(1);
    }
    
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ø´ÙŠØ· */
    .refresh-actions {
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0;
      background: var(--card-bg); 
      padding: 15px 20px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
      display: none; 
      gap: 12px; 
      justify-content: center;
      align-items: center;
      z-index: 1000;
      border-top: 1px solid #eee;
    }

    .refresh-btn {
      padding: 14px 25px; 
      border-radius: 30px; 
      border: none;
      font-weight: bold; 
      cursor: pointer; 
      font-family: inherit;
      display: flex; 
      align-items: center; 
      gap: 8px; 
      transition: all 0.3s;
      font-size: 15px;
      min-height: 50px;
      background: linear-gradient(135deg, var(--primary), #d4b15a); 
      color: white; 
      flex: 1; 
      max-width: 350px; 
      justify-content: center;
      box-shadow: 0 4px 12px rgba(198, 160, 71, 0.3);
    }
    
    .refresh-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(198, 160, 71, 0.4);
    }
    
    .refresh-btn:disabled { 
      background: #ccc; 
      cursor: not-allowed;
      box-shadow: none;
      transform: none !important;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 45px;
      height: 22px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 22px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: var(--success-color);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(23px);
    }
    
    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: 'Tajawal';
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    .btn-success {
      background: var(--success-color);
      color: white;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-danger {
      background: var(--error-color);
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 600;
      display: inline-block;
    }
    .status-hidden {
      background: #ffc107;
      color: #333;
    }
    .status-out-of-stock {
      background: #dc3545;
      color: white;
    }
    .status-active {
      background: #28a745;
      color: white;
    }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
    .toolbar-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .toolbar-btn {
      padding: 8px 16px;
      background: #f0f0f0;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-family: 'Tajawal';
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toolbar-btn:hover {
      background: #e6e6e6;
    }
    
    .toolbar-btn.select-all {
      background: var(--primary-light);
      color: var(--primary-dark);
    }
    
    .loading-overlay { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(255, 255, 255, 0.97); 
      z-index: 2000; 
      justify-content: center; 
      align-items: center; 
      flex-direction: column;
      backdrop-filter: blur(5px);
    }
    .loading-spinner { 
      width: 60px; 
      height: 60px; 
      border: 4px solid rgba(198, 160, 71, 0.1); 
      border-top: 4px solid var(--primary); 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .notification { 
      position: fixed; 
      top: 70px; 
      right: 15px; 
      left: 15px;
      padding: 12px 15px; 
      border-radius: 8px; 
      color: white; 
      font-weight: 500; 
      z-index: 1001; 
      box-shadow: 0 3px 10px rgba(0,0,0,0.15); 
      display: none;
      animation: slideIn 0.3s ease-out; 
      max-width: 100%;
      backdrop-filter: blur(5px);
      text-align: center;
    }
    .notification.success { background-color: rgba(40, 167, 69, 0.95); }
    .notification.error { background-color: rgba(220, 53, 69, 0.95); }
    .notification.warning { background-color: rgba(255, 193, 7, 0.95); color: #333; }
    .notification.info { background-color: rgba(23, 162, 184, 0.95); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    .no-products {
      text-align: center;
      padding: 30px;
      color: #666;
    }
    .no-products i {
      font-size: 40px;
      margin-bottom: 10px;
      color: #ddd;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .pagination-btn {
      padding: 6px 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Tajawal';
      font-size: 12px;
      min-width: 30px;
    }
    .pagination-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .pagination-btn:hover:not(.active) {
      background: #f8f9fa;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid #f0f0f0;
    }
    .stat-card i {
      font-size: 22px;
      margin-bottom: 8px;
    }
    .stat-card.total i { color: var(--primary); }
    .stat-card.hidden i { color: var(--warning-color); }
    .stat-card.out-of-stock i { color: var(--error-color); }
    .stat-card.active i { color: var(--success-color); }
    
    .stat-number {
      font-size: 18px;
      font-weight: 700;
      margin: 5px 0;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
    }
    
    .mobile-nav {
      display: none;
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      z-index: 999;
      padding: 10px;
      flex-direction: column;
      gap: 5px;
    }
    .mobile-nav.show {
      display: flex;
    }
    
    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„ØªØ­Ø¯ÙŠØ¯ */
    @keyframes selectPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    @media (max-width: 768px) {
      header h1 {
        font-size: 14px;
        max-width: 150px;
      }
      
      .mobile-menu-btn {
        display: block;
      }
      
      .admin-nav {
        display: none;
      }
      
      .container { padding: 10px; }
      .card { padding: 15px; }
      .filters-container {
        flex-direction: column;
        gap: 10px;
      }
      .search-container {
        min-width: 100%;
      }
      .filter-item {
        min-width: 100%;
      }
      .refresh-products-grid { 
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
        gap: 12px;
      }
      .refresh-product-card img {
        height: 120px;
      }
      .refresh-toolbar {
        padding: 12px;
        flex-wrap: wrap;
      }
      .refresh-search-box {
        order: 1;
        width: 100%;
        margin-top: 10px;
      }
      .refresh-actions {
        padding: 12px 15px;
      }
      .stats-container {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .products-table td, .products-table th {
        padding: 8px 5px;
        font-size: 12px;
      }
      .product-image {
        width: 40px;
        height: 40px;
      }
      .notification {
        top: 60px;
        right: 10px;
        left: 10px;
        padding: 10px;
        font-size: 14px;
      }
      .function-tabs {
        overflow-x: auto;
      }
    }
    
    @media (max-width: 480px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      .product-name {
        max-width: 120px;
      }
      .products-table {
        min-width: 600px;
      }
      .btn {
        padding: 5px 8px;
        font-size: 11px;
      }
      .refresh-products-grid { 
        grid-template-columns: repeat(2, 1fr); 
      }
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <h1><i class="fas fa-cogs"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
  
  <button class="mobile-menu-btn" id="mobileMenuBtn">
    <i class="fas fa-bars"></i>
  </button>
  
  <div class="admin-nav" id="desktopNav">
    <a href="add_product.html" class="nav-link">
      <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
    </a>
    <a href="manage_products.html" class="nav-link active-tab">
      <i class="fas fa-cogs"></i> Ø¥Ø¯Ø§Ø±Ø©
    </a>
    <a href="index.html" class="nav-link">
      <i class="fas fa-store"></i> Ø§Ù„Ù…ØªØ¬Ø±
    </a>
    <a href="views.html" class="nav-link">
      <i class="fas fa-eye"></i> Ø§Ù„Ø²ÙˆØ§Ø±
    </a>
    <a href="khlil.html" class="nav-link">
      <i class="fas fa-sort-amount-down"></i> ØªØ±ØªÙŠØ¨
    </a>
    <a href="discount.html" class="nav-link">
      <i class="fas fa-tags"></i> Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
    </a>
    <a href="khlilsh.html" class="nav-link">
      <i class="fas fa-edit"></i> Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø§Øª
    </a>
  </div>
</header>

<div class="mobile-nav" id="mobileNav">
  <a href="admin.html" class="nav-link">
    <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
  </a>
  <a href="manage_products.html" class="nav-link active-tab">
    <i class="fas fa-cogs"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  </a>
  <a href="index.html" class="nav-link">
    <i class="fas fa-store"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  </a>
  <a href="views.html" class="nav-link">
    <i class="fas fa-eye"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±
  </a>
  <a href="discount.html" class="nav-link">
    <i class="fas fa-tags"></i> Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª
  </a>
  <a href="khlilsh.html" class="nav-link">
    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ³Ø¹ÙŠØ±Ø§Øª
  </a>
</div>

<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
  <span id="loadingText">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</span>
</div>

<div id="notification" class="notification"></div>

<div class="container">
  
  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
  <div class="stats-container">
    <div class="stat-card total">
      <i class="fas fa-boxes"></i>
      <div class="stat-number" id="totalProducts">0</div>
      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    </div>
    <div class="stat-card active">
      <i class="fas fa-eye"></i>
      <div class="stat-number" id="activeProducts">0</div>
      <div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
    </div>
    <div class="stat-card hidden">
      <i class="fas fa-eye-slash"></i>
      <div class="stat-number" id="hiddenProducts">0</div>
      <div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ÙÙŠØ©</div>
    </div>
    <div class="stat-card out-of-stock">
      <i class="fas fa-exclamation-triangle"></i>
      <div class="stat-number" id="outOfStockProducts">0</div>
      <div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</div>
    </div>
  </div>
  
  <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù -->
  <div class="function-tabs">
    <div class="function-tab active" id="managementTab">
      <i class="fas fa-list"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    </div>
    <div class="function-tab" id="refreshTab">
      <i class="fas fa-bolt"></i> ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    </div>
    <div class="function-tab" id="batchTab">
      <i class="fas fa-tasks"></i> Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¬Ù…Ø¹Ø©
    </div>
  </div>
  
  <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <div class="card" id="managementSection">
    <h2><i class="fas fa-cogs"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    
    <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
    <div class="filters-container">
      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
      </div>
      
      <div class="filter-item">
        <label for="categoryFilter">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
        <select id="categoryFilter" class="filter-select">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
        </select>
      </div>
      
      <div class="filter-item">
        <label for="statusFilter">Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="statusFilter" class="filter-select">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="active">Ù†Ø´Ø·</option>
          <option value="hidden">Ù…Ø®ÙÙŠ</option>
          <option value="out_of_stock">Ù…Ù†ØªÙ‡ÙŠ</option>
        </select>
      </div>
      
      <div class="filter-item">
        <label for="sortBy">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
        <select id="sortBy" class="filter-select">
          <option value="created_at_desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
          <option value="created_at_asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
          <option value="name_asc">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
          <option value="name_desc">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
          <option value="price_asc">Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†Ø®ÙØ¶ Ø¥Ù„Ù‰ Ù…Ø±ØªÙØ¹)</option>
          <option value="price_desc">Ø§Ù„Ø³Ø¹Ø± (Ù…Ø±ØªÙØ¹ Ø¥Ù„Ù‰ Ù…Ù†Ø®ÙØ¶)</option>
        </select>
      </div>
    </div>
    
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
    <div class="toolbar-actions">
      <button class="toolbar-btn select-all" onclick="selectAllInManagement()">
        <i class="fas fa-check-double"></i>
        <span id="selectAllText">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span>
      </button>
      <button class="toolbar-btn" onclick="toggleHiddenForSelected()" id="toggleHiddenBtn">
        <i class="fas fa-eye-slash"></i> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø®ÙØ§Ø¡
      </button>
      <button class="toolbar-btn" onclick="toggleOutOfStockForSelected()" id="toggleOutOfStockBtn">
        <i class="fas fa-box"></i> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©
      </button>
      <button class="toolbar-btn btn-danger" onclick="deleteSelectedProducts()" id="deleteSelectedBtn">
        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
      </button>
    </div>
    
    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="products-table-container">
      <table class="products-table">
        <thead>
          <tr>
            <th width="50"><input type="checkbox" id="selectAllCheckbox"></th>
            <th>Ø§Ù„ØµÙˆØ±Ø©</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="productsTableBody">
          <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </tbody>
      </table>
    </div>
    
    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª -->
    <div id="noProductsMessage" class="no-products" style="display: none;">
      <i class="fas fa-box-open"></i>
      <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</h3>
      <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</p>
      <a href="add_product.html" class="btn btn-primary">
        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
      </a>
    </div>
    
    <!-- ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª -->
    <div class="pagination" id="paginationContainer" style="display: none;">
      <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    </div>
  </div>
  
  <!-- Ù‚Ø³Ù… ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <div class="card refresh-container" id="refreshSection">
    <h2><i class="fas fa-bolt"></i> ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <p style="color: #666; margin-bottom: 20px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</p>
    
    <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ†Ø´ÙŠØ· -->
    <div class="refresh-toolbar">
      <button class="toolbar-btn" onclick="toggleSelectAllRefresh()">
        <i class="fas fa-check-double"></i>
        <span id="refreshSelectAllText">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span>
      </button>
      <button class="toolbar-btn" onclick="clearRefreshSelection()">
        <i class="fas fa-times-circle"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
      </button>
      <input type="text" id="refreshSearchInput" class="refresh-search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø§Ø³Ù…...">
      <select id="refreshCategoryFilter" class="filter-select" style="min-width: 150px;">
        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
      </select>
    </div>
    
    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªÙ†Ø´ÙŠØ· -->
    <div id="refreshProductsGrid" class="refresh-products-grid">
      <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    </div>
    
    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª -->
    <div id="noRefreshProductsMessage" class="no-products" style="display: none;">
      <i class="fas fa-box-open"></i>
      <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</h3>
      <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</p>
    </div>
  </div>
  
  <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© -->
  <div class="card refresh-container" id="batchSection">
    <h2><i class="fas fa-tasks"></i> Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¬Ù…Ø¹Ø©</h2>
    
    <div class="batch-options">
      <div class="batch-option">
        <h3><i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¬Ù…Ø¹</h3>
        <p>Ø¥Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</p>
        <div class="batch-action">
          <button class="btn btn-warning" onclick="batchHideProducts()">
            <i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯
          </button>
          <button class="btn btn-success" onclick="batchShowProducts()">
            <i class="fas fa-eye"></i> Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
          </button>
        </div>
      </div>
      
      <div class="batch-option">
        <h3><i class="fas fa-box"></i> Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙ…ÙŠØ©</h3>
        <p>ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
        <div class="batch-action">
          <button class="btn btn-danger" onclick="batchMarkOutOfStock()">
            <i class="fas fa-times-circle"></i> ØªØ¹ÙŠÙŠÙ† ÙƒÙ€ "Ù…Ù†ØªÙ‡ÙŠ"
          </button>
          <button class="btn btn-success" onclick="batchMarkInStock()">
            <i class="fas fa-check-circle"></i> ØªØ¹ÙŠÙŠÙ† ÙƒÙ€ "Ù…ØªÙˆÙØ±"
          </button>
        </div>
      </div>
      
      <div class="batch-option">
        <h3><i class="fas fa-tags"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ</h3>
        <p>ØªØºÙŠÙŠØ± ØªØµÙ†ÙŠÙ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
        <div class="batch-action">
          <select id="batchCategorySelect" class="filter-select" style="width: 200px;">
            <option value="">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</option>
          </select>
          <button class="btn btn-primary" onclick="updateCategoryForSelected()">
            <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
          </button>
        </div>
      </div>
    </div>
  </div>
  
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ø´ÙŠØ· Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© -->
<div class="refresh-actions" id="refreshActions">
  <button id="refreshBtn" class="refresh-btn" onclick="refreshSelected()" disabled>
    <i class="fas fa-bolt"></i> 
    <span>ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span>
    (<span id="refreshCount">0</span>)
  </button>
</div>

<script>
  // ğŸš¨ Ù…ÙƒØªØ´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
  window.onerror = function(msg, url, line) {
    showNotification(`âš ï¸ Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ: ${msg}`, 'error');
    return false;
  };

  const SUPABASE_URL = 'https://mpcuradmirhcfmwvsylt.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_MJRUl3ON-d61CnFsJ-pFJA_Nbbpg_gZ';

  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©
  if (typeof supabase === 'undefined') {
    showNotification("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Supabase! ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", 'error');
  }

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const PRODUCTS_TABLE = 'products'; 
  const CATEGORIES_TABLE = 'categories'; 

  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  let allProducts = [];
  let filteredProducts = [];
  let refreshFilteredProducts = [];
  let currentPage = 1;
  const productsPerPage = 10;
  let allCategories = [];
  
  // Ù…ØªØºÙŠØ±Ø§Øª Ø®Ø§Øµ Ø¨Ø§Ù„ØªÙ†Ø´ÙŠØ·
  let selectedIds = new Set();
  let refreshSelectedIds = new Set();

  // Ø¹Ù†Ø§ØµØ± DOM
  const elements = {
    loadingOverlay: document.getElementById("loadingOverlay"),
    loadingText: document.getElementById("loadingText"),
    notification: document.getElementById("notification"),
    productsTableBody: document.getElementById("productsTableBody"),
    noProductsMessage: document.getElementById("noProductsMessage"),
    paginationContainer: document.getElementById("paginationContainer"),
    searchInput: document.getElementById("searchInput"),
    categoryFilter: document.getElementById("categoryFilter"),
    statusFilter: document.getElementById("statusFilter"),
    sortBy: document.getElementById("sortBy"),
    totalProducts: document.getElementById("totalProducts"),
    activeProducts: document.getElementById("activeProducts"),
    hiddenProducts: document.getElementById("hiddenProducts"),
    outOfStockProducts: document.getElementById("outOfStockProducts"),
    mobileMenuBtn: document.getElementById("mobileMenuBtn"),
    mobileNav: document.getElementById("mobileNav"),
    managementTab: document.getElementById("managementTab"),
    refreshTab: document.getElementById("refreshTab"),
    batchTab: document.getElementById("batchTab"),
    managementSection: document.getElementById("managementSection"),
    refreshSection: document.getElementById("refreshSection"),
    batchSection: document.getElementById("batchSection"),
    refreshProductsGrid: document.getElementById("refreshProductsGrid"),
    refreshSearchInput: document.getElementById("refreshSearchInput"),
    refreshCategoryFilter: document.getElementById("refreshCategoryFilter"),
    refreshSelectAllText: document.getElementById("refreshSelectAllText"),
    refreshActions: document.getElementById("refreshActions"),
    refreshBtn: document.getElementById("refreshBtn"),
    refreshCount: document.getElementById("refreshCount"),
    selectAllCheckbox: document.getElementById("selectAllCheckbox"),
    noRefreshProductsMessage: document.getElementById("noRefreshProductsMessage"),
    toggleHiddenBtn: document.getElementById("toggleHiddenBtn"),
    toggleOutOfStockBtn: document.getElementById("toggleOutOfStockBtn"),
    deleteSelectedBtn: document.getElementById("deleteSelectedBtn"),
    batchCategorySelect: document.getElementById("batchCategorySelect")
  };

  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  function showNotification(message, type = 'success') {
    elements.notification.textContent = message;
    elements.notification.className = `notification ${type}`;
    elements.notification.style.display = 'block';
    
    setTimeout(() => {
      elements.notification.style.display = 'none';
    }, 4000);
  }

  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  function showLoading(text = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...") {
    elements.loadingText.textContent = text;
    elements.loadingOverlay.style.display = 'flex';
  }

  function hideLoading() {
    elements.loadingOverlay.style.display = 'none';
  }

  // ===========================================
  // ============ Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙƒØ§Ø´ =============
  // ===========================================

  /**
   * ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
   * ØªØ³ØªØ®Ø¯Ù… Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø®ÙÙŠÙ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± timestamp
   * @returns {Promise<boolean>} true Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
   */
  async function checkForNewProducts() {
    try {
      // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù…Ù† localStorage
      const lastUpdate = localStorage.getItem('last_products_update');
      
      // 2. Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø®ÙÙŠÙ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± updated_at Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      const { data, error } = await sb
        .from(PRODUCTS_TABLE)
        .select('updated_at')
        .order('updated_at', { ascending: false })
        .limit(1)
        .single();
      
      if (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', error);
        return false; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
      }
      
      // 3. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ timestamps Ù„Ù„Ø£Ø³Ù‡Ù„ ÙÙŠ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
      const serverTimestamp = data?.updated_at ? new Date(data.updated_at).getTime() : 0;
      const localTimestamp = lastUpdate ? parseInt(lastUpdate) : 0;
      
      // 4. Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
      if (serverTimestamp > localTimestamp) {
        console.log('ğŸ†• ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        return true;
      }
      
      console.log('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©');
      return false;
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ checkForNewProducts:', error);
      return false; // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    }
  }

  /**
   * ØªØ­Ø¯ÙŠØ« timestamp Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« ÙÙŠ localStorage
   */
  function updateLastProductsTimestamp() {
    const now = Date.now();
    localStorage.setItem('last_products_update', now.toString());
    console.log('ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ« timestamp Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', now);
  }

  /**
   * Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
   */
  async function loadAllProductsWithCacheCheck() {
    showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...");
    
    try {
      // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
      const hasNewProducts = await checkForNewProducts();
      
      // 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø£ÙˆÙ„ Ù…Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (hasNewProducts || allProducts.length === 0) {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        const { data: products, error } = await sb
          .from(PRODUCTS_TABLE)
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          throw error;
        }
        
        allProducts = products || [];
        
        // ØªØ­Ø¯ÙŠØ« timestamp ÙÙŠ localStorage
        updateLastProductsTimestamp();
        
        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allProducts.length} Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±`);
        
      } else {
        console.log(`âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ${allProducts.length} Ù…Ù†ØªØ¬ Ù…Ø®Ø²Ù†`);
      }
      
      // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø¹Ø±Ø¶
      updateStatistics();
      filterAndSortProducts();
      
      // 4. ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø´ÙŠØ· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¸Ø§Ù‡Ø±Ù‹Ø§
      if (elements.refreshSection.style.display === 'block') {
        renderRefreshProducts(allProducts);
      }
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", 'error');
      allProducts = [];
      filterAndSortProducts();
    } finally {
      hideLoading();
    }
  }

  /**
   * ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©)
   */
  async function loadAllProducts() {
    showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...");
    
    try {
      const { data: products, error } = await sb
        .from(PRODUCTS_TABLE)
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        throw error;
      }
      
      allProducts = products || [];
      
      // ØªØ­Ø¯ÙŠØ« timestamp ÙÙŠ localStorage
      updateLastProductsTimestamp();
      
      updateStatistics();
      filterAndSortProducts();
      
      if (elements.refreshSection.style.display === 'block') {
        renderRefreshProducts(allProducts);
      }
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", 'error');
      allProducts = [];
      filterAndSortProducts();
    } finally {
      hideLoading();
    }
  }

  // ===========================================
  // ============ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ø­Ø³Ù†Ø© =========
  // ===========================================
  
  // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªÙ†Ø´ÙŠØ· ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
  elements.managementTab.addEventListener('click', () => {
    elements.managementTab.classList.add('active');
    elements.refreshTab.classList.remove('active');
    elements.batchTab.classList.remove('active');
    elements.managementSection.style.display = 'block';
    elements.refreshSection.style.display = 'none';
    elements.batchSection.style.display = 'none';
    elements.refreshActions.style.display = 'none';
    refreshSelectedIds.clear();
    updateRefreshCounter();
  });

  elements.refreshTab.addEventListener('click', () => {
    elements.refreshTab.classList.add('active');
    elements.managementTab.classList.remove('active');
    elements.batchTab.classList.remove('active');
    elements.managementSection.style.display = 'none';
    elements.refreshSection.style.display = 'block';
    elements.batchSection.style.display = 'none';
    elements.refreshActions.style.display = 'flex';
    renderRefreshProducts(allProducts);
  });

  elements.batchTab.addEventListener('click', () => {
    elements.batchTab.classList.add('active');
    elements.managementTab.classList.remove('active');
    elements.refreshTab.classList.remove('active');
    elements.managementSection.style.display = 'none';
    elements.refreshSection.style.display = 'none';
    elements.batchSection.style.display = 'block';
    elements.refreshActions.style.display = 'none';
    refreshSelectedIds.clear();
    updateRefreshCounter();
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  function renderRefreshProducts(products) {
    const grid = elements.refreshProductsGrid;
    const categoryFilter = elements.refreshCategoryFilter.value;
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙ†ÙŠÙ
    refreshFilteredProducts = products.filter(p => {
      const searchQuery = elements.refreshSearchInput.value.toLowerCase().trim();
      const matchesSearch = !searchQuery || 
        (p.name && p.name.toLowerCase().includes(searchQuery));
      const matchesCategory = !categoryFilter || p.category === categoryFilter;
      
      return matchesSearch && matchesCategory;
    });
    
    if (refreshFilteredProducts.length === 0) {
      grid.innerHTML = '';
      elements.noRefreshProductsMessage.style.display = 'block';
      updateRefreshSelectAllText();
      return;
    }
    
    elements.noRefreshProductsMessage.style.display = 'none';
    
    grid.innerHTML = refreshFilteredProducts.map(p => {
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
      let imgUrl = '';
      if (Array.isArray(p.image) && p.image.length > 0) {
        imgUrl = p.image[0];
      } else if (typeof p.image === 'string' && p.image.trim() !== '') {
        imgUrl = p.image;
      }
      
      // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      if (!imgUrl || imgUrl.trim() === '') {
        const colors = ['FF6B6B', '4ECDC4', '45B7D1', '96CEB4', 'FFEAA7'];
        const color = colors[p.id % colors.length];
        const initials = p.name ? p.name.substring(0, 2).toUpperCase() : 'PR';
        imgUrl = `https://via.placeholder.com/150/${color}/FFFFFF?text=${encodeURIComponent(initials)}`;
      }
      
      const isSelected = refreshSelectedIds.has(p.id.toString());
      const isHidden = p.hidden ? ' (Ù…Ø®ÙÙŠ)' : '';
      const isOutOfStock = p.out_of_stock ? ' (Ù…Ù†ØªÙ‡ÙŠ)' : '';
      
      return `
        <div id="refresh-card-${p.id}" class="refresh-product-card ${isSelected ? 'selected' : ''}" 
             onclick="toggleRefreshSelect('${p.id}')" 
             data-id="${p.id}"
             title="${p.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}">
          <div class="refresh-select-badge">
            <i class="fas fa-check"></i>
          </div>
          <img src="${imgUrl}" 
               alt="${p.name || ''}"
               loading="lazy"
               onerror="this.src='https://via.placeholder.com/150/EEE/333?text=ØµÙˆØ±Ø©'">
          <h4>${p.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}${isHidden}${isOutOfStock}</h4>
          ${p.price ? `<div style="color: var(--primary); font-weight: bold; margin-top: 5px; font-size: 14px;">${p.price} Ø±.Ø³</div>` : ''}
          <div style="font-size: 11px; color: #666; margin-top: 5px;">
            ${p.category || 'ØºÙŠØ± Ù…ØµÙ†Ù'}
          </div>
          <div style="font-size: 10px; color: #999; margin-top: 3px;">
            ${formatDate(p.created_at)}
          </div>
        </div>
      `;
    }).join('');
    
    updateRefreshSelectAllText();
  }
  
  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA');
  }
  
  // Ø§Ø®ØªÙŠØ§Ø±/Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  window.toggleRefreshSelect = function(id) {
    const sid = id.toString();
    const card = document.getElementById(`refresh-card-${sid}`);
    
    if (refreshSelectedIds.has(sid)) {
      refreshSelectedIds.delete(sid);
      if (card) {
        card.classList.remove('selected');
      }
    } else {
      refreshSelectedIds.add(sid);
      if (card) {
        card.classList.add('selected');
        // ØªØ£Ø«ÙŠØ± Ù…Ø±Ø¦ÙŠ
        card.style.animation = 'none';
        setTimeout(() => {
          card.style.animation = 'selectPulse 0.3s';
        }, 10);
      }
    }
    
    updateRefreshCounter();
    updateRefreshSelectAllText();
  };
  
  // Ø¥Ù„ØºØ§Ø¡ ÙƒÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ¯Ø§Øª ÙÙŠ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  window.clearRefreshSelection = function() {
    refreshSelectedIds.clear();
    renderRefreshProducts(allProducts);
    updateRefreshCounter();
  };
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  function updateRefreshCounter() {
    const count = refreshSelectedIds.size;
    elements.refreshCount.textContent = count;
    elements.refreshBtn.disabled = (count === 0);
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø±
    const btnText = elements.refreshBtn.querySelector('span');
    if (count === 0) {
      btnText.textContent = 'ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©';
    } else {
      btnText.textContent = `ØªÙ†Ø´ÙŠØ· ${count} Ù…Ù†ØªØ¬${count > 1 ? 'Ø§Øª' : ''}`;
    }
  }
  
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  window.toggleSelectAllRefresh = function() {
    const currentlyVisible = refreshFilteredProducts;
    
    if (currentlyVisible.length === 0) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© Ù…Ø®ØªØ§Ø±Ø©
    const allVisibleSelected = currentlyVisible.every(p => 
      refreshSelectedIds.has(p.id.toString())
    );
    
    if (allVisibleSelected) {
      // Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„
      currentlyVisible.forEach(p => refreshSelectedIds.delete(p.id.toString()));
    } else {
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
      currentlyVisible.forEach(p => refreshSelectedIds.add(p.id.toString()));
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    renderRefreshProducts(allProducts);
    updateRefreshCounter();
  };
  
  // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙÙŠ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  function updateRefreshSelectAllText() {
    const btn = elements.refreshSelectAllText;
    const visibleProducts = refreshFilteredProducts;
    
    if (visibleProducts.length === 0) {
      btn.textContent = 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„';
      return;
    }
    
    const allSelected = visibleProducts.every(p => 
      refreshSelectedIds.has(p.id.toString())
    );
    
    if (allSelected) {
      btn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„';
    } else {
      btn.textContent = 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„';
    }
  }
  
  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  elements.refreshSearchInput.addEventListener('input', function() {
    renderRefreshProducts(allProducts);
  });
  
  // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØµÙ†ÙŠÙ ÙÙŠ Ø§Ù„ØªÙ†Ø´ÙŠØ·
  elements.refreshCategoryFilter.addEventListener('change', function() {
    renderRefreshProducts(allProducts);
  });

  // ===========================================
  // ========= Ø¯Ø§Ù„Ø© ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© =======
  // ===========================================
  
  // ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  async function refreshSelected() {
    const count = refreshSelectedIds.size;
    if (count === 0) return;
    
    // ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    if (!confirm(`Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® ${count} Ù…Ù†ØªØ¬${count > 1 ? 'Ø§Øª' : ''} Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
      return;
    }
    
    showLoading(`Ø¬Ø§Ø±ÙŠ ØªÙ†Ø´ÙŠØ· ${count} Ù…Ù†ØªØ¬${count > 1 ? 'Ø§Øª' : ''}...`);
    
    try {
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
      const now = new Date().toISOString();
      const idsToUpdate = Array.from(refreshSelectedIds);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø¯ÙØ¹Ø§Øª
      const batchSize = 10;
      let successCount = 0;
      let failedCount = 0;
      const failedProducts = [];
      
      for (let i = 0; i < idsToUpdate.length; i += batchSize) {
        const batch = idsToUpdate.slice(i, i + batchSize);
        
        try {
          // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ created_at Ù„Ø¬Ø¹Ù„Ù‡Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
          const { error } = await sb
            .from(PRODUCTS_TABLE)
            .update({ 
              created_at: now,
              updated_at: now // ØªØ­Ø¯ÙŠØ« updated_at Ø£ÙŠØ¶Ø§Ù‹
            })
            .in('id', batch);
          
          if (error) {
            console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹Ø© ${Math.floor(i/batchSize) + 1}:`, error);
            failedCount += batch.length;
            failedProducts.push(...batch);
          } else {
            successCount += batch.length;
          }
          
          // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
          const progress = Math.min(i + batchSize, idsToUpdate.length);
          showLoading(`Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ø´ÙŠØ·... ${progress}/${idsToUpdate.length}`);
          
          // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
          await new Promise(resolve => setTimeout(resolve, 300));
          
        } catch (batchError) {
          console.error(`Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø¯ÙØ¹Ø© ${Math.floor(i/batchSize) + 1}:`, batchError);
          failedCount += batch.length;
          failedProducts.push(...batch);
        }
      }
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      if (successCount > 0) {
        let successMsg = `âœ… ØªÙ… ØªÙ†Ø´ÙŠØ· ${successCount} Ù…Ù†ØªØ¬${successCount > 1 ? 'Ø§Øª' : ''} Ø¨Ù†Ø¬Ø§Ø­!`;
        
        if (failedCount > 0) {
          successMsg += `\nâš ï¸ ÙØ´Ù„ ØªÙ†Ø´ÙŠØ· ${failedCount} Ù…Ù†ØªØ¬${failedCount > 1 ? 'Ø§Øª' : ''}.`;
          console.warn('Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ«Ù‡Ø§:', failedProducts);
        }
        
        showNotification(successMsg, failedCount > 0 ? 'warning' : 'success');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        allProducts.forEach(product => {
          if (refreshSelectedIds.has(product.id.toString())) {
            product.created_at = now;
            product.updated_at = now;
          }
        });
        
      } else {
        throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©');
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      refreshSelectedIds.clear();
      updateRefreshCounter();
      updateRefreshSelectAllText();
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      await loadAllProductsWithCacheCheck();
      
      // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø´ÙŠØ·ØŒ Ø£Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      if (elements.refreshSection.style.display === 'block') {
        renderRefreshProducts(allProducts);
      }
      
    } catch (err) {
      console.error("âŒ ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø´ÙŠØ·:", err);
      showNotification(`ÙØ´Ù„ Ø§Ù„ØªÙ†Ø´ÙŠØ·: ${err.message}`, 'error');
    } finally {
      setTimeout(() => hideLoading(), 1000);
    }
  }

  // ===========================================
  // ============ Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø´ÙŠØ· ============
  // ===========================================

  // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
  async function loadCategories() {
    try {
      const { data: categories, error } = await sb
        .from(CATEGORIES_TABLE)
        .select('name')
        .order('name');
      
      if (categories && categories.length > 0) {
        allCategories = categories.map(cat => cat.name);
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±
        const categorySelectors = [
          elements.categoryFilter,
          elements.refreshCategoryFilter,
          elements.batchCategorySelect
        ];
        
        categorySelectors.forEach(selector => {
          if (selector) {
            selector.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>';
            allCategories.forEach(category => {
              selector.add(new Option(category, category));
            });
          }
        });
      }
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª:", error);
    }
  }

  // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  function updateStatistics() {
    const total = allProducts.length;
    const hidden = allProducts.filter(p => p.hidden).length;
    const outOfStock = allProducts.filter(p => p.out_of_stock).length;
    const active = total - hidden;
    
    elements.totalProducts.textContent = total;
    elements.hiddenProducts.textContent = hidden;
    elements.outOfStockProducts.textContent = outOfStock;
    elements.activeProducts.textContent = active;
  }

  // Ø¯Ø§Ù„Ø© Ù„ÙÙ„ØªØ±Ø© ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  function filterAndSortProducts() {
    const searchTerm = elements.searchInput.value.toLowerCase();
    const categoryFilter = elements.categoryFilter.value;
    const statusFilter = elements.statusFilter.value;
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    filteredProducts = allProducts.filter(product => {
      // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙˆØµÙ
      const matchesSearch = !searchTerm || 
        (product.name && product.name.toLowerCase().includes(searchTerm)) ||
        (product.description && product.description.toLowerCase().includes(searchTerm));
      
      // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØµÙ†ÙŠÙ
      const matchesCategory = !categoryFilter || product.category === categoryFilter;
      
      // ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø©
      let matchesStatus = true;
      if (statusFilter === 'active') {
        matchesStatus = !product.hidden && !product.out_of_stock;
      } else if (statusFilter === 'hidden') {
        matchesStatus = product.hidden === true;
      } else if (statusFilter === 'out_of_stock') {
        matchesStatus = product.out_of_stock === true;
      }
      
      return matchesSearch && matchesCategory && matchesStatus;
    });
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    const sortBy = elements.sortBy.value;
    filteredProducts.sort((a, b) => {
      switch (sortBy) {
        case 'created_at_desc':
          return new Date(b.created_at || 0) - new Date(a.created_at || 0);
        case 'created_at_asc':
          return new Date(a.created_at || 0) - new Date(b.created_at || 0);
        case 'name_asc':
          return (a.name || '').localeCompare(b.name || '');
        case 'name_desc':
          return (b.name || '').localeCompare(a.name || '');
        case 'price_asc':
          return (a.price || 0) - (b.price || 0);
        case 'price_desc':
          return (b.price || 0) - (a.price || 0);
        default:
          return 0;
      }
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    currentPage = 1;
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    displayProducts();
    updatePagination();
  }

  // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  function displayProducts() {
    elements.productsTableBody.innerHTML = '';
    
    if (filteredProducts.length === 0) {
      elements.noProductsMessage.style.display = 'block';
      elements.productsTableBody.style.display = 'none';
      elements.paginationContainer.style.display = 'none';
      return;
    }
    
    elements.noProductsMessage.style.display = 'none';
    elements.productsTableBody.style.display = 'table-row-group';
    elements.paginationContainer.style.display = 'flex';
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const startIndex = (currentPage - 1) * productsPerPage;
    const endIndex = startIndex + productsPerPage;
    const currentProducts = filteredProducts.slice(startIndex, endIndex);
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    currentProducts.forEach((product, index) => {
      const row = document.createElement('tr');
      
      // Ø§Ù„ØµÙˆØ±Ø©
      const imageUrl = product.image && product.image.length > 0 ? 
        product.image[0] : 'https://via.placeholder.com/50';
      
      // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬
      let statusText = '';
      let statusClass = '';
      
      if (product.hidden) {
        statusText = 'Ù…Ø®ÙÙŠ';
        statusClass = 'status-hidden';
      } else if (product.out_of_stock) {
        statusText = 'Ù…Ù†ØªÙ‡ÙŠ';
        statusClass = 'status-out-of-stock';
      } else {
        statusText = 'Ù†Ø´Ø·';
        statusClass = 'status-active';
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„ØµÙ
      row.innerHTML = `
        <td>
          <input type="checkbox" class="product-select" data-id="${product.id}"
                 onchange="toggleProductSelection('${product.id}', this.checked)"
                 ${selectedIds.has(product.id.toString()) ? 'checked' : ''}>
        </td>
        <td class="product-image-cell">
          <img src="${imageUrl}" alt="${product.name || ''}" class="product-image" 
               onerror="this.src='https://via.placeholder.com/50?text=ØµÙˆØ±Ø©'">
        </td>
        <td>
          <div class="product-name">${product.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
          <div style="font-size: 11px; color: #666; margin-top: 3px;">
            ${product.description ? product.description.substring(0, 40) + '...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}
          </div>
        </td>
        <td class="product-price">${product.price ? product.price.toLocaleString() + ' Ø±ÙŠØ§Ù„' : '0 Ø±ÙŠØ§Ù„'}</td>
        <td>
          <span class="product-category">${product.category || 'ØºÙŠØ± Ù…ØµÙ†Ù'}</span>
        </td>
        <td>
          <span class="status-badge ${statusClass}">${statusText}</span>
        </td>
        <td>
          <label class="toggle-switch">
            <input type="checkbox" 
                   ${product.hidden ? 'checked' : ''}
                   data-id="${product.id}"
                   onchange="toggleProductHidden('${product.id}', this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </td>
        <td>
          <label class="toggle-switch">
            <input type="checkbox" 
                   ${product.out_of_stock ? 'checked' : ''}
                   data-id="${product.id}"
                   onchange="toggleProductOutOfStock('${product.id}', this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="editProduct('${product.id}')" title="ØªØ¹Ø¯ÙŠÙ„">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')" title="Ø­Ø°Ù">
            <i class="fas fa-trash"></i>
          </button>
          <button class="btn btn-success btn-sm" onclick="refreshSingleProduct('${product.id}')" title="ØªÙ†Ø´ÙŠØ·">
            <i class="fas fa-bolt"></i>
          </button>
        </td>
      `;
      
      elements.productsTableBody.appendChild(row);
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
    updateSelectAllCheckbox();
  }

  // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª
  function updatePagination() {
    elements.paginationContainer.innerHTML = '';
    
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    
    if (totalPages <= 1) {
      elements.paginationContainer.style.display = 'none';
      return;
    }
    
    elements.paginationContainer.style.display = 'flex';
    
    // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (currentPage > 1) {
      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-btn';
      prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      prevBtn.onclick = () => {
        currentPage--;
        displayProducts();
        updatePagination();
      };
      elements.paginationContainer.appendChild(prevBtn);
    }
    
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => {
        currentPage = i;
        displayProducts();
        updatePagination();
      };
      elements.paginationContainer.appendChild(pageBtn);
    }
    
    // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
    if (currentPage < totalPages) {
      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-btn';
      nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      nextBtn.onclick = () => {
        currentPage++;
        displayProducts();
        updatePagination();
      };
      elements.paginationContainer.appendChild(nextBtn);
    }
  }

  // ===========================================
  // ============ Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ============
  // ===========================================

  // âœ… Ø§Ø®ØªÙŠØ§Ø±/Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  window.toggleProductSelection = function(productId, isSelected) {
    if (isSelected) {
      selectedIds.add(productId.toString());
    } else {
      selectedIds.delete(productId.toString());
    }
    updateSelectAllCheckbox();
  };

  // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  window.selectAllInManagement = function() {
    const checkboxes = document.querySelectorAll('.product-select');
    const allSelected = Array.from(checkboxes).every(cb => cb.checked);
    
    if (allSelected) {
      // Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
      checkboxes.forEach(cb => {
        cb.checked = false;
        selectedIds.delete(cb.dataset.id);
      });
      elements.selectAllCheckbox.checked = false;
    } else {
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
      checkboxes.forEach(cb => {
        cb.checked = true;
        selectedIds.add(cb.dataset.id);
      });
      elements.selectAllCheckbox.checked = true;
    }
  };

  // âœ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
  function updateSelectAllCheckbox() {
    const checkboxes = document.querySelectorAll('.product-select');
    const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
    elements.selectAllCheckbox.checked = allChecked;
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø±
    const btnText = document.getElementById('selectAllText');
    if (allChecked) {
      btnText.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„';
    } else {
      btnText.textContent = 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
    const hasSelection = selectedIds.size > 0;
    elements.toggleHiddenBtn.disabled = !hasSelection;
    elements.toggleOutOfStockBtn.disabled = !hasSelection;
    elements.deleteSelectedBtn.disabled = !hasSelection;
  }

  // âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  elements.selectAllCheckbox.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.product-select');
    
    if (this.checked) {
      checkboxes.forEach(cb => {
        cb.checked = true;
        selectedIds.add(cb.dataset.id);
      });
    } else {
      checkboxes.forEach(cb => {
        cb.checked = false;
        selectedIds.delete(cb.dataset.id);
      });
    }
    
    updateSelectAllCheckbox();
  });

  // âœ… ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬
  async function toggleProductHidden(productId, isHidden) {
    try {
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .update({ hidden: isHidden })
        .eq('id', productId);
      
      if (error) throw error;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      const productIndex = allProducts.findIndex(p => p.id === productId);
      if (productIndex !== -1) {
        allProducts[productIndex].hidden = isHidden;
      }
      
      updateStatistics();
      filterAndSortProducts();
      
      showNotification(`ØªÙ… ${isHidden ? 'Ø¥Ø®ÙØ§Ø¡' : 'Ø¥Ø¸Ù‡Ø§Ø±'} Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø®ÙØ§Ø¡:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬", 'error');
    }
  }

  // âœ… ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙƒÙ…ÙŠØ©
  async function toggleProductOutOfStock(productId, isOutOfStock) {
    try {
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .update({ out_of_stock: isOutOfStock })
        .eq('id', productId);
      
      if (error) throw error;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      const productIndex = allProducts.findIndex(p => p.id === productId);
      if (productIndex !== -1) {
        allProducts[productIndex].out_of_stock = isOutOfStock;
      }
      
      updateStatistics();
      filterAndSortProducts();
      
      showNotification(`ØªÙ… ${isOutOfStock ? 'ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Ø¥Ù„ØºØ§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙƒÙ…ÙŠØ©'} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙƒÙ…ÙŠØ©:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬", 'error');
    }
  }

  // âœ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
  function editProduct(productId) {
    window.location.href = `edit_product.html?id=${productId}`;
  }

  // âœ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬
  async function deleteProduct(productId) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
      return;
    }
    
    showLoading("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬...");
    
    try {
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .delete()
        .eq('id', productId);
      
      if (error) throw error;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      allProducts = allProducts.filter(p => p.id !== productId);
      
      updateStatistics();
      filterAndSortProducts();
      
      showNotification("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­", 'success');
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬", 'error');
    } finally {
      hideLoading();
    }
  }

  // ===========================================
  // ============ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© ==============
  // ===========================================

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  async function toggleHiddenForSelected() {
    if (selectedIds.size === 0) {
      showNotification("âš ï¸ Ù„Ù… ØªØ®ØªØ± Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª", 'warning');
      return;
    }
    
    const action = confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø®ÙØ§Ø¡ ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''}ØŸ`);
    if (!action) return;
    
    showLoading(`Ø¬Ø§Ø±ÙŠ Ø¥Ø®ÙØ§Ø¡ ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''}...`);
    
    try {
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .update({ hidden: true })
        .in('id', Array.from(selectedIds));
      
      if (error) throw error;
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
      allProducts.forEach(p => {
        if (selectedIds.has(p.id.toString())) {
          p.hidden = true;
        }
      });
      
      selectedIds.clear();
      updateStatistics();
      filterAndSortProducts();
      showNotification(`ØªÙ… Ø¥Ø®ÙØ§Ø¡ ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", 'error');
    } finally {
      hideLoading();
    }
  }

  // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  async function toggleOutOfStockForSelected() {
    if (selectedIds.size === 0) {
      showNotification("âš ï¸ Ù„Ù… ØªØ®ØªØ± Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª", 'warning');
      return;
    }
    
    const action = confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''} ÙƒÙ…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ÙƒÙ…ÙŠØ©ØŸ`);
    if (!action) return;
    
    showLoading(`Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''}...`);
    
    try {
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .update({ out_of_stock: true })
        .in('id', Array.from(selectedIds));
      
      if (error) throw error;
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
      allProducts.forEach(p => {
        if (selectedIds.has(p.id.toString())) {
          p.out_of_stock = true;
        }
      });
      
      selectedIds.clear();
      updateStatistics();
      filterAndSortProducts();
      showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", 'error');
    } finally {
      hideLoading();
    }
  }

  // Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  async function deleteSelectedProducts() {
    if (selectedIds.size === 0) {
      showNotification("âš ï¸ Ù„Ù… ØªØ®ØªØ± Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª", 'warning');
      return;
    }
    
    if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''}ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
      return;
    }
    
    showLoading(`Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''}...`);
    
    try {
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .delete()
        .in('id', Array.from(selectedIds));
      
      if (error) throw error;
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
      allProducts = allProducts.filter(p => !selectedIds.has(p.id.toString()));
      
      selectedIds.clear();
      updateStatistics();
      filterAndSortProducts();
      showNotification(`ØªÙ… Ø­Ø°Ù ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", 'error');
    } finally {
      hideLoading();
    }
  }

  // ===========================================
  // ============ Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© ==================
  // ===========================================

  // ØªÙ†Ø´ÙŠØ· Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯
  async function refreshSingleProduct(productId) {
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙ†Ø´ÙŠØ· Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©ØŸ")) {
      return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬...');
    
    try {
      const now = new Date().toISOString();
      
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .update({ 
          created_at: now,
          updated_at: now 
        })
        .eq('id', productId);
      
      if (error) throw error;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø­Ù„ÙŠØ§Ù‹
      const productIndex = allProducts.findIndex(p => p.id === productId);
      if (productIndex !== -1) {
        allProducts[productIndex].created_at = now;
        allProducts[productIndex].updated_at = now;
      }
      
      showNotification('âœ… ØªÙ… ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
      filterAndSortProducts();
      
    } catch (error) {
      console.error('ÙØ´Ù„ ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬:', error);
      showNotification('âŒ ÙØ´Ù„ ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ù†ØªØ¬', 'error');
    } finally {
      hideLoading();
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  async function updateCategoryForSelected() {
    const newCategory = elements.batchCategorySelect.value;
    if (!newCategory) {
      showNotification("âš ï¸ Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹", 'warning');
      return;
    }
    
    if (selectedIds.size === 0) {
      showNotification("âš ï¸ Ù„Ù… ØªØ®ØªØ± Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª", 'warning');
      return;
    }
    
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± ØªØµÙ†ÙŠÙ ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''} Ø¥Ù„Ù‰ "${newCategory}"ØŸ`)) {
      return;
    }
    
    showLoading(`Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ...`);
    
    try {
      const { error } = await sb
        .from(PRODUCTS_TABLE)
        .update({ category: newCategory })
        .in('id', Array.from(selectedIds));
      
      if (error) throw error;
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
      allProducts.forEach(p => {
        if (selectedIds.has(p.id.toString())) {
          p.category = newCategory;
        }
      });
      
      showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØµÙ†ÙŠÙ ${selectedIds.size} Ù…Ù†ØªØ¬${selectedIds.size > 1 ? 'Ø§Øª' : ''} Ø¨Ù†Ø¬Ø§Ø­`, 'success');
      filterAndSortProducts();
      
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ:", error);
      showNotification("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ", 'error');
    } finally {
      hideLoading();
    }
  }

  // ===========================================
  // ============ Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ============
  // ===========================================

  // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙÙ„Ø§ØªØ±
  elements.searchInput.addEventListener('input', () => {
    filterAndSortProducts();
  });

  elements.categoryFilter.addEventListener('change', () => {
    filterAndSortProducts();
  });

  elements.statusFilter.addEventListener('change', () => {
    filterAndSortProducts();
  });

  elements.sortBy.addEventListener('change', () => {
    filterAndSortProducts();
  });

  // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ
  elements.mobileMenuBtn.addEventListener('click', () => {
    elements.mobileNav.classList.toggle('show');
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener('click', (e) => {
    if (!elements.mobileNav.contains(e.target) && !elements.mobileMenuBtn.contains(e.target)) {
      elements.mobileNav.classList.remove('show');
    }
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  document.addEventListener('DOMContentLoaded', async () => {
    await loadCategories();
    await loadAllProductsWithCacheCheck(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
  });

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ HTML
  window.toggleProductHidden = toggleProductHidden;
  window.toggleProductOutOfStock = toggleProductOutOfStock;
  window.editProduct = editProduct;
  window.deleteProduct = deleteProduct;
  window.toggleProductSelection = toggleProductSelection;
  window.selectAllInManagement = selectAllInManagement;
  window.toggleRefreshSelect = toggleRefreshSelect;
  window.toggleSelectAllRefresh = toggleSelectAllRefresh;
  window.clearRefreshSelection = clearRefreshSelection;
  window.refreshSelected = refreshSelected;
  window.refreshSingleProduct = refreshSingleProduct;
  window.toggleHiddenForSelected = toggleHiddenForSelected;
  window.toggleOutOfStockForSelected = toggleOutOfStockForSelected;
  window.deleteSelectedProducts = deleteSelectedProducts;
  window.updateCategoryForSelected = updateCategoryForSelected;

</script>

<style>
  /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø© */
  .batch-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .batch-option {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #eaeaea;
  }
  
  .batch-option h3 {
    color: var(--primary);
    margin-top: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .batch-option p {
    color: #666;
    margin-bottom: 15px;
    font-size: 14px;
  }
  
  .batch-action {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  @media (max-width: 768px) {
    .batch-options {
      grid-template-columns: 1fr;
    }
  }
</style>

</body>
</html>