<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة منتجات ابن المختار</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --main-color: #001F3F;      /* كحلي */
            --secondary-color: #FF8C00; /* برتقالي */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --primary: #c6a047;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-color); padding-top: 140px; }

        /* --- الهيدر (مطابق لأسلوب الصفحة الرئيسية) --- */
        header { position: fixed; top: 0; left: 0; right: 0; background: var(--main-color); z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .top-nav { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .search-area { height: 60px; background: rgba(255,255,255,0.05); display: flex; align-items: center; padding: 0 20px; }
        
        .logo { color: white; font-weight: 800; font-size: 20px; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .logo i { background: var(--secondary-color); padding: 8px; border-radius: 8px; color: white; }
        
        .search-wrapper { position: relative; width: 100%; max-width: 500px; margin: 0 auto; }
        .search-wrapper input { width: 100%; padding: 10px 40px 10px 15px; border-radius: 25px; border: none; outline: none; font-family: 'Tajawal'; }
        .search-wrapper i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--secondary-color); }

        /* --- شبكة المنتجات --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        
        .card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; display: flex; flex-direction: column; transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        
        .img-box { height: 220px; background: #eee; overflow: hidden; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        .edit-tag { position: absolute; top: 10px; left: 10px; background: var(--main-color); color: white; padding: 5px 12px; border-radius: 6px; font-size: 12px; text-decoration: none; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .info { padding: 15px; flex-grow: 1; }
        .title { font-size: 16px; font-weight: 700; margin-bottom: 8px; color: var(--main-color); height: 40px; overflow: hidden; }
        
        .price-box { display: flex; align-items: baseline; gap: 4px; margin-bottom: 10px; }
        .price-val { font-size: 18px; font-weight: 800; color: var(--secondary-color); }
        .price-hint { font-size: 11px; color: #777; }
        
        .size-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .size-tag { font-size: 10px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd; color: #555; }

        .footer { padding: 10px 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; font-size: 11px; font-weight: 600; color: #888; }
        
        .load-more { background: var(--secondary-color); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; margin: 30px auto; display: block; font-weight: 700; }
        .load-more:disabled { background: #ccc; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
    <div class="top-nav">
        <a href="#" class="logo"><i class="fas fa-store"></i> ابن المختار</a>
        <a href="product.html" style="color: white; text-decoration: none; background: var(--secondary-color); padding: 8px 18px; border-radius: 20px; font-size: 13px; font-weight: 700;">+ إضافة منتج</a>
    </div>
    <div class="search-area">
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="ابحث باسم المنتج أو التصنيف...">
        </div>
    </div>
</header>

<div class="container">
    <div class="grid" id="productGrid">
        </div>
    <button class="load-more" id="loadBtn" disabled>عرض المزيد</button>
</div>

<script type="module">
    // --- بيانات الربط (مستخرجة من الكود الخاص بك) ---
    const SUPABASE_URL = 'https://mpcuradmirhcfmwvsylt.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_MJRUl3ON-d61CnFsJ-pFJA_Nbbpg_gZ';
    const STORAGE_BASE = 'https://mpcuradmirhcfmwvsylt.supabase.co/storage/v1/object/public/products/';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let page = 0;
    const PAGE_SIZE = 12;
    let queryText = "";

    // ✅ دالة معالجة رابط الصورة (نفس منطق الصفحة الرئيسية)
    function getProductImageUrl(imagePath) {
        if (!imagePath) return "https://via.placeholder.com/300?text=No+Image";
        
        // إذا كان الرابط بالفعل رابط كامل
        if (typeof imagePath === 'string' && imagePath.startsWith('http')) {
            return imagePath;
        }
        
        // إذا كان مصفوفة، خذ العنصر الأول
        if (Array.isArray(imagePath) && imagePath.length > 0) {
            imagePath = imagePath[0];
            if (typeof imagePath === 'string' && imagePath.startsWith('http')) return imagePath;
        }
        
        // تنظيف المسار ودمجه مع رابط الـ Storage
        const cleanPath = String(imagePath).replace(/^\//, '').replace(/[\[\]" ]/g, "");
        return STORAGE_BASE + cleanPath;
    }

    // ✅ دالة بناء بطاقة المنتج مع منطق المقاسات والأسعار
    function createCard(p) {
        let finalPrice = p.price;
        let priceHint = "";
        let sizesHtml = "";

        // 1. فحص المقاسات والأسعار (JSONB)
        if (p.sizes && Array.isArray(p.sizes) && p.sizes.length > 0) {
            const prices = p.sizes.map(s => parseFloat(s.price)).filter(n => !isNaN(n));
            if (prices.length > 0) {
                finalPrice = Math.min(...prices); // أقل سعر متاح
                priceHint = '<span class="price-hint">يبدأ من:</span>';
            }
            sizesHtml = `<div class="size-tags">${p.sizes.map(s => `<span class="size-tag">${s.name}</span>`).join('')}</div>`;
        }

        // 2. معالجة الصورة باستخدام المنطق الجديد
        const finalImgUrl = getProductImageUrl(p.image);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="img-box">
                <a href="edit_Product.html?id=${p.id}" class="edit-tag"><i class="fas fa-edit"></i> تعديل</a>
                <img src="${finalImgUrl}" 
                     alt="${p.name}" 
                     loading="lazy" 
                     onerror="this.src='https://via.placeholder.com/300?text=Error'">
            </div>
            <div class="info">
                <div class="title">${p.name || 'بدون اسم'}</div>
                <div class="price-box">
                    ${priceHint}
                    <div class="price-val">${parseInt(finalPrice || 0).toLocaleString()} ر.ي</div>
                </div>
                ${sizesHtml}
            </div>
            <div class="footer">
                <span>${p.category || 'عام'}</span>
                <span>ID: ${p.id}</span>
            </div>
        `;
        return card;
    }

    // ✅ دالة جلب البيانات (أداء عالٍ واقتصادي)
    async function fetchProducts(isNew = false) {
        if (isNew) { page = 0; document.getElementById('productGrid').innerHTML = ''; }
        
        document.getElementById('loadBtn').disabled = true;
        const from = page * PAGE_SIZE;
        const to = from + PAGE_SIZE - 1;

        // جلب البيانات الضرورية فقط لتقليل Egress
        let baseQuery = sb.from('products').select('id, name, price, image, sizes, category', { count: 'exact' });

        if (queryText) {
            baseQuery = baseQuery.or(`name.ilike.%${queryText}%,category.ilike.%${queryText}%`);
        }

        const { data, count, error } = await baseQuery.range(from, to).order('created_at', { ascending: false });

        if (data) {
            data.forEach(p => document.getElementById('productGrid').appendChild(createCard(p)));
            page++;
            document.getElementById('loadBtn').disabled = (count <= page * PAGE_SIZE);
            if (data.length === 0 && isNew) {
                document.getElementById('productGrid').innerHTML = '<p style="text-align:center; padding:50px; width:100%;">لا توجد نتائج.</p>';
            }
        }
    }

    // ✅ البحث الفوري (Debounced)
    let timer;
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            queryText = e.target.value;
            fetchProducts(true);
        }, 400);
    });

    document.getElementById('loadBtn').addEventListener('click', () => fetchProducts(false));

    // التحميل الأولي
    fetchProducts(true);
</script>

</body>
</html>
