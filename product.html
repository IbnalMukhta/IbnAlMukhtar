<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title id="pageTitle">Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --main-color: #001F3F;
            --secondary-color: #FF8C00;
            --sar-color: #28a745;
            --bg-color: #f8f9fa;
            --radius: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg-color); color: var(--main-color); padding-bottom: 120px; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }

        .top-actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        @keyframes glowing {
            0% { box-shadow: 0 0 5px rgba(255, 140, 0, 0.4); }
            50% { box-shadow: 0 0 20px rgba(255, 140, 0, 0.6); }
            100% { box-shadow: 0 0 5px rgba(255, 140, 0, 0.4); }
        }
        
        .back-btn-glow {
            text-decoration: none; background: var(--main-color); color: #fff;
            padding: 10px 20px; border-radius: 50px; display: inline-flex; align-items: center; gap: 8px;
            font-weight: 700; border: 1px solid var(--secondary-color);
            animation: glowing 2s infinite; font-size: 14px;
        }

        .top-share-btn {
            background: #fff; color: var(--main-color); border: 1px solid #ddd;
            width: 42px; height: 42px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer;
        }

        .gallery-wrapper { background: #fff; border-radius: var(--radius); padding: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .main-image-container { width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 15px; background: #fdfdfd; }
        .main-image-container img { width: 100%; height: 100%; object-fit: contain; transition: opacity 0.3s ease; }
        .thumbnails-grid { display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .thumbnails-grid::-webkit-scrollbar { display: none; }
        .thumb-item { width: 65px; height: 65px; flex-shrink: 0; border-radius: 10px; cursor: pointer; border: 2px solid transparent; overflow: hidden; background: #eee; transition: transform 0.2s ease, border-color 0.2s ease; }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; }
        .thumb-item.active { border-color: var(--secondary-color); transform: scale(1.05); }
        .thumb-item:hover { transform: scale(1.05); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .main-image-container img.loaded { animation: fadeIn 0.3s ease; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .price-container { display: flex; align-items: center; gap: 15px; margin-top: 10px; flex-wrap: wrap; }
        .price-box { display: flex; flex-direction: column; }
        .price-now { font-size: 28px; font-weight: 800; color: var(--secondary-color); line-height: 1; }
        .price-sar { font-size: 20px; font-weight: 700; color: var(--sar-color); line-height: 1; }
        .currency-label { font-size: 12px; font-weight: 700; color: #777; margin-top: 4px; }
        .divider { width: 2px; height: 35px; background: #eee; }

        .info-card { background: #fff; padding: 25px; border-radius: var(--radius); margin-bottom: 15px; box-shadow: 0 3px 15px rgba(0,0,0,0.03); }
        .product-title { font-size: 22px; font-weight: 800; margin-bottom: 5px; }
        .size-btn { flex: 1; min-width: 100px; padding: 12px; border: 2px solid #f0f0f0; border-radius: 12px; text-align: center; cursor: pointer; margin: 5px; font-size: 13px; transition: all 0.3s ease; }
        .size-btn.active { border-color: var(--secondary-color); background: #fff9f2; color: var(--secondary-color); font-weight: 700; }
        .size-btn:hover { border-color: var(--secondary-color); }

        .footer-actions {
            position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px; display: flex; gap: 10px; box-shadow: 0 -10px 30px rgba(0,0,0,0.08); z-index: 1000;
            backdrop-filter: blur(10px);
        }
        .add-btn { 
            flex: 2; background: var(--main-color); color: #fff; border: none; border-radius: 15px; 
            font-weight: 800; height: 55px; font-size: 17px; cursor: pointer; transition: all 0.3s ease;
        }
        .add-btn:hover { background: #002a5c; transform: translateY(-2px); }
        .wa-btn { 
            flex: 1; background: #25D366; color: #fff; border: none; border-radius: 15px; 
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            gap: 8px; font-weight: 700; transition: all 0.3s ease;
        }
        .wa-btn:hover { background: #1da851; transform: translateY(-2px); }

        @keyframes slideIn { from { top: -100px; opacity: 0; } to { top: 20px; opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>

<div class="container">
    <div class="top-actions-bar">
        <a href="index.html" class="back-btn-glow">
            <i class="fas fa-th-large"></i> Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        </a>
        <button class="top-share-btn" onclick="shareProduct()" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬">
            <i class="fas fa-share-alt"></i>
        </button>
    </div>

    <div id="productContent">
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØªØ­Ù…Ù„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
    </div>
</div>

<div class="footer-actions">
    <button class="add-btn" onclick="addToCart()">ğŸ›’ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
    <button class="wa-btn" onclick="sendWhatsApp()">
        <i class="fab fa-whatsapp"></i> <span style="font-size: 15px;">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</span>
    </button>
</div>

<script>
    const SUPABASE_URL = 'https://mpcuradmirhcfmwvsylt.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_MJRUl3ON-d61CnFsJ-pFJA_Nbbpg_gZ';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const SAR_RATE = 140;

    let productData = null;
    let selectedSize = null;

    // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Storage Ù…Ø¨Ø§Ø´Ø±
    function getProductImageUrl(imagePath) {
        if (!imagePath) return null;
        
        if (typeof imagePath === 'string' && imagePath.startsWith('http')) {
            return imagePath;
        }
        
        if (Array.isArray(imagePath) && imagePath.length > 0) {
            const firstImage = imagePath[0];
            if (firstImage && typeof firstImage === 'string' && firstImage.startsWith('http')) {
                return firstImage;
            }
            imagePath = firstImage;
        }
        
        const baseUrl = 'https://mpcuradmirhcfmwvsylt.supabase.co/storage/v1/object/public';
        const pathStr = String(imagePath);
        const cleanPath = pathStr.replace(/^\//, '');
        
        return `${baseUrl}/products/${cleanPath}`;
    }

    // âœ… SVG Placeholder
    function getPlaceholderSVG() {
        return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f8f9fa'/%3E%3Ctext x='50' y='55' font-family='Tajawal' font-size='14' text-anchor='middle' fill='%23999'%3EğŸ–¼ï¸%3C/text%3E%3C/svg%3E";
    }

    // âœ… Ù‡ÙŠÙƒÙ„ Ø¹Ø¸Ù…ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    function showGallerySkeleton() {
        document.getElementById('productContent').innerHTML = `
            <div class="gallery-wrapper">
                <div class="main-image-container">
                    <div style="width:100%; height:100%; background:#f0f0f0; border-radius:15px; display:flex; align-items:center; justify-content:center;">
                        <div style="width:50px; height:50px; border:3px solid #ddd; border-top-color:var(--secondary-color); border-radius:50%; animation:spin 1s linear infinite;"></div>
                    </div>
                </div>
                <div class="thumbnails-grid" style="justify-content:center; gap:10px;">
                    ${Array.from({length: 3}).map(() => `
                        <div style="width:65px; height:65px; background:#f0f0f0; border-radius:10px; flex-shrink:0;"></div>
                    `).join('')}
                </div>
            </div>
            
            <div class="info-card">
                <div style="height:30px; background:#f0f0f0; border-radius:8px; margin-bottom:15px; width:80%;"></div>
                <div style="height:20px; background:#f0f0f0; border-radius:8px; margin-bottom:10px; width:60%;"></div>
                <div style="height:20px; background:#f0f0f0; border-radius:8px; width:40%;"></div>
            </div>
        `;
    }

    // âœ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    function changeMainImg(thumbElement, imgUrl) {
        document.querySelectorAll('.thumb-item').forEach(item => {
            item.classList.remove('active');
        });
        
        thumbElement.classList.add('active');
        
        const mainImg = document.getElementById('mainImg');
        mainImg.style.opacity = '0';
        
        setTimeout(() => {
            mainImg.src = imgUrl;
            mainImg.style.opacity = '1';
        }, 200);
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    function updatePricesUI(yerPrice) {
        const yer = Number(yerPrice);
        const sar = Math.ceil(yer / SAR_RATE); 

        document.getElementById('priceYER').innerText = yer.toLocaleString('en-US');
        document.getElementById('priceSAR').innerText = sar.toLocaleString('en-US');
    }

    // âœ… Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
    function showErrorMessage(message) {
        document.getElementById('productContent').innerHTML = `
            <div style="text-align:center; padding:50px 20px;">
                <div style="font-size:60px; color:#ccc; margin-bottom:20px;">ğŸ˜”</div>
                <h3 style="color:#666; margin-bottom:10px;">${message}</h3>
                <a href="index.html" style="display:inline-block; background:var(--main-color); color:white; padding:12px 24px; border-radius:12px; text-decoration:none; font-weight:700; margin-top:20px;">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
                </a>
            </div>
        `;
    }

    // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬
    function renderProduct() {
        document.title = `Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± - ${productData.name}`;
        
        let imgs = [];
        
        if (Array.isArray(productData.image)) {
            imgs = productData.image.map(img => {
                const fullUrl = getProductImageUrl(img);
                return fullUrl ? fullUrl : getPlaceholderSVG(); // âœ… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† optimize
            });
        } else if (productData.image) {
            const fullUrl = getProductImageUrl(productData.image);
            imgs = [fullUrl ? fullUrl : getPlaceholderSVG()]; // âœ… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† optimize
        } else {
            imgs = [getPlaceholderSVG()];
        }
        
        document.getElementById('productContent').innerHTML = `
            <div class="gallery-wrapper">
                <div class="main-image-container">
                    <img id="mainImg" src="${imgs[0]}" alt="${productData.name}" 
                         onerror="this.src='${getPlaceholderSVG()}'; this.style.opacity='1';"
                         style="opacity: 0;">
                </div>
                <div class="thumbnails-grid" id="thumbGrid">
                    ${imgs.map((img, i) => `
                        <div class="thumb-item ${i === 0 ? 'active' : ''}" 
                             onclick="changeMainImg(this, '${img}')">
                            <img src="${img}" alt="${productData.name} - ØµÙˆØ±Ø© ${i + 1}"
                                 loading="lazy"
                                 onerror="this.src='${getPlaceholderSVG()}'">
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="info-card">
                <h1 class="product-title" id="title">${productData.name}</h1>
                
                <div class="price-container">
                    <div class="price-box">
                        <span class="price-now" id="priceYER">0</span>
                        <span class="currency-label">Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ</span>
                    </div>
                    <div class="divider"></div>
                    <div class="price-box">
                        <span class="price-sar" id="priceSAR">0</span>
                        <span class="currency-label">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</span>
                    </div>
                </div>
                
                <div id="sizesSection" style="display:none; margin-top:20px;">
                    <span style="font-weight:800; display:block; margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³:</span>
                    <div style="display:flex; flex-wrap:wrap;" id="sizesList"></div>
                </div>
            </div>

            <div class="info-card">
                <span style="font-weight:800; display:block; margin-bottom:10px;">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬:</span>
                <div id="description" style="line-height:1.7; color:#555; white-space:pre-line;">${productData.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªÙˆÙØ±"}</div>
            </div>
        `;
        
        updatePricesUI(productData.price);
        
        const mainImg = document.getElementById('mainImg');
        mainImg.onload = function() {
            this.style.opacity = '1';
            this.classList.add('loaded');
        };
        
        let sizes = [];
        try { 
            sizes = typeof productData.sizes === 'string' ? 
                JSON.parse(productData.sizes) : 
                (productData.sizes || []); 
        } catch(e) {
            console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:', e);
            sizes = [];
        }
        
        if (sizes && sizes.length > 0) {
            document.getElementById('sizesSection').style.display = 'block';
            document.getElementById('sizesList').innerHTML = sizes.map((s, i) => `
                <div class="size-btn ${i === 0 ? 'active' : ''}" 
                     id="s-${i}" 
                     onclick="selectSize(${i}, ${JSON.stringify(s).replace(/"/g, '&quot;')})">
                    <strong>${s.name}</strong><br>
                    <small>${Number(s.price).toLocaleString('en-US')} Ø±.ÙŠ</small>
                </div>
            `).join('');
            selectSize(0, sizes[0]);
        }
    }

    // âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³
    function selectSize(index, size) {
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const selectedBtn = document.getElementById(`s-${index}`);
        if (selectedBtn) selectedBtn.classList.add('active');
        
        selectedSize = size;
        updatePricesUI(size.price);
    }

    // âœ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    async function init() {
        if (!productId) { 
            window.location.href = 'index.html'; 
            return; 
        }
        
        showGallerySkeleton();
        
        try {
            const { data, error } = await _supabase.from('products').select('*').eq('id', productId).single();
            
            if (error || !data) {
                showErrorMessage('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }
            
            productData = data;
            renderProduct();
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
            showErrorMessage('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬');
        }
    }

    // âœ… Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
    function sendWhatsApp() {
        if (!productData) return;
        
        const yer = document.getElementById('priceYER').innerText;
        const sar = document.getElementById('priceSAR').innerText;
        const sizeInfo = selectedSize ? ` (Ø§Ù„Ù…Ù‚Ø§Ø³: ${selectedSize.name})` : '';
        
        const msg = `Ø£Ø±ØºØ¨ ÙÙŠ Ø·Ù„Ø¨: *${productData.name}*${sizeInfo}\n\n` +
                   `Ø§Ù„Ø³Ø¹Ø±: *${yer} Ø±.ÙŠ* | *${sar} Ø±.Ø³*\n` +
                   `Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬: ${window.location.href}`;
        
        window.open(`https://wa.me/967773266534?text=${encodeURIComponent(msg)}`);
    }

    // âœ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
    function addToCart() {
        if (!productData) return;
        
        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        
        let productImage = '';
        if (productData.image) {
            const fullUrl = getProductImageUrl(productData.image);
            productImage = fullUrl ? fullUrl : getPlaceholderSVG(); // âœ… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† optimize
        }
        
        const existingIndex = cart.findIndex(item => 
            item.id === productData.id && 
            item.sizeName === (selectedSize ? selectedSize.name : null)
        );
        
        if (existingIndex !== -1) {
            cart[existingIndex].qty += 1;
        } else {
            cart.push({
                id: productData.id,
                name: productData.name,
                price: selectedSize ? selectedSize.price : productData.price,
                qty: 1,
                sizeName: selectedSize ? selectedSize.name : null,
                image: productImage,
                hasSize: !!selectedSize
            });
        }
        
        localStorage.setItem("cart", JSON.stringify(cart));
        
        const message = document.createElement('div');
        message.innerHTML = `
            <div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); 
                       background:var(--secondary-color); color:white; padding:15px 25px; 
                       border-radius:12px; font-weight:800; z-index:10000; 
                       box-shadow:0 5px 20px rgba(255,140,0,0.4); animation:slideIn 0.5s ease;">
                âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${productData.name}" Ù„Ù„Ø³Ù„Ø©!
            </div>
        `;
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.style.animation = 'fadeOut 0.5s ease forwards';
            setTimeout(() => message.remove(), 500);
        }, 2000);
        
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
    }

    // âœ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬
    function shareProduct() {
        if (!productData) return;
        
        if (navigator.share) {
            navigator.share({
                title: productData.name,
                text: `Ø§Ø´ØªØ±ÙŠ ${productData.name} Ù…Ù† Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±`,
                url: window.location.href,
            }).catch(err => console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', err));
        } else {
            navigator.clipboard.writeText(window.location.href);
            
            const message = document.createElement('div');
            message.innerHTML = `
                <div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); 
                           background:var(--main-color); color:white; padding:15px 25px; 
                           border-radius:12px; font-weight:800; z-index:10000; 
                           box-shadow:0 5px 20px rgba(0,31,63,0.4); animation:slideIn 0.5s ease;">
                    ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬!
                </div>
            `;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.animation = 'fadeOut 0.5s ease forwards';
                setTimeout(() => message.remove(), 500);
            }, 2000);
        }
    }

    window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
