<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="/images/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icon-16x16.png">
    
    <meta name="description" content="Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© - Ø£ÙØ¶Ù„ Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø¨Ø£Ø³Ø¹Ø§Ø± Ù…Ù†Ø§Ø³Ø¨Ø©">
    <meta name="theme-color" content="#001F3F"> 
    <script type="application/ld+json">
        {
            "@context": "https://schema.org/",
            "@type": "Store",
            "name": "Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©",
            "url": "https://yourwebsite.com",
            "image": "logo.png"
        }
    </script>
    <style>
        :root {
            /* ğŸ”¥ğŸ”¥ Ø£Ù„ÙˆØ§Ù† Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± ğŸ”¥ğŸ”¥ */
            --main-color: #001F3F;      /* ÙƒØ­Ù„ÙŠ */
            --secondary-color: #FF8C00; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --text-color: #001F3F;
            
            /* ğŸ”¥ğŸ”¥ ØªØµØºÙŠØ± Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± ğŸ”¥ğŸ”¥ */
            --nav-height: 60px;
            --total-header-height: 145px; 
            
            --radius: 12px;
            --danger: #ff4d4d;
        }

        /* ============ Reset & Base ============ */
        *{
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html,body{
            height:100%;
            margin:0;
            font-family:'Tajawal',sans-serif;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }
        body{
            background:var(--bg-color);
            color:var(--text-color);
            padding-top:var(--total-header-height);
            padding-bottom:100px; 
            transition: background 0.3s, color 0.3s;
        }

        /* ============ Header (ØªØµØºÙŠØ± Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†) ============ */
        header{
            position:fixed;
            inset:0 0 auto 0;
            height:var(--total-header-height);
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(8px);
            padding-top:5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            z-index:100;
            transition: transform 0.3s ease, box-shadow 0.2s;
        }
        .header-hidden{
            transform: translateY(-100%);
            box-shadow:none;
        }
        .top-bar{
            height: 65px;
            display:flex;
            justify-content:center;
            align-items:center;
            padding: 0 10px;
            position: relative;
        }
        .store-logo{
            height: 50px;
            width: auto;
            object-fit:contain;
            display:block;
            cursor: pointer;
        }
        /* Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        #darkToggle, #currencyToggle {
            position:absolute; top: 18px;
            background: #f0f0f0; color: var(--main-color);
            border: 1px solid #eee; padding: 6px 12px;
            border-radius: 20px; cursor:pointer; font-weight:700; font-size: 11px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #darkToggle { left: 15px; }
        #currencyToggle{
            right:15px;
            background: rgba(0, 31, 63, 0.05);
            color: var(--main-color);
            border:1px solid rgba(0, 31, 63, 0.1);
        }
        /* Ø§Ù„Ø¨Ø­Ø« */
        .search-container{
            width:100%;
            display:flex;
            justify-content:center;
            padding: 5px 15px;
        }
        .search-input-wrapper{
            width:100%;
            max-width:980px;
            background:#f8f9fa;
            border-radius:99px;
            padding:6px 12px;
            display:flex;
            align-items:center;
            gap:8px;
            border:1px solid #eef0f2;
        }
        .search-input{
            width:100%;
            background:transparent;
            border:0;
            outline:none;
            font-size:13px;
            padding: 5px 0;
            color: var(--main-color);
        }
        .search-input::placeholder{
            color:#999;
        }
        /* Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .categories-wrapper{
            padding: 5px 15px 10px 15px;
            overflow-x:auto;
            white-space:nowrap;
            border-top:1px solid #f5f5f5;
            background:transparent;
            -ms-overflow-style:none;
            scrollbar-width:none;
            z-index:90;
        }
        .categories-wrapper::-webkit-scrollbar{
            display:none;
        }
        .filter-btn{
            display:inline-block;
            padding: 6px 14px;
            margin-left:8px;
            background:#fff;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            border-radius:20px;
            font-weight:600;
            font-size: 12px;
            cursor:pointer;
        }
        .filter-btn.active{
            background:var(--secondary-color);
            color:#fff;
            font-weight:800;
            box-shadow: 0 3px 8px rgba(255, 140, 0, 0.25);
        }

        /* ============ Main ============ */
        main{
            padding:12px;
            min-height:60vh;
            max-width:1100px;
            margin:0 auto;
        }
        
        /* Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠ */
        .hero-banner {
            background: linear-gradient(135deg, var(--main-color) 0%, #003366 100%);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 31, 63, 0.15);
        }
        .hero-banner h2 { margin: 0; font-size: 20px; z-index: 2; font-weight: 800; }
        .hero-banner p { margin: 5px 0 0; font-size: 12px; opacity: 0.9; z-index: 2; }

        .view-section{
            display:none;
            animation:fadeIn .18s ease forwards;
        }
        .view-section.active{
            display:block;
        }
        .products-grid{
            display:grid;
            grid-template-columns: repeat(2, 1fr);
            gap:10px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .card{
            background:var(--card-bg);
            border-radius:var(--radius);
            overflow:hidden;
            position:relative;
            box-shadow:0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        .card-image-wrapper{
            position:relative;
            width:100%;
            padding-top:100%;
            background:#fff;
            overflow:hidden;
            cursor:pointer;
        }
        .card-image-wrapper img{
            position:absolute;
            inset:0;
            width:100%;
            height:100%;
            object-fit:cover;
            transition: opacity 0.3s ease;
        }
        
        .card-image-wrapper img.loading {
            opacity: 0;
        }
        .card-image-wrapper img.loaded {
            opacity: 1;
        }
        
        .add-fab{
            position:absolute;
            bottom:10px;
            left:10px;
            width:34px;
            height:34px;
            background:var(--secondary-color);
            border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:18px; color:#fff;
            box-shadow:0 4px 12px rgba(255, 140, 0, 0.3);
            border:none;
            cursor:pointer;
            z-index:5;
        }
        .card-body{
            padding:12px 10px;
            cursor:pointer;
        }
        .name{
            font-size:13px;
            font-weight:600; 
            color: var(--main-color);
            margin-bottom:6px; height:34px; overflow:hidden;
            line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
        }
        .price-area{
            display:flex; align-items:baseline; gap:6px; flex-wrap:wrap;
        }
        .price{
            font-size:17px;
            font-weight:800;
            color: var(--secondary-color);
        }
        .old-price-small{
            font-size:11px;
            text-decoration:line-through;
            color:#999;
            margin-right:6px;
        }
        .discount-tag{
            background:#fff0e6;
            color:var(--secondary-color);
            font-size:9px;
            padding:2px 6px;
            border-radius:3px;
            font-weight:700;
        }
        .extra-info{
            font-size:10px;
            color:#777;
            margin-top:6px;
        }
        .action-btns-wrapper {
            margin-top:8px; display:flex; gap:8px;
        }
        
        /* Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ - ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ… */
        .cart-item{
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 15px; 
            background: #fff;
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border: 1px solid #f0f0f0;
            transition: transform 0.2s ease;
        }
        .cart-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .cart-item-info {
            flex: 1;
            min-width: 0;
        }
        .cart-item-name {
            font-weight: 700; 
            color: var(--main-color);
            font-size: 15px;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .cart-item-price {
            color: #666;
            font-size: 13px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .cart-item-price span {
            display: inline-block;
        }
        .cart-qty-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 8px;
        }
        .qty-btn{
            padding: 8px 12px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            color: var(--main-color);
            font-weight: 700;
            min-width: 35px;
            transition: all 0.2s;
        }
        .qty-btn:hover {
            background: var(--main-color);
            color: #fff;
            border-color: var(--main-color);
        }
        .qty-display {
            font-weight: 700;
            min-width: 35px;
            text-align: center;
            font-size: 16px;
        }
        .shipping-box, .cart-summary{
            background:#f9f9f9;
            padding:12px; border-radius:8px; margin:10px 0;
        }
        .summary-row{ display:flex; justify-content:space-between; margin-bottom:8px; color:#555; }
        .total-row{ border-top:1px solid #eee; padding-top:10px; display:flex; justify-content:space-between; font-weight:800; }
        .final-price{ color:var(--main-color); font-size:20px; }
        
        /* Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ */
        .checkout-btn{ 
            width:100%; 
            padding:15px; 
            border-radius:99px; 
            font-weight:800; 
            font-size:16px; 
            border:0; 
            cursor:pointer;
            background: linear-gradient(90deg,#25D366,#128C7E); 
            color:#fff;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav{
            position:fixed; bottom:0; left:0; right:0; background:#fff;
            display:flex; flex-wrap: nowrap; justify-content:space-around; align-items:center;
            border-top:1px solid #eee; z-index:100; padding: 0 0 0 0;
            transition: height 0.3s ease, padding 0.3s ease;
        }
        .nav-home-mode { height: 55px; }
        .nav-cart-mode { 
            height: 130px; 
            align-items: flex-start; 
            padding-top: 10px;
            flex-direction: column;
        }
        .nav-item{ 
            display:flex; flex-direction:column; align-items:center; gap:3px; color:#ccc; 
            font-size:10px; font-weight:500; width:50%; padding:6px 0; cursor:pointer;
        }
        .nav-item.active{ color:var(--secondary-color); font-weight:700; }
        .nav-badge{ position:absolute; top:6px; margin-right:-12px; background:var(--main-color); color:#fff; font-size:9px; padding:2px 6px; border-radius:10px; border:1px solid #fff; }
        .cart-actions-bar { 
            display: flex; 
            gap: 10px; 
            padding: 15px; 
            width: 100%; 
            background: #fff;
            border-top: 1px solid #eee;
        }

        /* Quick View */
        #quickView{ 
            position: fixed;
            inset: 0;
            background: rgba(0, 31, 63, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .quick-view-img-wrapper{ 
            width:100%; 
            padding-top:100%; 
            position:relative; 
            overflow:hidden; 
            background: #fff;
            border-radius: var(--radius) var(--radius) 0 0;
        }
        .quick-view-img-wrapper img{ 
            position:absolute; 
            inset:0; 
            width:100%; 
            height:100%; 
            object-fit:cover; 
        }
        
        /* Scroll to top button */
        #scrollTopBtn{ 
            position:fixed; 
            bottom:70px; 
            right:15px; 
            width:40px; 
            height:40px; 
            background:var(--main-color); 
            color:#fff; 
            border-radius:50%; 
            display:none; 
            justify-content:center; 
            align-items:center; 
            cursor:pointer; 
            z-index:99; 
            box-shadow:0 3px 10px rgba(0,31,63,0.3);
            font-size:18px;
            font-weight:bold;
        }

        /* ğŸ”¥ğŸ”¥ Dark mode CSS ğŸ”¥ğŸ”¥ */
        .dark body{ background:#001226; color:#e6e6e6; }
        .dark header{ background: rgba(0, 31, 63, 0.98); }
        .dark #darkToggle, .dark #currencyToggle { background: #00254d; color: #fff; border-color: #1a3a5c; }
        .dark .name{ color: #fff; }
        .dark .price, .dark .currency{ color: var(--secondary-color); }
        .dark .card, .dark .cart-item{ background:#001a35; box-shadow:0 2px 8px rgba(0,0,0,0.6); border-color: #1a3a5c; }
        .dark .cart-item-name { color: #fff; }
        .dark .search-input-wrapper{ background:#00254d; border:1px solid #1a3a5c; }
        .dark .search-input { color: #fff; }
        .dark .categories-wrapper{ border-top-color:#1a3a5c; }
        .dark .bottom-nav{ background:#001a35; border-top-color:#1a3a5c; }
        .dark .shipping-box, .dark .cart-summary{ background:#00254d; border:1px solid #1a3a5c; }
        .dark .quick-view-img-wrapper { background: #001a35; }
        .dark .cart-qty-controls { background: #00254d; }
        .dark .qty-btn { background: #001a35; border-color: #1a3a5c; color: #fff; }
        
        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ */
        .skeleton {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
            height: 320px;
            border: 1px solid #f0f0f0;
        }
        .skeleton-image {
            width: 100%;
            padding-top: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        .skeleton-body { padding: 12px 10px; }
        .skeleton-line { 
            height: 14px; 
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); 
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            margin-bottom: 8px; 
            border-radius: 4px; 
        }
        
        @keyframes loading {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Responsive */
        @media(min-width:800px){ 
            .products-grid{ grid-template-columns: repeat(4, 1fr); } 
        }
    </style>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <header>
        <button id="darkToggle" title="ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™</button>
        <button id="currencyToggle" onclick="toggleCurrency()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø©">Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ</button>

        <div class="top-bar">
            <img src="logo.png" alt="Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©" class="store-logo" onclick="switchTab('home')" style="cursor:pointer;">
        </div>
        
        <div class="search-container">
            <div class="search-input-wrapper" role="search">
                <span style="font-size:16px; color:var(--secondary-color)">ğŸ”</span>
                <input id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ ØªØµÙ†ÙŠÙ..." oninput="handleSearch(this.value)" />
                <button id="clearSearch" style="border:0;background:transparent;cursor:pointer;font-weight:700;display:none; color:#999">âœ–</button>
            </div>
        </div>
        
        <div class="categories-wrapper" id="categoriesBar" aria-label="Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª">
        </div>
    </header>

    <main>
        <div id="homeView" class="view-section active">
             <div class="hero-banner">
                <h2>Ø¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ©</h2>
                <p>ØªØ³ÙˆÙ‚ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</p>
            </div>

            <div id="productsGrid" class="products-grid">
                <!-- Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠØ© ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>

        <div id="cartView" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <button onclick="switchTab('home')" style="background:none; border:none; color:var(--main-color); font-size:14px; font-weight:700; cursor:pointer; padding: 0;"> â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø± </button>
                <div style="display:flex; align-items:center; gap: 15px;">
                    <h3 style="margin:0; font-size:16px; color:var(--main-color)">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h3>
                    <button onclick="clearCart()" style="background:none; border:none; color:var(--danger); font-size:13px; font-weight:700; cursor:pointer;"> ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„ </button>
                </div>
            </div>
            <div id="cartItems"></div>
            <div id="checkoutSection" style="display:none">
                <div class="shipping-box">
                    <label style="font-weight:bold; font-size:13px; color:var(--main-color)">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</label>
                    <select id="shippingSelect" class="shipping-select" onchange="renderCart()" style="border:none; background:transparent; font-weight:bold; color:var(--secondary-color);">
                        <option value="1000">Ø¯Ø§Ø®Ù„ ØµÙ†Ø¹Ø§Ø¡ (+1,000 Ø±.ÙŠ)</option>
                        <option value="2000">Ù…Ø­Ø§ÙØ¸Ø© Ø£Ø®Ø±Ù‰ (+2,000 Ø±.ÙŠ)</option>
                    </select>
                </div>
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span><span id="productsTotalDisplay">0</span>
                    </div>
                    
                    <div class="summary-row" id="discountRow" style="display:none; color:var(--danger); font-weight:700;">
                        <span>ğŸ’° Ø®ØµÙ… Ø®Ø§Øµ (<span id="discountPercent">0%</span>):</span>
                        <span id="discountDisplay">-0</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</span><span id="shippingDisplay">0</span>
                    </div>
                    <div class="total-row">
                        <span style="color:var(--main-color)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span><span class="final-price" id="finalTotalDisplay">0</span>
                    </div>
                </div>
            </div>
            <div class="empty-state" id="emptyCartMsg" style="display:none; text-align:center; padding:40px; color:#999;">
                <div style="font-size:50px;margin-bottom:10px; opacity:0.3">ğŸ›’</div>
                Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚!
            </div>
        </div>
    </main>

    <div id="quickView" onclick="if(event.target.id==='quickView')closeQuickView()">
        <div id="quickViewBox"></div>
    </div>

    <div id="scrollTopBtn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">â†‘</div>

    <div class="bottom-nav nav-home-mode">
        <div id="homeNavBarContent" style="display:flex; width:100%;">
            <div class="nav-item active" onclick="switchTab('home')">
                <svg viewBox="0 0 24 24" width="22" height="22"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="currentColor"/></svg>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </div>
            <div class="nav-item" onclick="switchTab('cart')" style="position:relative">
                <div class="nav-badge" id="cartBadge" style="display:none">0</div>
                <svg viewBox="0 0 24 24" width="22" height="22"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" fill="currentColor"/></svg>
                <span>Ø§Ù„Ø³Ù„Ø©</span>
            </div>
        </div>
        <div id="cartActionBarContent" class="cart-actions-bar" style="display:none;">
            <button class="checkout-btn" onclick="sendCart()">ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>
    </div>

    <script>
        /* ====================== Global state ====================== */
        const WHATSAPP = "967773266534";
        const SAR_RATE = 140;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
        const SUPABASE_URL = 'https://ukjgzbgzzmlprnhlwgpr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVramd6Ymd6em1scHJuaGx3Z3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTM4NzAsImV4cCI6MjA4MTIyOTg3MH0.A-xvwqyDxwxDTeiB8nBgOwrJTPLWenYlO99nxbgobTw';
        
        let sb;
        try {
            if (typeof supabase !== 'undefined') {
                sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Supabase:", error);
        }
        
        window.allProducts = window.allProducts || [];
        let cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
        let currentFilter = "all";
        let currentCurrency = localStorage.getItem('currentCurrency') || 'YER'; 

        const grid = document.getElementById("productsGrid");
        const cartItemsContainer = document.getElementById("cartItems");
        const cartBadge = document.getElementById("cartBadge");
        const emptyCartMsg = document.getElementById("emptyCartMsg");
        const checkoutSection = document.getElementById("checkoutSection");
        const bottomNav = document.querySelector('.bottom-nav');
        const homeNavBarContent = document.getElementById('homeNavBarContent');
        const cartActionBarContent = document.getElementById('cartActionBarContent');
        const currencyToggleBtn = document.getElementById('currencyToggle');
        
        const productsTotalDisplay = document.getElementById("productsTotalDisplay");
        const discountRow = document.getElementById("discountRow");
        const discountPercent = document.getElementById("discountPercent");
        const discountDisplay = document.getElementById("discountDisplay");
        const shippingDisplay = document.getElementById("shippingDisplay");
        const finalTotalDisplay = document.getElementById("finalTotalDisplay");
        const shippingSelect = document.getElementById("shippingSelect");
        const scrollBtn = document.getElementById("scrollTopBtn");
        const quickViewEl = document.getElementById("quickView");
        const quickViewBox = document.getElementById("quickViewBox");
        const searchInput = document.getElementById("searchInput");
        const clearSearch = document.getElementById("clearSearch");
        const darkToggle = document.getElementById("darkToggle");
        const mainHeader = document.querySelector('header');
        
        let lastScrollTop = 0;
        const headerHeight = 145;
        let renderTimeout = null;

        /* ====================== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ====================== */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        /* ====================== Utils ====================== */
        function saveCart(){ 
            localStorage.setItem("cart", JSON.stringify(cart)); 
        }
        
        function getHashNumber(str){ 
            let hash=0;
            for(let i=0;i<str.length;i++){
                hash = str.charCodeAt(i) + ((hash<<5)-hash);
            }
            return Math.abs(hash);
        }

        // âœ… SVG Placeholder ÙƒØ¯Ø§Ù„Ø©
        function getPlaceholderSVG() {
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f8f9fa'/%3E%3Ctext x='50' y='55' font-family='Tajawal' font-size='14' text-anchor='middle' fill='%23999'%3EğŸ–¼ï¸%3C/text%3E%3C/svg%3E";
        }

        /* ====================== Currency Toggle Logic ====================== */
        function updateCurrencyDisplay() {
            currencyToggleBtn.textContent = currentCurrency === 'SAR' ? 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' : 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ';
        }
        
        window.toggleCurrency = function() {
            currentCurrency = (currentCurrency === 'YER' ? 'SAR' : 'YER');
            localStorage.setItem('currentCurrency', currentCurrency);
            updateCurrencyDisplay();
            if (document.getElementById('homeView').classList.contains('active')) {
                renderProducts();
            } else if (document.getElementById('cartView').classList.contains('active')) {
                renderCart();
            }
            if (quickViewEl.style.display === 'flex' && quickViewBox.dataset.productId) {
                quickViewById(quickViewBox.dataset.productId);
            }
        }
        updateCurrencyDisplay();

        /* ====================== Scroll hide header ====================== */
        window.addEventListener('scroll', throttle(function(){
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if(scrollTop <= headerHeight / 2){
                mainHeader.classList.remove('header-hidden');
                lastScrollTop = scrollTop;
                scrollBtn.style.display = scrollTop > 400 ? "flex" : "none";
                return;
            }
            if(scrollTop > lastScrollTop) mainHeader.classList.add('header-hidden');
            else mainHeader.classList.remove('header-hidden');
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            scrollBtn.style.display = scrollTop > 400 ? "flex" : "none";
        }, 100), { passive:true });
        
        scrollBtn.onclick = () => window.scrollTo({ top:0, behavior:'smooth' });

        /* ====================== Dark mode ====================== */
        darkToggle.onclick = () => {
            document.documentElement.classList.toggle('dark');
            const on = document.documentElement.classList.contains('dark');
            localStorage.setItem('dark', on ? '1' : '0');
            darkToggle.textContent = on ? 'â˜€ï¸' : 'ğŸŒ™';
        };
        if(localStorage.getItem('dark') === '1'){
            document.documentElement.classList.add('dark');
            darkToggle.textContent = 'â˜€ï¸';
        }

        /* ====================== Tabs (Ù…Ø¨Ø³Ù‘Ø·Ø©) ====================== */
        function switchTab(tab){
            document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
            const headerEl = document.querySelector('header');

            if(tab === 'home'){
                document.getElementById('homeView').classList.add('active');
                document.querySelector('.nav-item:first-child').classList.add('active');
                renderProducts();
                cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
                updateCartBadge();
                
                bottomNav.classList.remove('nav-cart-mode');
                bottomNav.classList.add('nav-home-mode');
                homeNavBarContent.style.display = 'flex';
                cartActionBarContent.style.display = 'none';
                
                if (headerEl) headerEl.style.display = 'block';
                document.body.style.paddingTop = 'var(--total-header-height)';
                document.body.style.paddingBottom = '100px'; 
            } 
            else if(tab === 'cart'){
                document.getElementById('cartView').classList.add('active');
                document.querySelector('.nav-item:last-child').classList.add('active');
                cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
                renderCart();
                
                bottomNav.classList.remove('nav-home-mode');
                bottomNav.classList.add('nav-cart-mode');
                homeNavBarContent.style.display = 'none';
                
                if (headerEl) headerEl.style.display = 'none';
                document.body.style.paddingTop = '0px';
                document.body.style.paddingBottom = '150px'; 
            }
            window.scrollTo({top:0, behavior:'smooth'});
        }

        /* ====================== ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ====================== */
        window.openProductPage = function(productId) {
            const product = window.allProducts.find(p => p.id == productId);
            if (product) {
                // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ localStorage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬
                localStorage.setItem('allProducts', JSON.stringify(window.allProducts));
                
                // Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ localStorage
                localStorage.setItem('currentProduct_' + productId, JSON.stringify(product));
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬
                window.location.href = `product.html?id=${productId}`;
            } else {
                console.error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', productId);
                alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹');
            }
        }

        /* ====================== Search ====================== */
        function normalizeStr(s){
            if(!s) return "";
            return s.toString().toLowerCase().trim();
        }
        
        const handleSearchDebounced = debounce(function(q){
            clearSearch.style.display = q ? "inline-block" : "none";
            if(!window.allProducts || !window.allProducts.length){
                return; 
            }
            if(!q){
                renderProducts();
                return;
            }
            const nq = normalizeStr(q);
            const items = window.allProducts.filter(p => {
                const name = normalizeStr(p.name || p.title || "");
                const cat = normalizeStr(p.category || "");
                const code = normalizeStr(p.id || "");
                return name.includes(nq) || cat.includes(nq) || code.includes(nq);
            });
            drawItems(items);
            
            if (window.initObservers) {
                setTimeout(window.initObservers, 50); 
            }
        }, 300);
        
        window.handleSearch = function(q) {
            handleSearchDebounced(q);
        };
        
        clearSearch.onclick = () => {
            searchInput.value='';
            handleSearch('');
        };

        /* ====================== Render & Draw ====================== */
        window.renderProducts = function(){
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            
            renderTimeout = setTimeout(() => {
                let items = currentFilter === 'all' 
                    ? (window.allProducts || []) 
                    : (window.allProducts || []).filter(p => normalizeStr(p.category) === normalizeStr(currentFilter));
                
                drawItems(items);
                
                if (window.initObservers) {
                    setTimeout(window.initObservers, 100); 
                }
            }, 50);
        };
        
        window.filterProducts = function(cat, btn){
            document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = cat;
            searchInput.value = "";
            renderProducts();
        }

        function drawItems(items){
            grid.innerHTML = "";

            if(items.length === 0){
                grid.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ”</div>`;
                return;
            }

            const batchSize = 12;
            const totalBatches = Math.ceil(items.length / batchSize);
            
            function renderBatch(batchIndex) {
                const start = batchIndex * batchSize;
                const end = Math.min(start + batchSize, items.length);
                const batch = items.slice(start, end);
                
                batch.forEach((p, index) => {
                    const card = createProductCard(p, start + index);
                    grid.appendChild(card);
                });
                
                if (batchIndex < totalBatches - 1) {
                    setTimeout(() => renderBatch(batchIndex + 1), 50);
                } else {
                    if (window.initObservers) {
                        setTimeout(window.initObservers, 100);
                    }
                }
            }
            
            renderBatch(0);
        }

        function createProductCard(p, globalIndex){
            const card = document.createElement('div');
            card.className = 'card';
            const imgs = Array.isArray(p.image) ? p.image : [];
            
            let rawPrice = (p.price || "").toString().replace(/[^0-9.]/g, '');
            let priceVal = parseFloat(rawPrice) || 0;
            let fakeOldPrice = Math.floor(priceVal * 1.3);

            let displayPrice = priceVal;
            let displayOld = fakeOldPrice;
            let displayCurrency = 'Ø±.ÙŠ';
            if (currentCurrency === 'SAR') {
                displayPrice = Math.ceil(priceVal / SAR_RATE);
                displayOld = Math.ceil(fakeOldPrice / SAR_RATE);
                displayCurrency = 'Ø±.Ø³';
            }

            const primaryImgSrc = imgs[0] || null;
            
            // âœ… ØªØ­Ø¯ÙŠØ¯ Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµÙˆØ±Ø©
            // Ø£ÙˆÙ„ 8 ØµÙˆØ±: eagerØŒ Ø§Ù„Ø¨Ø§Ù‚ÙŠ: lazy
            const isFirstEight = globalIndex < 8;
            
            let imgTag;
            if (primaryImgSrc) {
                if (isFirstEight) {
                    // âœ… Ø£ÙˆÙ„ 8 ØµÙˆØ±: loading="eager"
                    imgTag = `<img src="${primaryImgSrc}" alt="${p.name||''}" loading="eager" class="loaded">`;
                } else {
                    // âœ… Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙˆØ±: loading="lazy" Ù…Ø¹ IntersectionObserver
                    imgTag = `<img data-src="${primaryImgSrc}" src="${getPlaceholderSVG()}" alt="${p.name||''}" loading="lazy" class="loading">`;
                }
            } else {
                // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… SVG placeholder Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ
                imgTag = `<img src="${getPlaceholderSVG()}" alt="${p.name||''}" loading="lazy" class="loaded">`;
            }

            const hash = getHashNumber(p.id || Math.random().toString(36).slice(2));
            const soldCount = (hash % 901) + 100; 

            const imageWrapper = `
                <div class="card-image-wrapper" data-id="${p.id}" onclick="openProductPage('${p.id}')">
                    ${imgTag}
                    <div class="add-fab" title="Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©" onclick="event.stopPropagation(); addToCart('${p.id}'); showAddedToCartMessage('${p.name}')">+</div>
                </div>
            `;
            
            const actionBtns = `
                <div class="action-btns-wrapper">
                    <button style="flex:1; border-radius:8px; border:1px solid var(--main-color); background:#fff; color:var(--main-color); cursor:pointer; padding:8px;" 
                            onclick="event.stopPropagation(); window.quickViewById('${p.id}')">
                        ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø³Ø±ÙŠØ¹Ø©
                    </button>
                    <button style="flex:1; border-radius:8px; border:0; background:var(--main-color); color:#fff; cursor:pointer; padding:8px;" 
                            onclick="event.stopPropagation(); addToCart('${p.id}'); showAddedToCartMessage('${p.name}')">
                        Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                    </button>
                </div>
            `;
            
            card.innerHTML = `
                ${imageWrapper}
                <div class="card-body" onclick="openProductPage('${p.id}')">
                    <div class="name">${p.name || 'Ù…Ù†ØªØ¬'}</div>
                    <div class="price-area">
                        <span class="currency">${displayCurrency}</span>
                        <span class="price">${displayPrice.toLocaleString()}</span>
                    </div>
                    <div style="display:flex; align-items:center; margin-top:6px;">
                        <span class="old-price-small">${displayOld.toLocaleString()} ${displayCurrency}</span>
                        <span class="discount-tag">-30%</span>
                    </div>
                    <div class="extra-info">ØªÙ… Ø¨ÙŠØ¹ ${soldCount}+ Ù‚Ø·Ø¹Ø©</div>
                    ${actionBtns}
                </div>
            `;
            return card;
        }

        /* ====================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø© - Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª ====================== */
        window.addToCart = function(id){
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ù…Ù† localStorage Ø£ÙˆÙ„Ø§Ù‹
            cart = JSON.parse(localStorage.getItem("cart") || "[]") || [];
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† allProducts
            const product = (window.allProducts || []).find(x => x.id == id);
            
            if (!product) {
                console.error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', id);
                return;
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø©
            let item = cart.find(p => p.id == id);
            
            if(item) {
                item.qty = (item.qty || 0) + 1;
            } else {
                cart.push({ 
                    id: product.id, 
                    name: product.name || 'Ù…Ù†ØªØ¬', 
                    price: product.price || "0", 
                    qty: 1 
                });
            }
            
            saveCart();
            updateCartBadge();
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
            showAddedToCartMessage(product.name || 'Ù…Ù†ØªØ¬');
            
            // Ø§Ù‡ØªØ²Ø§Ø² Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
            if (navigator.vibrate) {
                navigator.vibrate(40);
            }
        }
        
        window.showAddedToCartMessage = function(productName){
            const msg = document.createElement('div');
            msg.innerHTML = `
                <div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--secondary-color); color:white; padding:12px 20px; border-radius:8px; font-weight:700; z-index:1000; box-shadow:0 4px 15px rgba(255,140,0,0.3); animation:fadeIn 0.3s ease;">
                    âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${productName}" Ù„Ù„Ø³Ù„Ø©
                </div>
            `;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => msg.remove(), 300);
            }, 2000);
        }
        
        window.changeQty = function(id, delta){
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            let item = cart.find(i => i.id == id);
            if(!item) return;
            
            item.qty = (item.qty || 1) + delta;
            if(item.qty <= 0) {
                cart = cart.filter(i => i.id != id);
            }
            
            saveCart();
            renderCart();
            updateCartBadge();
        }

        window.clearCart = function(){
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ")) {
                cart = [];
                saveCart();
                renderCart();
                updateCartBadge();
            }
        }

        function updateCartBadge(){
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            let total = cart.reduce((acc,it)=> acc + (it.qty||0), 0);
            cartBadge.style.display = total > 0 ? "block" : "none";
            cartBadge.textContent = total > 99 ? '99+' : total;
        }

        window.renderCart = function(){
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            cartItemsContainer.innerHTML = "";
            
            if(cart.length === 0){
                emptyCartMsg.style.display = "block";
                cartActionBarContent.style.display = "none";
                checkoutSection.style.display = "none";
                return;
            }

            emptyCartMsg.style.display = "none";
            cartActionBarContent.style.display = "flex";
            checkoutSection.style.display = "block";
            
            let productSubTotal = 0;
            
            cart.forEach(item => {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ allProducts Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const originalProduct = (window.allProducts || []).find(p => p.id == item.id);
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØªØŒ Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
                const productName = originalProduct ? originalProduct.name : (item.name || "Ù…Ù†ØªØ¬");
                const productPrice = originalProduct ? originalProduct.price : (item.price || "0");
                
                let rawPrice = productPrice.toString().replace(/[^0-9.]/g,'');
                let priceVal = parseFloat(rawPrice) || 0;
                let itemTotal = priceVal * (item.qty || 0);
                productSubTotal += itemTotal;

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                let itemDisplayPrice, itemDisplayTotal;
                let displayCurrency = 'Ø±.ÙŠ';
                
                if (currentCurrency === 'YER') {
                    itemDisplayPrice = priceVal.toLocaleString() + " Ø±.ÙŠ";
                    itemDisplayTotal = itemTotal.toLocaleString() + " Ø±.ÙŠ";
                } else {
                    itemDisplayPrice = Math.ceil(priceVal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                    itemDisplayTotal = Math.ceil(itemTotal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                    displayCurrency = 'Ø±.Ø³';
                }

                cartItemsContainer.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${productName}</div>
                            <div class="cart-item-price">
                                <span>Ø§Ù„Ø³Ø¹Ø±: ${itemDisplayPrice}</span>
                                <span>Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.qty || 1}</span>
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${itemDisplayTotal}</span>
                            </div>
                        </div>
                        <div class="cart-qty-controls">
                            <button class="qty-btn" onclick="changeQty('${item.id}', -1)" title="ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©">-</button>
                            <div class="qty-display">${item.qty || 1}</div>
                            <button class="qty-btn" onclick="changeQty('${item.id}', 1)" title="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©">+</button>
                        </div>
                    </div>
                `;
            });

            const settings = window.globalSettings || { discountPercentage: 0, minAmountForDiscount: 0 };
            const { discountPercentage, minAmountForDiscount } = settings;
            let discountAmount = 0;
            
            if (productSubTotal >= minAmountForDiscount && discountPercentage > 0) {
                discountAmount = (productSubTotal * discountPercentage) / 100;
                discountRow.style.display = 'flex';
                discountPercent.innerText = discountPercentage + '%';
            } else {
                discountRow.style.display = 'none';
            }

            let finalProductTotalYER = productSubTotal - discountAmount;
            let shippingCostYER = parseInt(shippingSelect.value || "1000");
            let finalTotalYER = finalProductTotalYER + shippingCostYER;

            let displayCurrencySymbol = ' Ø±.ÙŠ';
            let productsTotalDisplayValue = productSubTotal;
            let discountDisplayValue = discountAmount;
            let shippingDisplayValue = shippingCostYER;
            let finalTotalDisplayValue = finalTotalYER;

            if (currentCurrency === 'SAR') {
                displayCurrencySymbol = ' Ø±.Ø³';
                productsTotalDisplayValue = Math.ceil(productSubTotal / SAR_RATE);
                discountDisplayValue = Math.ceil(discountAmount / SAR_RATE);
                shippingDisplayValue = Math.ceil(shippingCostYER / SAR_RATE);
                finalTotalDisplayValue = Math.ceil(finalTotalYER / SAR_RATE);
            }
            
            productsTotalDisplay.innerText = productsTotalDisplayValue.toLocaleString() + displayCurrencySymbol;
            discountDisplay.innerText = (discountAmount > 0 ? '-' : '') + discountDisplayValue.toLocaleString() + displayCurrencySymbol;
            shippingDisplay.innerText = shippingDisplayValue.toLocaleString() + displayCurrencySymbol;
            finalTotalDisplay.innerText = finalTotalDisplayValue.toLocaleString() + displayCurrencySymbol;
        }

        window.sendCart = function(){
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            if(cart.length === 0) return;
            
            let msg = "ğŸ“¦ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±*\n\n";
            msg += "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\n";
            msg += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
            
            let productSubTotal = 0;
            
            cart.forEach((i, idx) => {
                let rawPrice = (i.price || "").toString().replace(/[^0-9.]/g, '');
                let priceVal = parseFloat(rawPrice) || 0;
                let itemTotal = priceVal * (i.qty || 0);
                productSubTotal += itemTotal;
                
                let displayPrice = priceVal.toLocaleString() + " Ø±.ÙŠ";
                let displayItemTotal = itemTotal.toLocaleString() + " Ø±.ÙŠ";
                
                if (currentCurrency === 'SAR') {
                    displayPrice = Math.ceil(priceVal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                    displayItemTotal = Math.ceil(itemTotal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                }
                
                msg += `${idx+1}. ${i.name}\n`;
                msg += `   Ø§Ù„ÙƒÙ…ÙŠØ©: ${i.qty}\n`;
                msg += `   Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙˆØ§Ø­Ø¯Ø©: ${displayPrice}\n`;
                msg += `   Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${displayItemTotal}\n`;
                msg += `   â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            });
            
            const settings = window.globalSettings || { discountPercentage: 0, minAmountForDiscount: 0 };
            const { discountPercentage, minAmountForDiscount } = settings;
            let discountAmount = 0;
            if (productSubTotal >= minAmountForDiscount && discountPercentage > 0) {
                discountAmount = (productSubTotal * discountPercentage) / 100;
            }
            let finalProductTotalYER = productSubTotal - discountAmount;
            let shippingCostYER = parseInt(shippingSelect.value || "1000");
            let finalTotalYER = finalProductTotalYER + shippingCostYER;
            
            let displayCurrencySymbol = ' Ø±.ÙŠ';
            let displayProductSubTotal = productSubTotal;
            let displayDiscountAmount = discountAmount;
            let displayShippingCost = shippingCostYER;
            let displayFinalTotal = finalTotalYER;

            if (currentCurrency === 'SAR') {
                displayCurrencySymbol = ' Ø±.Ø³';
                displayProductSubTotal = Math.ceil(productSubTotal / SAR_RATE);
                displayDiscountAmount = Math.ceil(discountAmount / SAR_RATE);
                displayShippingCost = Math.ceil(shippingCostYER / SAR_RATE);
                displayFinalTotal = Math.ceil(finalTotalYER / SAR_RATE);
            }
            
            const shippingLocation = shippingSelect.options[shippingSelect.selectedIndex].text;
            
            msg += `\nğŸ“Š *Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:*\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            msg += `ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${displayProductSubTotal.toLocaleString()}${displayCurrencySymbol}\n`;
            
            if (discountAmount > 0) {
                msg += `ğŸ’° Ø§Ù„Ø®ØµÙ… (${discountPercentage}%): -${displayDiscountAmount.toLocaleString()}${displayCurrencySymbol}\n`;
            }
            
            msg += `ğŸ“ Ø§Ù„ØªÙˆØµÙŠÙ„ (${shippingLocation.split('(')[0]}): +${displayShippingCost.toLocaleString()}${displayCurrencySymbol}\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            msg += `ğŸŒŸ *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${displayFinalTotal.toLocaleString()}${displayCurrencySymbol}*\n\n`;
            
            msg += `ğŸ“ *Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„:*\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            msg += `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${shippingLocation.split('(')[0]}\n`;
            msg += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-YE')}\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
            msg += `Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨ÙƒÙ… Ù…Ù† Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ğŸ âœ¨\n`;
            msg += `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªÙˆØµÙŠÙ„.`;

            window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`);
        }

        /* ====================== Quick View ====================== */
        window.quickViewById = function(id){
            const p = (window.allProducts || []).find(x => x.id === id);
            if(!p) return quickView({ id, name: 'Ù…Ù†ØªØ¬', price: 0, image: null });
            quickView(p);
        }

        function quickView(product){
            const imgs = Array.isArray(product.image) ? product.image : [];
            const primaryImgSrc = imgs[0] || null;

            let rawPrice = (product.price || "").toString().replace(/[^0-9.]/g, '');
            let priceVal = parseFloat(rawPrice) || 0;
            let displayPrice = priceVal.toLocaleString();
            let displayCurrency = 'Ø±.ÙŠ';

            if (currentCurrency === 'SAR') {
                displayPrice = Math.ceil(priceVal / SAR_RATE).toLocaleString();
                displayCurrency = 'Ø±.Ø³';
            }

            // âœ… Quick View: Ø§Ø³ØªØ®Ø¯Ø§Ù… lazy loading ÙÙ‚Ø· Ù„Ù„ØµÙˆØ±
            const quickViewImage = primaryImgSrc 
                ? `<img data-src="${primaryImgSrc}" src="${getPlaceholderSVG()}" alt="${product.name||''}" loading="lazy" class="loading">`
                : `<img src="${getPlaceholderSVG()}" alt="${product.name||''}" loading="lazy" class="loaded">`;

            quickViewBox.innerHTML = `
                <div style="position:relative; background:white; border-radius:var(--radius); max-width:95vw; width:320px; max-height:85vh; overflow-y:auto; animation:zoomIn .15s ease forwards; margin:auto;">
                    <button onclick="closeQuickView()" style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.3); color:white; border:none; border-radius:50%; width:30px; height:30px; font-size:16px; cursor:pointer; z-index:10;">âœ•</button>
                    <div class="quick-view-img-wrapper">
                        ${quickViewImage}
                    </div>
                    <div style="padding:16px;">
                        <h3 style="margin:0 0 10px 0; color:var(--main-color); font-size:16px;">${product.name || ''}</h3>
                        <div style="font-size:22px; color:var(--secondary-color); font-weight:800; margin-bottom:15px;">${displayPrice} ${displayCurrency}</div>
                        <div style="color:#666; font-size:14px; line-height:1.5; margin-bottom:20px;">Ù…Ù†ØªØ¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</div>
                        <div style="margin-top:20px; display:flex; gap:10px; flex-direction:column;">
                            <button style="width:100%; padding:12px; border-radius:8px; border:0; background:var(--secondary-color); color:#fff; font-weight:800; font-size:16px; cursor:pointer;" 
                                    onclick="addToCart('${product.id}'); closeQuickView(); showAddedToCartMessage('${product.name}');">
                                Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                            </button>
                            <button style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--main-color); background:#fff; color:var(--main-color); font-weight:700; font-size:16px; cursor:pointer;" 
                                    onclick="openProductPage('${product.id}');">
                                Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ù†ØªØ¬
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            quickViewBox.dataset.productId = product.id; 
            quickViewEl.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙˆØ± ÙÙŠ Quick View
            setTimeout(() => {
                if (window.initObservers) {
                    window.initObservers();
                }
            }, 50);
        }

        window.closeQuickView = function(){
            quickViewEl.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        /* ====================== Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Supabase ====================== */
        async function fetchProducts() {
            // Ø¥Ø¸Ù‡Ø§Ø± Ù‡ÙŠØ§ÙƒÙ„ Ø¹Ø¸Ù…ÙŠØ© Ù„Ù„ØªØ­Ù…ÙŠÙ„
            showSkeletons();
            
            try {
                if (sb) {
                    const { data: products, error } = await sb
                        .from('products')
                        .select('id, name, price, category, image')
                        .order('id', { ascending: false });

                    if (error) throw error;
                    
                    window.allProducts = products || [];
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                    renderProducts();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø§Øª
                    fetchCategories();
                    
                } else {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ± Supabase
                    window.allProducts = getSampleProducts();
                    renderProducts();
                }
            } catch (err) {
                console.error(err);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                window.allProducts = getSampleProducts();
                renderProducts();
            }
        }

        function fetchCategories() {
            const categoriesBar = document.getElementById('categoriesBar');
            if (!categoriesBar) return;
            
            // Ù…Ø³Ø­ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            categoriesBar.innerHTML = '';
            
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± "Ø§Ù„ÙƒÙ„"
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.textContent = 'Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù„Ùƒ';
            allBtn.onclick = () => window.filterProducts('all', allBtn);
            categoriesBar.appendChild(allBtn);
            
            // Ø¬Ù…Ø¹ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            const categories = [...new Set(window.allProducts.map(p => p.category).filter(Boolean))];
            
            categories.forEach(cat => {
                if (cat) {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = cat;
                    btn.onclick = (e) => window.filterProducts(cat, e.target);
                    categoriesBar.appendChild(btn);
                }
            });
        }

        function showSkeletons() {
            const grid = document.getElementById("productsGrid");
            if (!grid) return;
            
            grid.innerHTML = '';
            
            for(let i = 0; i < 6; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton';
                skeleton.innerHTML = `
                    <div class="skeleton-image"></div>
                    <div class="skeleton-body">
                        <div class="skeleton-line" style="width:80%"></div>
                        <div class="skeleton-line" style="width:40%"></div>
                        <div class="skeleton-line" style="width:100%; height:30px"></div>
                    </div>
                `;
                grid.appendChild(skeleton);
            }
        }

        // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        function getSampleProducts() {
            return [
                {
                    id: "1",
                    name: "Ø³Ø§Ø¹Ø© ÙŠØ¯ Ø°ÙƒÙŠØ©",
                    price: 450,
                    category: "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª",
                    image: ["https://via.placeholder.com/150"]
                },
                {
                    id: "2",
                    name: "Ø­Ù‚ÙŠØ¨Ø© Ø¸Ù‡Ø±",
                    price: 120,
                    category: "Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª",
                    image: []
                },
                {
                    id: "3",
                    name: "ØºÙ„Ø§ÙŠØ© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
                    price: 85,
                    category: "Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©",
                    image: ["https://via.placeholder.com/150"]
                },
                {
                    id: "4",
                    name: "Ø³Ù…Ø§Ø¹Ø§Øª Ø¨Ù„ÙˆØªÙˆØ«",
                    price: 65,
                    category: "Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª",
                    image: ["https://via.placeholder.com/150"]
                }
            ];
        }

        /* ====================== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ====================== */
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product');
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
            fetchProducts();
            
            if (productId && window.allProducts && window.allProducts.length > 0) {
                const productExists = window.allProducts.some(p => p.id === productId);
                if (productExists) {
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬
                    openProductPage(productId);
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« badge Ø§Ù„Ø³Ù„Ø©
            updateCartBadge();
        };

        /* ====================== Initial setup ====================== */
        window.onpageshow = function(event){
            if(event.persisted || performance?.navigation?.type == 2){
                cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
                updateCartBadge();
            }
        };

        // ØªØ­Ø¯ÙŠØ« badge Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        updateCartBadge();

    </script>
</body>
</html>
