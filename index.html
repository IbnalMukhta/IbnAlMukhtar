<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16x16.png">

    <meta name="description" content="Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© - Ø£ÙØ¶Ù„ Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø¨Ø£Ø³Ø¹Ø§Ø± Ù…Ù†Ø§Ø³Ø¨Ø©">
    <meta name="theme-color" content="#001F3F"> 
    <script type="application/ld+json">
        {
            "@context": "https://schema.org/",
            "@type": "Store",
            "name": "Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©",
            "url": "https://yourwebsite.com",
            "image": "logo.png"
        }
    </script>
    <style>
        :root {
            /* ğŸ”¥ğŸ”¥ Ø£Ù„ÙˆØ§Ù† Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± ğŸ”¥ğŸ”¥ */
            --main-color: #001F3F;
            --secondary-color: #FF8C00;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --text-color: #001F3F;
            
            /* ğŸ”¥ğŸ”¥ ØªØµØºÙŠØ± Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± ğŸ”¥ğŸ”¥ */
            --nav-height: 60px;
            --total-header-height: 145px; 
            
            --radius: 12px;
            --danger: #ff4d4d;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
            --new-badge: #FF4081;
        }

        /* ============ Reset & Base ============ */
        *{
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        html,body{
            height:100%;
            margin:0;
            font-family:'Tajawal',sans-serif;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }
        body{
            background:var(--bg-color);
            color:var(--text-color);
            padding-top:var(--total-header-height);
            padding-bottom:100px; 
            transition: background 0.3s, color 0.3s;
        }

        /* ============ Header ============ */
        header{
            position:fixed;
            inset:0 0 auto 0;
            height:var(--total-header-height);
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(8px);
            padding-top:5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            z-index:100;
            transition: transform 0.3s ease, box-shadow 0.2s;
        }
        .header-hidden{
            transform: translateY(-100%);
            box-shadow:none;
        }
        .top-bar{
            height: 65px;
            display:flex;
            justify-content:center;
            align-items:center;
            padding: 0 10px;
            position: relative;
        }
        .store-logo{
            height: 50px;
            width: auto;
            object-fit:contain;
            display:block;
            cursor: pointer;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        #darkToggle, #currencyToggle, #cartToggle {
            position:absolute; top: 18px;
            background: #f0f0f0; color: var(--main-color);
            border: 1px solid #eee; padding: 6px 12px;
            border-radius: 20px; cursor:pointer; font-weight:700; font-size: 11px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        #darkToggle { 
            left: 15px;
        }

        #currencyToggle {
            left: 50px;
            background: rgba(0, 31, 63, 0.05);
            color: var(--main-color);
            border:1px solid rgba(0, 31, 63, 0.1);
        }

        #cartToggle {
            right: 15px;
            background: var(--secondary-color);
            color: white;
            border:1px solid var(--secondary-color);
        }

        /* Ø§Ù„Ø¨Ø­Ø« */
        .search-container{
            width:100%;
            display:flex;
            justify-content:center;
            padding: 5px 15px;
        }
        .search-input-wrapper{
            width:100%;
            max-width:980px;
            background:#f8f9fa;
            border-radius:99px;
            padding:6px 12px;
            display:flex;
            align-items:center;
            gap:8px;
            border:1px solid #eef0f2;
        }
        .search-input{
            width:100%;
            background:transparent;
            border:0;
            outline:none;
            font-size:13px;
            padding: 5px 0;
            color: var(--main-color);
        }
        .search-input::placeholder{
            color:#999;
        }

        /* Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª */
        .categories-wrapper{
            padding: 5px 15px 10px 15px;
            overflow-x:auto;
            white-space:nowrap;
            border-top:1px solid #f5f5f5;
            background:transparent;
            -ms-overflow-style:none;
            scrollbar-width:none;
            z-index:90;
        }
        .categories-wrapper::-webkit-scrollbar{
            display:none;
        }
        .filter-btn{
            display:inline-block;
            padding: 6px 14px;
            margin-left:8px;
            background:#fff;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            border-radius:20px;
            font-weight:600;
            font-size: 12px;
            cursor:pointer;
        }
        .filter-btn.active{
            background:var(--secondary-color);
            color:#fff;
            font-weight:800;
            box-shadow: 0 3px 8px rgba(255, 140, 0, 0.25);
        }

        /* ============ Main ============ */
        main{
            padding:12px;
            min-height:60vh;
            max-width:1100px;
            margin:0 auto;
        }
        
        /* Ø§Ù„Ø¨Ø§Ù†Ø± */
        .hero-banner {
            background: linear-gradient(135deg, var(--main-color) 0%, #003366 100%);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 31, 63, 0.15);
        }
        .hero-banner h2 { margin: 0; font-size: 20px; z-index: 2; font-weight: 800; }
        .hero-banner p { margin: 5px 0 0; font-size: 12px; opacity: 0.9; z-index: 2; }

        .view-section{
            display:none;
            animation:fadeIn .18s ease forwards;
        }
        .view-section.active{
            display:block;
        }
        .products-grid{
            display:grid;
            grid-template-columns: repeat(2, 1fr);
            gap:10px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
        .card{
            background:var(--card-bg);
            border-radius:var(--radius);
            overflow:hidden;
            position:relative;
            box-shadow:0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .card-image-wrapper{
            position:relative;
            width:100%;
            padding-top:100%;
            background:#fff;
            overflow:hidden;
            cursor:pointer;
        }
        
        /* Placeholder Ù„Ù„ØµÙˆØ± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .image-placeholder {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f5f5f5 25%, #e8e8e8 50%, #f5f5f5 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            z-index: 1;
            transition: opacity 0.3s ease;
        }
        
        /* Ø§Ù„ØµÙˆØ± Ø§Ù„ØªÙŠ ØªØªØ­Ù…Ù‘Ù„ Ø¨Ø´ÙƒÙ„ ÙƒØ³ÙˆÙ„ */
        .product-img.lazy {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }
        
        /* Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© */
        .product-img.lazy.loaded {
            opacity: 1;
        }
        
        /* Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© */
        .product-img.lazy.error {
            opacity: 0;
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ placeholder Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© */
        .product-img.lazy.loaded ~ .image-placeholder {
            opacity: 0;
        }
        
        /* Ø¹Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯ */
        .new-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--new-badge);
            color: white;
            font-size: 9px;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 12px;
            z-index: 3;
            box-shadow: 0 2px 5px rgba(255, 64, 129, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© */
        .add-fab{
            position:absolute;
            bottom:10px;
            left:10px;
            width:34px;
            height:34px;
            background:var(--secondary-color);
            border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:18px; color:#fff;
            box-shadow:0 4px 12px rgba(255, 140, 0, 0.3);
            border:none;
            cursor:pointer;
            z-index:5;
            transition: all 0.3s ease;
        }
        .add-fab:hover {
            background: #e67e00;
            transform: scale(1.1);
        }
        
        /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ */
        .card-body{
            padding:12px 10px;
            cursor:pointer;
        }
        .name{
            font-size:13px;
            font-weight:600; 
            color: var(--main-color);
            margin-bottom:6px; height:34px; overflow:hidden;
            line-height:1.3; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
        }
        .price-area{
            display:flex; align-items:baseline; gap:6px; flex-wrap:wrap;
        }
        .price{
            font-size:17px;
            font-weight:800;
            color: var(--secondary-color);
        }
        .old-price-small{
            font-size:11px;
            text-decoration:line-through;
            color:#999;
            margin-right:6px;
        }
        .discount-tag{
            background:#fff0e6;
            color:var(--secondary-color);
            font-size:9px;
            padding:2px 6px;
            border-radius:3px;
            font-weight:700;
        }
        .extra-info{
            font-size:10px;
            color:#777;
            margin-top:6px;
        }
        .action-btns-wrapper {
            margin-top:8px; display:flex; gap:8px;
        }
        
        /* Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ */
        .load-more-container {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
        }
        
        .load-more-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .load-more-btn:hover {
            background: #e67e00;
            transform: translateY(-2px);
        }
        
        .load-more-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--secondary-color);
            font-weight: 700;
        }
        
        /* Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ */
        .cart-item{
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 15px; 
            background: #fff;
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border: 1px solid #f0f0f0;
            transition: transform 0.2s ease;
        }
        .cart-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .cart-item-info {
            flex: 1;
            min-width: 0;
        }
        .cart-item-name {
            font-weight: 700; 
            color: var(--main-color);
            font-size: 15px;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .cart-item-price {
            color: #666;
            font-size: 13px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .cart-item-price span {
            display: inline-block;
        }
        .cart-qty-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 8px;
        }
        .qty-btn{
            padding: 8px 12px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            color: var(--main-color);
            font-weight: 700;
            min-width: 35px;
            transition: all 0.2s;
        }
        .qty-btn:hover {
            background: var(--main-color);
            color: #fff;
            border-color: var(--main-color);
        }
        .qty-display {
            font-weight: 700;
            min-width: 35px;
            text-align: center;
            font-size: 16px;
        }
        .shipping-box, .cart-summary{
            background:#f9f9f9;
            padding:12px; border-radius:8px; margin:10px 0;
        }
        .summary-row{ display:flex; justify-content:space-between; margin-bottom:8px; color:#555; }
        .total-row{ border-top:1px solid #eee; padding-top:10px; display:flex; justify-content:space-between; font-weight:800; }
        .final-price{ color:var(--main-color); font-size:20px; }
        
        /* ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… */
        .discount-box {
            border: 2px dashed var(--secondary-color);
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.05), rgba(255, 140, 0, 0.1));
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
        }
        
        #discountMessage {
            animation: fadeIn 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            background: rgba(0, 128, 0, 0.1);
            border: 1px solid rgba(0, 128, 0, 0.2);
        }
        
        #discountMessage.error {
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid rgba(255, 77, 77, 0.2);
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø³Ù„Ø© */
        #cartItemsScrollable {
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) #f0f0f0;
        }

        #cartItemsScrollable::-webkit-scrollbar {
            width: 6px;
        }

        #cartItemsScrollable::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }

        #cartItemsScrollable::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }

        #cartItemsScrollable::-webkit-scrollbar-thumb:hover {
            background: #e67e00;
        }

        /* Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ */
        .checkout-btn{ 
            width:100%; 
            padding:15px; 
            border-radius:99px; 
            font-weight:800; 
            font-size:16px; 
            border:0; 
            cursor:pointer;
            background: linear-gradient(90deg,#25D366,#128C7E); 
            color:#fff;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav{
            position:fixed; bottom:0; left:0; right:0; background:#fff;
            display:flex; flex-wrap: nowrap; justify-content:space-around; align-items:center;
            border-top:1px solid #eee; z-index:100; padding: 0 0 0 0;
            transition: height 0.3s ease, padding 0.3s ease;
        }
        .nav-home-mode { height: 55px; }
        .nav-cart-mode { 
            height: 150px; 
            align-items: flex-start; 
            padding-top: 10px;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
        }
        .nav-item{ 
            display:flex; flex-direction:column; align-items:center; gap:3px; color:#ccc; 
            font-size:10px; font-weight:500; width:50%; padding:6px 0; cursor:pointer;
        }
        .nav-item.active{ color:var(--secondary-color); font-weight:700; }
        .nav-badge{ position:absolute; top:6px; margin-right:-12px; background:var(--main-color); color:#fff; font-size:9px; padding:2px 6px; border-radius:10px; border:1px solid #fff; }
        .cart-actions-bar { 
            display: flex; 
            gap: 10px; 
            padding: 15px; 
            width: 100%; 
            background: #fff;
            border-top: 1px solid #eee;
        }

        /* Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
        #quickView{ 
            position: fixed;
            inset: 0;
            background: rgba(0, 31, 63, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .quick-view-img-wrapper{ 
            width:100%; 
            padding-top:100%; 
            position:relative; 
            overflow:hidden; 
            background: #fff;
            border-radius: var(--radius) var(--radius) 0 0;
        }
        .quick-view-img-wrapper img{ 
            position:absolute; 
            inset:0; 
            width:100%; 
            height:100%; 
            object-fit:cover; 
        }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª */
        .size-option-btn {
            transition: all 0.3s ease;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }
        
        .size-option-btn:hover {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        
        .size-option-btn.selected {
            background: var(--secondary-color) !important;
            border-color: var(--secondary-color) !important;
            color: #fff !important;
            font-weight: 700 !important;
        }
        
        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ */
        #scrollTopBtn{ 
            position:fixed; 
            bottom:70px; 
            right:15px; 
            width:40px; 
            height:40px; 
            background:var(--main-color); 
            color:#fff; 
            border-radius:50%; 
            display:none; 
            justify-content:center; 
            align-items:center; 
            cursor:pointer; 
            z-index:99; 
            box-shadow:0 3px 10px rgba(0,31,63,0.3);
            font-size:18px;
            font-weight:bold;
        }

        /* Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®ØµÙ… Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ */
        .discount-notification {
            position: fixed;
            top: 160px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--secondary-color), #ff6b00);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(255, 140, 0, 0.4);
            animation: slideIn 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
            text-align: center;
            max-width: 90%;
        }
        
        @keyframes slideIn {
            from { top: -100px; opacity: 0; }
            to { top: 160px; opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        @keyframes loading {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* ØªØ£Ø«ÙŠØ± fade-in Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* ğŸ”¥ğŸ”¥ Dark mode CSS ğŸ”¥ğŸ”¥ */
        .dark body{ background:#001226; color:#e6e6e6; }
        .dark header{ background: rgba(0, 31, 63, 0.98); }
        .dark #darkToggle, .dark #currencyToggle, .dark #cartToggle { 
            background: #00254d; 
            color: #fff; 
            border-color: #1a3a5c; 
        }
        .dark #cartToggle {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        .dark .name{ color: #fff; }
        .dark .price, .dark .currency{ color: var(--secondary-color); }
        .dark .card, .dark .cart-item{ background:#001a35; box-shadow:0 2px 8px rgba(0,0,0,0.6); border-color: #1a3a5c; }
        .dark .cart-item-name { color: #fff; }
        .dark .search-input-wrapper{ background:#00254d; border:1px solid #1a3a5c; }
        .dark .search-input { color: #fff; }
        .dark .categories-wrapper{ border-top-color:#1a3a5c; }
        .dark .bottom-nav{ background:#001a35; border-top-color:#1a3a5c; }
        .dark .shipping-box, .dark .cart-summary{ background:#00254d; border:1px solid #1a3a5c; }
        .dark .quick-view-img-wrapper { background: #001a35; }
        .dark .cart-qty-controls { background: #00254d; }
        .dark .qty-btn { background: #001a35; border-color: #1a3a5c; color: #fff; }
        .dark .discount-box { background: rgba(255, 140, 0, 0.05); border-color: var(--secondary-color); }
        .dark #cartItemsScrollable::-webkit-scrollbar-track { background: #1a3a5c; }
        .dark #cartItemsScrollable::-webkit-scrollbar-thumb { background: var(--secondary-color); }
        .dark .image-placeholder {
            background: linear-gradient(90deg, #1a3a5c 25%, #00254d 50%, #1a3a5c 75%);
        }
        
        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Ù‡ÙŠØ§ÙƒÙ„ Ø¹Ø¸Ù…ÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .skeleton {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
            height: 320px;
            border: 1px solid #f0f0f0;
        }
        .skeleton-image {
            width: 100%;
            padding-top: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        .skeleton-body { padding: 12px 10px; }
        .skeleton-line { 
            height: 14px; 
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); 
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            margin-bottom: 8px; 
            border-radius: 4px; 
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            #cartItemsScrollable {
                max-height: calc(100vh - 350px);
            }
            
            .checkout-btn {
                padding: 16px;
                font-size: 16px;
            }
            
            .cart-item {
                flex-direction: column;
                gap: 15px;
            }
            
            .cart-qty-controls {
                align-self: flex-start;
                width: 100%;
                justify-content: center;
            }
            
            #currencyToggle {
                left: 130px;
            }
            
            #cartToggle {
                padding: 6px 10px;
                font-size: 10px;
            }
            
            #cartToggle .cart-total {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            #darkToggle {
                left: 10px;
                font-size: 10px;
                padding: 4px 8px;
            }
            
            #currencyToggle {
                left: 40px;
                font-size: 10px;
                padding: 4px 8px;
            }
            
            #cartToggle {
                right: 10px;
                font-size: 10px;
                padding: 4px 8px;
            }
        }
        
        /* Responsive */
        @media(min-width:800px){ 
            .products-grid{ grid-template-columns: repeat(4, 1fr); } 
        }
    </style>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <header>
        <button id="darkToggle" title="ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™</button>
        <button id="currencyToggle" onclick="toggleCurrency()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø©">Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ</button>
        <button id="cartToggle" onclick="switchTab('cart')" title="Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©">
            ğŸ›’ <span class="cart-total">0 Ø±.ÙŠ</span>
        </button>

        <div class="top-bar">
            <img src="logo.png" alt="Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©" class="store-logo" onclick="switchTab('home')" style="cursor:pointer;">
        </div>
        
        <div class="search-container">
            <div class="search-input-wrapper" role="search">
                <span style="font-size:16px; color:var(--secondary-color)">ğŸ”</span>
                <input id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø£Ùˆ ØªØµÙ†ÙŠÙ..." oninput="handleSearch(this.value)" />
                <button id="clearSearch" style="border:0;background:transparent;cursor:pointer;font-weight:700;display:none; color:#999">âœ–</button>
            </div>
        </div>
        
        <div class="categories-wrapper" id="categoriesBar" aria-label="Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª">
        </div>
    </header>

    <main>
        <div id="homeView" class="view-section active">
             <div class="hero-banner">
                <h2>Ø¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ©</h2>
                <p>ØªØ³ÙˆÙ‚ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</p>
            </div>

            <div id="productsGrid" class="products-grid">
                <!-- Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠØ© ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
            
            <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...
            </div>
            
            <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ -->
            <div id="loadMoreContainer" class="load-more-container" style="display: none;">
                <button class="load-more-btn" onclick="loadMoreProducts()">
                    ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </button>
            </div>
        </div>

        <div id="cartView" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding: 0 5px;">
                <button onclick="switchTab('home')" style="background:none; border:none; color:var(--main-color); font-size:14px; font-weight:700; cursor:pointer; padding: 0;"> â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø± </button>
                <div style="display:flex; align-items:center; gap: 15px;">
                    <h3 style="margin:0; font-size:16px; color:var(--main-color)">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h3>
                    <button onclick="clearCart()" style="background:none; border:none; color:var(--danger); font-size:13px; font-weight:700; cursor:pointer;"> ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ÙƒÙ„ </button>
                </div>
            </div>
            
            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø±ÙŠØ± -->
            <div id="cartItemsScrollable" style="max-height: calc(100vh - 400px); overflow-y: auto; padding: 0 5px;">
                <div id="cartItems"></div>
            </div>
            
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ -->
            <div id="checkoutSection" style="display:none; position: sticky; bottom: 0; background: var(--bg-color); padding: 15px 0; border-top: 2px solid #f0f0f0; margin-top: 10px;">
                <div class="shipping-box">
                    <label style="font-weight:bold; font-size:13px; color:var(--main-color)">ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</label>
                    <select id="shippingSelect" class="shipping-select" onchange="renderCart()" style="border:none; background:transparent; font-weight:bold; color:var(--secondary-color); width:100%; padding: 5px 0;">
                        <option value="1000">Ø¯Ø§Ø®Ù„ ØµÙ†Ø¹Ø§Ø¡ (+1,000 Ø±.ÙŠ)</option>
                        <option value="2000">Ù…Ø­Ø§ÙØ¸Ø© Ø£Ø®Ø±Ù‰ (+2,000 Ø±.ÙŠ)</option>
                    </select>
                </div>
                
                <!-- Ù‚Ø³Ù… ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… -->
                <div class="discount-box">
                    <label style="font-weight:bold; font-size:13px; color:var(--main-color); display:block; margin-bottom:8px;">ğŸ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…:</label>
                    <div style="display:flex; gap:8px;">
                        <input 
                            type="text" 
                            id="discountCodeInput" 
                            placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ù‡Ù†Ø§" 
                            style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px; font-family:'Tajawal'; font-size:14px;"
                            onkeyup="if(event.key==='Enter')applyDiscount()"
                        >
                        <button 
                            onclick="applyDiscount()" 
                            style="background:var(--secondary-color); color:white; border:none; border-radius:6px; padding:0 15px; font-weight:700; cursor:pointer; font-size:14px;"
                        >
                            ØªØ·Ø¨ÙŠÙ‚
                        </button>
                    </div>
                    <div id="discountMessage" style="font-size:12px; margin-top:5px; display:none;"></div>
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</span><span id="productsTotalDisplay">0</span>
                    </div>
                    
                    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø®ØµÙ… Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ -->
                    <div class="summary-row" id="gradualDiscountRow" style="display:none; color:#1976d2; font-weight:700;">
                        <span>ğŸ¯ Ø®ØµÙ… ØªØ¯Ø±ÙŠØ¬ÙŠ (<span id="gradualDiscountPercent">0%</span>):</span>
                        <span id="gradualDiscountDisplay">-0</span>
                    </div>
                    
                    <!-- Ø¹Ø±Ø¶ Ø®ØµÙ… Ø§Ù„ÙƒÙˆØ¯ -->
                    <div class="summary-row" id="codeDiscountRow" style="display:none; color:var(--danger); font-weight:700;">
                        <span>ğŸ Ø®ØµÙ… Ø§Ù„ÙƒÙˆØ¯ (<span id="codeDiscountCode">ÙƒÙˆØ¯</span>):</span>
                        <span id="codeDiscountDisplay">-0</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</span><span id="shippingDisplay">0</span>
                    </div>
                    <div class="total-row">
                        <span style="color:var(--main-color)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span><span class="final-price" id="finalTotalDisplay">0</span>
                    </div>
                </div>
                
                <!-- Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø«Ø§Ø¨Øª ÙˆÙ…Ø«Ø¨Øª -->
                <div style="margin-top: 15px; position: sticky; bottom: 0;">
                    <button class="checkout-btn" onclick="sendCart()" style="width:100%; padding:18px; font-size:18px; position: relative; z-index: 1000;">
                        ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
                </div>
            </div>
            
            <div class="empty-state" id="emptyCartMsg" style="display:none; text-align:center; padding:40px; color:#999;">
                <div style="font-size:50px;margin-bottom:10px; opacity:0.3">ğŸ›’</div>
                Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚!
            </div>
        </div>
    </main>

    <div id="quickView" onclick="if(event.target.id==='quickView')closeQuickView()">
        <div id="quickViewBox"></div>
    </div>

    <div id="scrollTopBtn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">â†‘</div>

    <div class="bottom-nav nav-home-mode">
        <div id="homeNavBarContent" style="display:flex; width:100%;">
            <div class="nav-item active" onclick="switchTab('home')">
                <svg viewBox="0 0 24 24" width="22" height="22"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="currentColor"/></svg>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </div>
            <div class="nav-item" onclick="switchTab('cart')" style="position:relative">
                <div class="nav-badge" id="cartBadge" style="display:none">0</div>
                <svg viewBox="0 0 24 24" width="22" height="22"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" fill="currentColor"/></svg>
                <span>Ø§Ù„Ø³Ù„Ø©</span>
            </div>
        </div>
        <div id="cartActionBarContent" class="cart-actions-bar" style="display:none;">
            <button class="checkout-btn" onclick="sendCart()">ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>
    </div>

    <script>
        /* ====================== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØµØ­ÙŠØ­ ====================== */
        console.log('=== Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Egress ===');
        console.log('ğŸš€ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØµÙˆØ± ØªØªØ­Ù…Ù‘Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Storage Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… API');
        console.log('ğŸ¯ Progressive Image Loading Ù…Ø¹ IntersectionObserver');

        /* ====================== Global state ====================== */
        const WHATSAPP = "967773266534";
        const SAR_RATE = 140;
        
        const SUPABASE_URL = 'https://mpcuradmirhcfmwvsylt.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_MJRUl3ON-d61CnFsJ-pFJA_Nbbpg_gZ';
        
        let sb;

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
        async function testSupabaseConnection() {
            try {
                if (sb) {
                    console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...');
                    const { data, error } = await sb.from('products').select('id').limit(1);
                    
                    if (error) {
                        console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                        return false;
                    }
                    
                    console.log('âœ… Ø§ØªØµØ§Ù„ Supabase Ù†Ø§Ø¬Ø­');
                    return true;
                } else {
                    console.error('âŒ Supabase ØºÙŠØ± Ù…Ù‡ÙŠØ£');
                    return false;
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                return false;
            }
        }

        try {
            if (typeof supabase !== 'undefined') {
                sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: false
                    },
                    global: {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY
                        }
                    }
                });
                console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Supabase Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                console.error('âŒ Ù…ÙƒØªØ¨Ø© Supabase ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©');
            }
        } catch (error) {
            console.error("ğŸš¨ Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Supabase:", error);
        }
        
        window.allProducts = window.allProducts || [];
        let cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
        let currentFilter = "all";
        let currentCurrency = localStorage.getItem('currentCurrency') || 'YER';

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®ØµÙ…
        window.gradualDiscount = {
            segments: [],
            isActive: false
        };

        let discountCodes = {
            'WELCOME10': { type: 'percentage', value: 10, minPurchase: 0, used: false },
            'SAVE20': { type: 'percentage', value: 20, minPurchase: 50000, used: false },
            'FIXED5000': { type: 'fixed', value: 5000, minPurchase: 30000, used: false },
            'SUMMER15': { type: 'percentage', value: 15, minPurchase: 0, used: false }
        };

        let appliedDiscount = null;
        let appliedDiscountCode = '';
        let lastDiscountNotificationTime = 0;
        let currentPage = 1;
        const productsPerPage = 200;
        let hasMoreProducts = true;
        let isLoadingProducts = false;
        
        const grid = document.getElementById("productsGrid");
        const cartItemsContainer = document.getElementById("cartItems");
        const cartBadge = document.getElementById("cartBadge");
        const emptyCartMsg = document.getElementById("emptyCartMsg");
        const checkoutSection = document.getElementById("checkoutSection");
        const bottomNav = document.querySelector('.bottom-nav');
        const homeNavBarContent = document.getElementById('homeNavBarContent');
        const cartActionBarContent = document.getElementById('cartActionBarContent');
        const currencyToggleBtn = document.getElementById('currencyToggle');
        const cartToggleBtn = document.getElementById('cartToggle');
        const cartTotalSpan = cartToggleBtn.querySelector('.cart-total');
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        const productsTotalDisplay = document.getElementById("productsTotalDisplay");
        const gradualDiscountRow = document.getElementById("gradualDiscountRow");
        const gradualDiscountPercent = document.getElementById("gradualDiscountPercent");
        const gradualDiscountDisplay = document.getElementById("gradualDiscountDisplay");
        const codeDiscountRow = document.getElementById("codeDiscountRow");
        const codeDiscountCode = document.getElementById("codeDiscountCode");
        const codeDiscountDisplay = document.getElementById("codeDiscountDisplay");
        const shippingDisplay = document.getElementById("shippingDisplay");
        const finalTotalDisplay = document.getElementById("finalTotalDisplay");
        const shippingSelect = document.getElementById("shippingSelect");
        const scrollBtn = document.getElementById("scrollTopBtn");
        const quickViewEl = document.getElementById("quickView");
        const quickViewBox = document.getElementById("quickViewBox");
        const searchInput = document.getElementById("searchInput");
        const clearSearch = document.getElementById("clearSearch");
        const darkToggle = document.getElementById("darkToggle");
        const mainHeader = document.querySelector('header');
        const discountCodeInput = document.getElementById('discountCodeInput');
        const discountMessage = document.getElementById('discountMessage');
        
        let lastScrollTop = 0;
        const headerHeight = 145;
        let renderTimeout = null;

        /* ====================== Ù†Ø¸Ø§Ù… Progressive Image Loading ====================== */
        let imageObserver = null;
        const imageCache = new Set();
        let scrollTimer;

        // ØªÙ‡ÙŠØ¦Ø© IntersectionObserver Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙˆØ±
        function initImageObserver() {
            if (imageObserver) return;
            
            imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImage(img);
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '100px 0px',
                threshold: 0.01
            });
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        function loadImage(img) {
            const src = img.getAttribute('data-src');
            if (!src) return;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
            if (imageCache.has(src)) {
                img.src = src;
                img.classList.add('loaded');
                return;
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            const tempImg = new Image();
            tempImg.onload = () => {
                img.src = src;
                img.classList.add('loaded');
                img.classList.add('fade-in');
                imageCache.add(src);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ placeholder Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
                setTimeout(() => {
                    const placeholder = img.parentNode.querySelector('.image-placeholder');
                    if (placeholder) {
                        placeholder.style.opacity = '0';
                        setTimeout(() => {
                            placeholder.style.display = 'none';
                        }, 300);
                    }
                }, 100);
            };
            
            tempImg.onerror = () => {
                img.classList.add('error');
                console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:', src);
            };
            
            tempImg.src = src;
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function observeImages() {
            if (!imageObserver) initImageObserver();
            
            document.querySelectorAll('.product-img.lazy:not([src])').forEach(img => {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ viewport Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø­Ù…Ù„Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
                const rect = img.getBoundingClientRect();
                const isInViewport = (
                    rect.top <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.bottom >= 0 &&
                    rect.left <= (window.innerWidth || document.documentElement.clientWidth) &&
                    rect.right >= 0
                );
                
                if (isInViewport) {
                    loadImage(img);
                } else {
                    imageObserver.observe(img);
                }
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(observeImages, 100);
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.addEventListener('resize', observeImages);

        /* ====================== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ====================== */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        /* ====================== Utils ====================== */
        function saveCart(){ 
            localStorage.setItem("cart", JSON.stringify(cart)); 
            updateCartTotalDisplay();
        }
        
        function getHashNumber(str){ 
            let hash=0;
            for(let i=0;i<str.length;i++){
                hash = str.charCodeAt(i) + ((hash<<5)-hash);
            }
            return Math.abs(hash);
        }

        // âœ… Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Storage Ù…Ø¨Ø§Ø´Ø±
        function getProductImageUrl(imagePath) {
            if (!imagePath) return null;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø§Ù„ÙØ¹Ù„ Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„ØŒ Ø£Ø±Ø¬Ø¹ ÙƒÙ…Ø§ Ù‡Ùˆ
            if (typeof imagePath === 'string' && imagePath.startsWith('http')) {
                return imagePath;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØµÙÙˆÙØ©ØŒ Ø®Ø° Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙˆÙ„
            if (Array.isArray(imagePath) && imagePath.length > 0) {
                const firstImage = imagePath[0];
                if (firstImage && typeof firstImage === 'string' && firstImage.startsWith('http')) {
                    return firstImage;
                }
                imagePath = firstImage;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø§Ø±Ø§Ù‹ Ø£Ùˆ Ø§Ø³Ù… Ù…Ù„ÙØŒ Ø­ÙˆÙ‘Ù„Ù‡ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Storage Ù…Ø¨Ø§Ø´Ø±
            const baseUrl = 'https://mpcuradmirhcfmwvsylt.supabase.co/storage/v1/object/public';
            
            // ØªØ£ÙƒØ¯ Ø£Ù† imagePath Ù‡Ùˆ Ù†Øµ
            const pathStr = String(imagePath);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ / ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
            const cleanPath = pathStr.replace(/^\//, '');
            
            // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† bucket Ø§Ù„ØµÙˆØ± Ø§Ø³Ù…Ù‡ 'products'
            return `${baseUrl}/products/${cleanPath}`;
        }

        // âœ… Ø¯Ø§Ù„Ø© SVG Placeholder
        function getPlaceholderSVG() {
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f8f9fa'/%3E%3Ctext x='50' y='55' font-family='Tajawal' font-size='14' text-anchor='middle' fill='%23999'%3EğŸ–¼ï¸%3C/text%3E%3C/svg%3E";
        }

        function showMessage(text, type = 'info') {
            const msg = document.createElement('div');
            const bgColor = type === 'success' ? 'var(--success)' : 
                           type === 'error' ? 'var(--danger)' : 'var(--info)';
            
            msg.innerHTML = `
                <div style="position:fixed; top:60px; left:50%; transform:translateX(-50%); 
                           background:${bgColor}; color:white; padding:12px 20px; 
                           border-radius:8px; font-weight:700; z-index:1000; 
                           box-shadow:0 4px 15px rgba(0,0,0,0.2); animation:fadeIn 0.3s ease;">
                    ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'} ${text}
                </div>
            `;
            document.body.appendChild(msg);
            
            setTimeout(() => {
                msg.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                           background: rgba(255, 77, 77, 0.9); color: white; padding: 12px 20px; 
                           border-radius: 8px; font-weight: 700; z-index: 10000; 
                           box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3); animation: fadeIn 0.3s ease;">
                    âš ï¸ ${message}
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => errorDiv.remove(), 300);
            }, 5000);
        }

        function updateCartTotalDisplay() {
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            let totalAmount = 0;
            
            cart.forEach(item => {
                let rawPrice = (item.price || "").toString().replace(/[^0-9.]/g, '');
                let priceVal = parseFloat(rawPrice) || 0;
                totalAmount += priceVal * (item.qty || 0);
            });
            
            if (currentCurrency === 'SAR') {
                totalAmount = Math.ceil(totalAmount / SAR_RATE);
                cartTotalSpan.textContent = `${totalAmount.toLocaleString()} Ø±.Ø³`;
            } else {
                cartTotalSpan.textContent = `${totalAmount.toLocaleString()} Ø±.ÙŠ`;
            }
        }

        /* ====================== Currency Toggle Logic ====================== */
        function updateCurrencyDisplay() {
            currencyToggleBtn.textContent = currentCurrency === 'SAR' ? 'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ' : 'Ø±ÙŠØ§Ù„ ÙŠÙ…Ù†ÙŠ';
            updateCartTotalDisplay();
        }
        
        window.toggleCurrency = function() {
            currentCurrency = (currentCurrency === 'YER' ? 'SAR' : 'YER');
            localStorage.setItem('currentCurrency', currentCurrency);
            updateCurrencyDisplay();
            if (document.getElementById('homeView').classList.contains('active')) {
                renderProducts();
            } else if (document.getElementById('cartView').classList.contains('active')) {
                renderCart();
            }
            if (quickViewEl.style.display === 'flex' && quickViewBox.dataset.productId) {
                quickViewById(quickViewBox.dataset.productId);
            }
        }
        updateCurrencyDisplay();

        /* ====================== Scroll hide header ====================== */
        window.addEventListener('scroll', throttle(function(){
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if(scrollTop <= headerHeight / 2){
                mainHeader.classList.remove('header-hidden');
                lastScrollTop = scrollTop;
                scrollBtn.style.display = scrollTop > 400 ? "flex" : "none";
                return;
            }
            if(scrollTop > lastScrollTop) mainHeader.classList.add('header-hidden');
            else mainHeader.classList.remove('header-hidden');
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            scrollBtn.style.display = scrollTop > 400 ? "flex" : "none";
        }, 100), { passive:true });
        
        scrollBtn.onclick = () => window.scrollTo({ top:0, behavior:'smooth' });

        /* ====================== Dark mode ====================== */
        darkToggle.onclick = () => {
            document.documentElement.classList.toggle('dark');
            const on = document.documentElement.classList.contains('dark');
            localStorage.setItem('dark', on ? '1' : '0');
            darkToggle.textContent = on ? 'â˜€ï¸' : 'ğŸŒ™';
        };
        if(localStorage.getItem('dark') === '1'){
            document.documentElement.classList.add('dark');
            darkToggle.textContent = 'â˜€ï¸';
        }

        /* ====================== Tabs ====================== */
        function switchTab(tab){
            document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
            const headerEl = document.querySelector('header');

            if(tab === 'home'){
                document.getElementById('homeView').classList.add('active');
                document.querySelector('.nav-item:first-child').classList.add('active');
                renderProducts();
                cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
                updateCartBadge();
                updateCartTotalDisplay();
                
                bottomNav.classList.remove('nav-cart-mode');
                bottomNav.classList.add('nav-home-mode');
                homeNavBarContent.style.display = 'flex';
                cartActionBarContent.style.display = 'none';
                
                if (headerEl) headerEl.style.display = 'block';
                document.body.style.paddingTop = 'var(--total-header-height)';
                document.body.style.paddingBottom = '100px'; 
            } 
            else if(tab === 'cart'){
                document.getElementById('cartView').classList.add('active');
                document.querySelector('.nav-item:last-child').classList.add('active');
                cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
                renderCart();
                updateCartTotalDisplay();
                
                bottomNav.classList.remove('nav-home-mode');
                bottomNav.classList.add('nav-cart-mode');
                homeNavBarContent.style.display = 'none';
                
                if (headerEl) headerEl.style.display = 'none';
                document.body.style.paddingTop = '0px';
                document.body.style.paddingBottom = '160px';
            }
            window.scrollTo({top:0, behavior:'smooth'});
        }

        /* ====================== ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ====================== */
        window.openProductPage = function(productId) {
            const product = window.allProducts.find(p => p.id == productId);
            if (product) {
                localStorage.setItem('allProducts', JSON.stringify(window.allProducts));
                localStorage.setItem('currentProduct_' + productId, JSON.stringify(product));
                window.location.href = `product.html?id=${productId}`;
            } else {
                console.error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', productId);
                alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹');
            }
        }

        /* ====================== Search ====================== */
        function normalizeStr(s){
            if(!s) return "";
            return s.toString().toLowerCase().trim();
        }
        
        const handleSearchDebounced = debounce(function(q){
            clearSearch.style.display = q ? "inline-block" : "none";
            if(!window.allProducts || !window.allProducts.length){
                return; 
            }
            if(!q){
                renderProducts();
                return;
            }
            const nq = normalizeStr(q);
            const items = window.allProducts.filter(p => {
                const name = normalizeStr(p.name || p.title || "");
                const cat = normalizeStr(p.category || "");
                const code = normalizeStr(p.id || "");
                return name.includes(nq) || cat.includes(nq) || code.includes(nq);
            });
            drawItems(items);
        }, 300);
        
        window.handleSearch = function(q) {
            handleSearchDebounced(q);
        };
        
        clearSearch.onclick = () => {
            searchInput.value='';
            handleSearch('');
        };

        /* ====================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª ====================== */
        function getMinimumPriceFromSizes(sizes) {
            if (!sizes || !Array.isArray(sizes) || sizes.length === 0) {
                return null;
            }
            
            let minPrice = Infinity;
            let hasValidPrice = false;
            
            sizes.forEach(size => {
                if (size && size.price && !isNaN(parseFloat(size.price))) {
                    const price = parseFloat(size.price);
                    if (price < minPrice) {
                        minPrice = price;
                        hasValidPrice = true;
                    }
                }
            });
            
            return hasValidPrice ? minPrice : null;
        }

        function displayProductPrice(product, displayCurrency) {
            let priceHTML = '';
            
            const hasSizes = product.sizes && Array.isArray(product.sizes) && product.sizes.length > 0;
            
            if (hasSizes) {
                const minPrice = getMinimumPriceFromSizes(product.sizes);
                
                if (minPrice !== null) {
                    let displayPrice = minPrice;
                    if (currentCurrency === 'SAR') {
                        displayPrice = Math.ceil(minPrice / SAR_RATE);
                    }
                    
                    priceHTML = `
                        <div class="price-area">
                            <span class="currency">${displayCurrency}</span>
                            <span class="price">${displayPrice.toLocaleString('en-US')}</span>
                            <span style="font-size: 12px; color: #666; margin-right: 5px;">(ÙŠØ¨Ø¯Ø£ Ù…Ù†)</span>
                        </div>
                    `;
                } else {
                    let displayPrice = parseFloat(product.price) || 0;
                    if (currentCurrency === 'SAR') {
                        displayPrice = Math.ceil(displayPrice / SAR_RATE);
                    }
                    
                    priceHTML = `
                        <div class="price-area">
                            <span class="currency">${displayCurrency}</span>
                            <span class="price">${displayPrice.toLocaleString('en-US')}</span>
                        </div>
                    `;
                }
            } else {
                let displayPrice = parseFloat(product.price) || 0;
                if (currentCurrency === 'SAR') {
                    displayPrice = Math.ceil(displayPrice / SAR_RATE);
                }
                
                priceHTML = `
                    <div class="price-area">
                        <span class="currency">${displayCurrency}</span>
                        <span class="price">${displayPrice.toLocaleString('en-US')}</span>
                    </div>
                `;
            }
            
            return priceHTML;
        }

        /* ====================== Render & Draw ====================== */
        // âœ… âœ… âœ… Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‡ÙŠØ§ÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠØ©
        function showSkeletons() {
            grid.innerHTML = "";
            
            // Ø¥Ù†Ø´Ø§Ø¡ 8 Ù‡ÙŠØ§ÙƒÙ„ Ø¹Ø¸Ù…ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
            for (let i = 0; i < 8; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton';
                skeleton.innerHTML = `
                    <div class="skeleton-image"></div>
                    <div class="skeleton-body">
                        <div class="skeleton-line" style="width: 80%"></div>
                        <div class="skeleton-line" style="width: 60%"></div>
                        <div class="skeleton-line" style="width: 40%"></div>
                    </div>
                `;
                grid.appendChild(skeleton);
            }
        }

        window.renderProducts = function(){
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            
            renderTimeout = setTimeout(() => {
                let items = currentFilter === 'all' 
                    ? (window.allProducts || []) 
                    : (window.allProducts || []).filter(p => normalizeStr(p.category) === normalizeStr(currentFilter));
                
                items.sort((a, b) => {
                    if (a.created_at && b.created_at) {
                        return new Date(b.created_at) - new Date(a.created_at);
                    }
                    else if (a.updated_at && b.updated_at) {
                        return new Date(b.updated_at) - new Date(a.updated_at);
                    }
                    else {
                        return (b.id || '').localeCompare(a.id || '');
                    }
                });
                
                drawItems(items);
            }, 50);
        };
        
        window.filterProducts = function(cat, btn){
            document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = cat;
            searchInput.value = "";
            renderProducts();
        }

        function isProductNew(product) {
            if (!product.created_at && !product.updated_at) {
                return Math.random() > 0.5;
            }
            
            const productDate = product.updated_at || product.created_at;
            const productTime = new Date(productDate).getTime();
            const currentTime = new Date().getTime();
            const daysDiff = (currentTime - productTime) / (1000 * 60 * 60 * 24);
            
            return daysDiff <= 60;
        }

        let lastRenderedIds = "";
        function drawItems(items){
            grid.innerHTML = "";

            if(items.length === 0){
                grid.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ”</div>`;
                loadMoreContainer.style.display = 'none';
                return;
            }

            items.forEach((p, index) => {
                const card = createProductCard(p, index);
                grid.appendChild(card);
            });
            
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙˆØ± Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            setTimeout(() => {
                observeImages();
            }, 50);
            
            if (hasMoreProducts && items.length >= productsPerPage) {
                loadMoreContainer.style.display = 'block';
                loadingIndicator.style.display = 'none';
            } else {
                loadMoreContainer.style.display = 'none';
                loadingIndicator.style.display = 'none';
            }
        }

        // âœ… âœ… âœ… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØµÙˆØ±
        function createProductCard(p, globalIndex){
            const card = document.createElement('div');
            card.className = 'card';
            
            let rawPrice = (p.price || "").toString().replace(/[^0-9.]/g, '');
            let priceVal = parseFloat(rawPrice) || 0;
            let fakeOldPrice = Math.floor(priceVal * 1.3);

            let displayPrice = priceVal;
            let displayOld = fakeOldPrice;
            let displayCurrency = 'Ø±.ÙŠ';
            if (currentCurrency === 'SAR') {
                displayPrice = Math.ceil(priceVal / SAR_RATE);
                displayOld = Math.ceil(fakeOldPrice / SAR_RATE);
                displayCurrency = 'Ø±.Ø³';
            }

            // âœ… âœ… âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØµÙˆØ±
            let imgTag = '';
            if (p.image) {
                const imageUrl = getProductImageUrl(p.image);
                if (imageUrl) {
                    imgTag = `
                        <div class="image-placeholder"></div>
                        <img 
                            data-src="${imageUrl}"
                            alt="${p.name||''}" 
                            class="product-img lazy"
                            loading="lazy"
                            decoding="async"
                            onerror="this.onerror=null; this.classList.add('error');"
                        >
                    `;
                } else {
                    imgTag = `
                        <div class="image-placeholder"></div>
                        <img 
                            src="${getPlaceholderSVG()}" 
                            alt="${p.name||''}" 
                            class="product-img"
                        >
                    `;
                }
            } else {
                imgTag = `
                    <div class="image-placeholder"></div>
                    <img 
                        src="${getPlaceholderSVG()}" 
                        alt="${p.name||''}" 
                        class="product-img"
                    >
                `;
            }

            const hash = getHashNumber(p.id || Math.random().toString(36).slice(2));
            const soldCount = (hash % 901) + 100;
            
            const isNew = isProductNew(p);
            
            const imageWrapper = `
                <div class="card-image-wrapper" data-id="${p.id}" onclick="openProductPage('${p.id}')">
                    ${imgTag}
                    ${isNew ? '<div class="new-badge">Ø¬Ø¯ÙŠØ¯</div>' : ''}
                    <div class="add-fab" title="Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©" onclick="event.stopPropagation(); handleAddToCart('${p.id}');">+</div>
                </div>
            `;
            
            const priceHTML = displayProductPrice(p, displayCurrency);
            
            const actionBtns = `
                <div class="action-btns-wrapper">
                    <button style="flex:1; border-radius:8px; border:1px solid var(--main-color); background:#fff; color:var(--main-color); cursor:pointer; padding:8px;" 
                            onclick="event.stopPropagation(); window.quickViewById('${p.id}')">
                        ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø³Ø±ÙŠØ¹Ø©
                    </button>
                    <button style="flex:1; border-radius:8px; border:0; background:var(--main-color); color:#fff; cursor:pointer; padding:8px;" 
                            onclick="event.stopPropagation(); handleAddToCart('${p.id}')">
                        Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                    </button>
                </div>
            `;
            
            card.innerHTML = `
                ${imageWrapper}
                <div class="card-body" onclick="openProductPage('${p.id}')">
                    <div class="name">${p.name || 'Ù…Ù†ØªØ¬'}</div>
                    ${priceHTML}
                    <div style="display:flex; align-items:center; margin-top:6px;">
                        <span class="old-price-small">${displayOld.toLocaleString()} ${displayCurrency}</span>
                        <span class="discount-tag">-30%</span>
                    </div>
                    <div class="extra-info">ØªÙ… Ø¨ÙŠØ¹ ${soldCount}+ Ù‚Ø·Ø¹Ø©</div>
                    ${actionBtns}
                </div>
            `;
            return card;
        }

        /* ====================== Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ====================== */
        // âœ… âœ… âœ… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±ÙˆØ§Ø¨Ø· Storage Ù…Ø¨Ø§Ø´Ø±Ø©
        function quickView(product){
            const imgs = Array.isArray(product.image) ? product.image : [];
            const hasRealImage = imgs.length > 0 && imgs[0] !== null;

            const hasSizes = product.sizes && Array.isArray(product.sizes) && product.sizes.length > 0;
            let selectedSize = null;
            let selectedPrice = parseFloat(product.price) || 0;
            
            if (hasSizes) {
                const minPrice = getMinimumPriceFromSizes(product.sizes);
                if (minPrice !== null) {
                    selectedPrice = minPrice;
                }
            }
            
            let displayPrice = selectedPrice;
            let displayCurrency = 'Ø±.ÙŠ';

            if (currentCurrency === 'SAR') {
                displayPrice = Math.ceil(selectedPrice / SAR_RATE);
                displayCurrency = 'Ø±.Ø³';
            }

            const isNew = isProductNew(product);
            
            // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            let quickViewImage = '';

            if (product.image) {
                const imageUrl = getProductImageUrl(product.image);

                if (imageUrl) {
                    quickViewImage = `
                        <img 
                            id="quickViewImg"
                            src="${imageUrl}"
                            alt="${product.name || ''}"
                            class="quickview-img"
                            loading="eager"
                            decoding="async"
                            onerror="this.onerror=null; this.src='${getPlaceholderSVG()}';"
                        >
                    `;
                }
            }
            
            let sizesHTML = '';
            if (hasSizes) {
                sizesHTML = `
                    <div style="margin: 15px 0; border-top: 1px solid #eee; padding-top: 15px;">
                        <div style="font-weight: 700; color: var(--main-color); margin-bottom: 10px; font-size: 14px;">
                            <i class="fas fa-ruler-combined"></i> Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³:
                        </div>
                        <div id="quickViewSizes" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                            ${product.sizes.map((size, index) => {
                                const sizePrice = parseFloat(size.price) || 0;
                                let displaySizePrice = sizePrice;
                                if (currentCurrency === 'SAR') {
                                    displaySizePrice = Math.ceil(sizePrice / SAR_RATE);
                                }
                                
                                return `
                                    <button class="size-option-btn" 
                                            data-size-index="${index}"
                                            data-size-name="${size.name || ''}"
                                            data-size-price="${sizePrice}"
                                            onclick="selectQuickViewSize('${product.id}', ${index}, '${size.name || ''}', ${sizePrice})"
                                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                        ${size.name || 'Ù…Ù‚Ø§Ø³'} - ${displaySizePrice.toLocaleString('en-US')} ${displayCurrency}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                        <div id="sizeSelectionMessage" style="font-size: 12px; color: #666; margin-bottom: 10px; display: none;">
                            âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§Ø³ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©
                        </div>
                    </div>
                `;
            }
            
            let addToCartButtonHTML = '';
            if (hasSizes) {
                addToCartButtonHTML = `
                    <button id="quickViewAddToCartBtn" 
                            style="width:100%; padding:12px; border-radius:8px; border:0; background:#ccc; color:#666; font-weight:800; font-size:16px; cursor:not-allowed;"
                            onclick="addSelectedSizeToCart('${product.id}')"
                            disabled>
                        Ø§Ø®ØªØ± Ù…Ù‚Ø§Ø³Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
                    </button>
                `;
            } else {
                addToCartButtonHTML = `
                    <button style="width:100%; padding:12px; border-radius:8px; border:0; background:var(--secondary-color); color:#fff; font-weight:800; font-size:16px; cursor:pointer;" 
                            onclick="addToCart('${product.id}'); closeQuickView(); showAddedToCartMessage('${product.name}');">
                        Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                    </button>
                `;
            }

            quickViewBox.innerHTML = `
                <div style="position:relative; background:white; border-radius:var(--radius); max-width:95vw; width:350px; max-height:85vh; overflow-y:auto; animation:zoomIn .15s ease forwards; margin:auto;">
                    <button onclick="closeQuickView()" style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.3); color:white; border:none; border-radius:50%; width:30px; height:30px; font-size:16px; cursor:pointer; z-index:10;">âœ•</button>
                    <div class="quick-view-img-wrapper">
                        ${quickViewImage}
                        ${isNew ? '<div class="new-badge">Ø¬Ø¯ÙŠØ¯</div>' : ''}
                    </div>
                    <div style="padding:16px;">
                        <h3 style="margin:0 0 10px 0; color:var(--main-color); font-size:16px;">${product.name || ''}</h3>
                        <div id="quickViewPrice" style="font-size:22px; color:var(--secondary-color); font-weight:800; margin-bottom:15px;">
                            ${displayPrice.toLocaleString('en-US')} ${displayCurrency}
                            ${hasSizes ? '<span style="font-size: 14px; color: #666;">(ÙŠØ¨Ø¯Ø£ Ù…Ù†)</span>' : ''}
                        </div>
                        <div style="color:#666; font-size:14px; line-height:1.5; margin-bottom:20px;">${product.description || 'Ù…Ù†ØªØ¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©'}</div>
                        
                        ${sizesHTML}
                        
                        <div style="margin-top:20px; display:flex; gap:10px; flex-direction:column;">
                            ${addToCartButtonHTML}
                            <button style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--main-color); background:#fff; color:var(--main-color); font-weight:700; font-size:16px; cursor:pointer;" 
                                    onclick="openProductPage('${product.id}');">
                                Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ù†ØªØ¬
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            quickViewBox.dataset.productId = product.id;
            quickViewBox.dataset.productName = product.name || '';
            quickViewBox.dataset.hasSizes = hasSizes;
            quickViewBox.dataset.selectedSizeIndex = '-1';
            quickViewBox.dataset.selectedSizeName = '';
            quickViewBox.dataset.selectedSizePrice = selectedPrice;
            
            quickViewEl.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        window.quickViewById = function(id){
            const p = (window.allProducts || []).find(x => x.id === id);
            if(!p) return quickView({ id, name: 'Ù…Ù†ØªØ¬', price: 0, image: null });
            quickView(p);
            
            // ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙÙˆØ±Ø§Ù‹
            setTimeout(() => {
                const quickViewImg = document.getElementById('quickViewImg');
                if (quickViewImg && quickViewImg.classList.contains('lazy')) {
                    loadImage(quickViewImg);
                }
            }, 100);
        }

        window.closeQuickView = function(){
            quickViewEl.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        window.selectQuickViewSize = function(productId, sizeIndex, sizeName, sizePrice) {
            document.querySelectorAll('.size-option-btn').forEach(btn => {
                btn.style.background = '#fff';
                btn.style.borderColor = '#ddd';
                btn.style.color = '#333';
                btn.style.fontWeight = 'normal';
            });
            
            const selectedBtn = document.querySelector(`.size-option-btn[data-size-index="${sizeIndex}"]`);
            if (selectedBtn) {
                selectedBtn.style.background = 'var(--secondary-color)';
                selectedBtn.style.borderColor = 'var(--secondary-color)';
                selectedBtn.style.color = '#fff';
                selectedBtn.style.fontWeight = '700';
            }
            
            let displayPrice = sizePrice;
            let displayCurrency = 'Ø±.ÙŠ';
            if (currentCurrency === 'SAR') {
                displayPrice = Math.ceil(sizePrice / SAR_RATE);
                displayCurrency = 'Ø±.Ø³';
            }
            
            document.getElementById('quickViewPrice').innerHTML = `
                ${displayPrice.toLocaleString('en-US')} ${displayCurrency}
                <span style="font-size: 14px; color: #666;">(Ø§Ù„Ù…Ù‚Ø§Ø³: ${sizeName})</span>
            `;
            
            const addToCartBtn = document.getElementById('quickViewAddToCartBtn');
            if (addToCartBtn) {
                addToCartBtn.disabled = false;
                addToCartBtn.style.background = 'var(--secondary-color)';
                addToCartBtn.style.color = '#fff';
                addToCartBtn.style.cursor = 'pointer';
                addToCartBtn.textContent = `Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø© - ${displayPrice.toLocaleString('en-US')} ${displayCurrency}`;
            }
            
            const sizeMessage = document.getElementById('sizeSelectionMessage');
            if (sizeMessage) {
                sizeMessage.style.display = 'none';
            }
            
            quickViewBox.dataset.selectedSizeIndex = sizeIndex;
            quickViewBox.dataset.selectedSizeName = sizeName;
            quickViewBox.dataset.selectedSizePrice = sizePrice;
        };

        window.addSelectedSizeToCart = function(productId) {
            const hasSizes = quickViewBox.dataset.hasSizes === 'true';
            const selectedSizeIndex = parseInt(quickViewBox.dataset.selectedSizeIndex);
            
            if (hasSizes && selectedSizeIndex === -1) {
                const sizeMessage = document.getElementById('sizeSelectionMessage');
                if (sizeMessage) {
                    sizeMessage.style.display = 'block';
                    sizeMessage.style.color = 'var(--danger)';
                    sizeMessage.innerHTML = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§Ø³ Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©';
                }
                return;
            }
            
            const product = (window.allProducts || []).find(x => x.id == productId);
            if (!product) return;
            
            addToCartWithSize(productId, product.name || 'Ù…Ù†ØªØ¬', 
                             quickViewBox.dataset.selectedSizePrice, 
                             quickViewBox.dataset.selectedSizeName);
            
            closeQuickView();
            
            const sizeInfo = quickViewBox.dataset.selectedSizeName ? 
                            ` (Ø§Ù„Ù…Ù‚Ø§Ø³: ${quickViewBox.dataset.selectedSizeName})` : '';
            showAddedToCartMessage((product.name || 'Ù…Ù†ØªØ¬') + sizeInfo);
        };

        /* ====================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø© ====================== */
        window.addToCartWithSize = function(id, name, price, sizeName) {
            cart = JSON.parse(localStorage.getItem("cart") || "[]") || [];
            
            let itemIndex = cart.findIndex(p => p.id == id && p.sizeName == sizeName);
            
            if (itemIndex !== -1) {
                cart[itemIndex].qty = (cart[itemIndex].qty || 0) + 1;
            } else {
                cart.push({ 
                    id: id, 
                    name: name, 
                    price: price, 
                    qty: 1,
                    sizeName: sizeName || null,
                    hasSize: !!sizeName
                });
            }
            
            saveCart();
            updateCartBadge();
            updateCartTotalDisplay();
        };

        window.showAddedToCartMessage = function(productName){
            const msg = document.createElement('div');
            msg.innerHTML = `
                <div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:var(--secondary-color); color:white; padding:12px 20px; border-radius:8px; font-weight:700; z-index:1000; box-shadow:0 4px 15px rgba(255,140,0,0.3); animation:fadeIn 0.3s ease;">
                    âœ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${productName}" Ù„Ù„Ø³Ù„Ø©
                </div>
            `;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => msg.remove(), 300);
            }, 2000);
        }
        
        window.handleAddToCart = function(id) {
            cart = JSON.parse(localStorage.getItem("cart") || "[]") || [];
            
            const product = (window.allProducts || []).find(x => x.id == id);
            
            if (!product) {
                console.error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', id);
                return;
            }
            
            const hasSizes = product.sizes && Array.isArray(product.sizes) && product.sizes.length > 0;
            
            if (hasSizes) {
                quickView(product);
                
                setTimeout(() => {
                    const sizeMessage = document.getElementById('sizeSelectionMessage');
                    if (sizeMessage) {
                        sizeMessage.style.display = 'block';
                        sizeMessage.style.color = 'var(--info)';
                        sizeMessage.innerHTML = 'â„¹ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù‚Ø§Ø³Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§Ø³ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰';
                    }
                }, 300);
            } else {
                addToCartWithSize(id, product.name || 'Ù…Ù†ØªØ¬', product.price || "0", null);
                
                showAddedToCartMessage(product.name || 'Ù…Ù†ØªØ¬');
                
                if (navigator.vibrate) {
                    navigator.vibrate(40);
                }
            }
        };

        window.addToCart = function(id) {
            handleAddToCart(id);
        };

        window.changeQty = function(id, delta, sizeName){
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            
            let itemIndex = -1;
            if (sizeName) {
                itemIndex = cart.findIndex(i => i.id == id && i.sizeName == sizeName);
            } else {
                itemIndex = cart.findIndex(i => i.id == id && !i.sizeName);
            }
            
            if(itemIndex === -1) return;
            
            let item = cart[itemIndex];
            item.qty = (item.qty || 1) + delta;
            
            if(item.qty <= 0) {
                cart.splice(itemIndex, 1);
            }
            
            saveCart();
            renderCart();
            updateCartBadge();
            updateCartTotalDisplay();
        }

        window.clearCart = function(){
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ")) {
                cart = [];
                saveCart();
                appliedDiscount = null;
                appliedDiscountCode = '';
                localStorage.removeItem('appliedDiscount');
                renderCart();
                updateCartBadge();
                updateCartTotalDisplay();
            }
        }

        function updateCartBadge(){
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            let total = cart.reduce((acc,it)=> acc + (it.qty||0), 0);
            cartBadge.style.display = total > 0 ? "block" : "none";
            cartBadge.textContent = total > 99 ? '99+' : total;
        }

        /* ====================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø®ØµÙ… Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ ====================== */
        function loadGradualDiscountSettings() {
            try {
                const isActive = localStorage.getItem('gradualDiscountActive') === 'true';
                const savedSettingsRaw = localStorage.getItem('gradualDiscountSettings');
                
                if (savedSettingsRaw) {
                    const parsedData = JSON.parse(savedSettingsRaw);
                    window.gradualDiscount = {
                        segments: parsedData.segments || (parsedData.gradualDiscount && parsedData.gradualDiscount.segments) || [],
                        isActive: isActive,
                        alertMessage: parsedData.settings ? parsedData.settings.alertMessage : 'ÙƒÙ„Ù…Ø§ Ø²Ø§Ø¯Øª Ù…Ø´ØªØ±ÙŠØ§ØªÙƒØŒ Ø²Ø§Ø¯ Ø®ØµÙ…Ùƒ!'
                    };
                } else {
                    window.gradualDiscount = {
                        segments: [
                            { min: 10000, max: 15000, discount: 5, description: "Ø®ØµÙ… 5%" },
                            { min: 15001, max: 25000, discount: 10, description: "Ø®ØµÙ… 10%" },
                            { min: 25001, max: 100000, discount: 12, description: "Ø®ØµÙ… 12%" }
                        ],
                        isActive: true
                    };
                }

                const savedCodes = localStorage.getItem('discountCodes');
                if (savedCodes) {
                    discountCodes = JSON.parse(savedCodes);
                }

            } catch (e) {
                console.error('âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
            }
        }

        function calculateGradualDiscount(subtotal) {
            if (!window.gradualDiscount || !window.gradualDiscount.isActive || !window.gradualDiscount.segments) {
                return 0;
            }
            
            const segments = window.gradualDiscount.segments;
            let discountPercent = 0;

            segments.forEach(segment => {
                const min = parseFloat(segment.min);
                const max = (segment.max === null || segment.max === Infinity || segment.max === "") ? Infinity : parseFloat(segment.max);
                
                if (subtotal >= min && subtotal <= max) {
                    discountPercent = parseFloat(segment.discount);
                }
            });
            
            return discountPercent;
        }

        function showGradualDiscountNotification(discountPercentage) {
            if (discountPercentage <= 0) return;

            const now = Date.now();
            if (window.lastDiscountNotificationTime && (now - window.lastDiscountNotificationTime < 5000)) {
                return;
            }
            
            window.lastDiscountNotificationTime = now;
            
            const oldNote = document.querySelector('.discount-notification');
            if (oldNote) oldNote.remove();

            const notification = document.createElement('div');
            notification.className = 'discount-notification';
            
            const msg = (window.gradualDiscount && window.gradualDiscount.alertMessage) || 'Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø®ØµÙ… ØªØ¯Ø±ÙŠØ¬ÙŠ';

            notification.innerHTML = `
                ğŸ‰ ${msg} Ø¨Ù†Ø³Ø¨Ø© ${discountPercentage}%!
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        /* ====================== Ù†Ø¸Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ====================== */
        window.applyDiscount = function() {
            const code = discountCodeInput.value.trim().toUpperCase();
            
            if (!code) {
                discountMessage.style.color = 'var(--danger)';
                discountMessage.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…';
                discountMessage.style.display = 'block';
                return;
            }
            
            if (!discountCodes[code]) {
                discountMessage.style.color = 'var(--danger)';
                discountMessage.textContent = 'âŒ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
                discountMessage.style.display = 'block';
                return;
            }
            
            const discount = discountCodes[code];
            
            if (discount.used) {
                discountMessage.style.color = 'var(--danger)';
                discountMessage.textContent = 'âŒ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹';
                discountMessage.style.display = 'block';
                return;
            }
            
            let productSubTotal = 0;
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            
            cart.forEach(item => {
                let rawPrice = (item.price || "").toString().replace(/[^0-9.]/g, '');
                let priceVal = parseFloat(rawPrice) || 0;
                productSubTotal += priceVal * (item.qty || 0);
            });
            
            if (productSubTotal < discount.minPurchase) {
                discountMessage.style.color = 'var(--danger)';
                discountMessage.textContent = `âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ${discount.minPurchase.toLocaleString()} Ø±.ÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯`;
                discountMessage.style.display = 'block';
                return;
            }
            
            appliedDiscount = discount;
            appliedDiscountCode = code;
            
            localStorage.setItem('appliedDiscount', JSON.stringify({ discount, code }));
            
            discountMessage.style.color = 'green';
            discountMessage.textContent = `âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ… ${discount.type === 'percentage' ? discount.value + '%' : discount.value.toLocaleString() + ' Ø±.ÙŠ'} Ø¨Ù†Ø¬Ø§Ø­!`;
            discountMessage.style.display = 'block';
            
            renderCart();
        };

        window.removeDiscount = function() {
            appliedDiscount = null;
            appliedDiscountCode = '';
            localStorage.removeItem('appliedDiscount');
            discountMessage.style.display = 'none';
            discountCodeInput.value = '';
            renderCart();
        };

        /* ====================== Ø¯Ø§Ù„Ø© renderCart ====================== */
        window.renderCart = function(){
            loadGradualDiscountSettings();
            
            const savedDiscount = localStorage.getItem('appliedDiscount');
            if (savedDiscount) {
                const discountData = JSON.parse(savedDiscount);
                appliedDiscount = discountData.discount;
                appliedDiscountCode = discountData.code;
            }
            
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            cartItemsContainer.innerHTML = "";
            
            if(cart.length === 0){
                emptyCartMsg.style.display = "block";
                cartActionBarContent.style.display = "none";
                checkoutSection.style.display = "none";
                return;
            }

            emptyCartMsg.style.display = "none";
            cartActionBarContent.style.display = "flex";
            checkoutSection.style.display = "block";
            
            let productSubTotal = 0;
            
            cart.forEach(item => {
                const originalProduct = (window.allProducts || []).find(p => p.id == item.id);
                
                const productName = originalProduct ? originalProduct.name : (item.name || "Ù…Ù†ØªØ¬");
                const productPrice = originalProduct ? originalProduct.price : (item.price || "0");
                
                let rawPrice = (item.sizeName && item.price) ? item.price.toString().replace(/[^0-9.]/g,'') : 
                               productPrice.toString().replace(/[^0-9.]/g,'');
                let priceVal = parseFloat(rawPrice) || 0;
                let itemTotal = priceVal * (item.qty || 0);
                productSubTotal += itemTotal;

                let itemDisplayPrice, itemDisplayTotal;
                let displayCurrency = 'Ø±.ÙŠ';
                
                if (currentCurrency === 'YER') {
                    itemDisplayPrice = priceVal.toLocaleString() + " Ø±.ÙŠ";
                    itemDisplayTotal = itemTotal.toLocaleString() + " Ø±.ÙŠ";
                } else {
                    itemDisplayPrice = Math.ceil(priceVal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                    itemDisplayTotal = Math.ceil(itemTotal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                    displayCurrency = 'Ø±.Ø³';
                }

                const sizeInfo = item.sizeName ? `<div style="font-size: 12px; color: #666; margin-top: 3px;">Ø§Ù„Ù…Ù‚Ø§Ø³: ${item.sizeName}</div>` : '';
                
                cartItemsContainer.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${productName}</div>
                            ${sizeInfo}
                            <div class="cart-item-price">
                                <span>Ø§Ù„Ø³Ø¹Ø±: ${itemDisplayPrice}</span>
                                <span>Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.qty || 1}</span>
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${itemDisplayTotal}</span>
                            </div>
                        </div>
                        <div class="cart-qty-controls">
                            <button class="qty-btn" onclick="changeQty('${item.id}', -1, '${item.sizeName || ''}')" title="ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©">-</button>
                            <div class="qty-display">${item.qty || 1}</div>
                            <button class="qty-btn" onclick="changeQty('${item.id}', 1, '${item.sizeName || ''}')" title="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©">+</button>
                        </div>
                    </div>
                `;
            });

            const gradualDiscountPercentage = calculateGradualDiscount(productSubTotal);
            const gradualDiscountAmount = gradualDiscountPercentage > 0 ? (productSubTotal * gradualDiscountPercentage) / 100 : 0;
            
            if (gradualDiscountPercentage > 0) {
                showGradualDiscountNotification(gradualDiscountPercentage);
            }
            
            let codeDiscountAmount = 0;
            if (appliedDiscount) {
                if (appliedDiscount.type === 'percentage') {
                    codeDiscountAmount = (productSubTotal * appliedDiscount.value) / 100;
                } else {
                    codeDiscountAmount = appliedDiscount.value;
                }
            }
            
            const totalDiscountAmount = gradualDiscountAmount + codeDiscountAmount;
            
            if (appliedDiscount) {
                discountMessage.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:green;">âœ… ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (${appliedDiscountCode}) Ù…Ø·Ø¨Ù‚</span>
                        <button onclick="removeDiscount()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:12px;">
                            Ø¥Ø²Ø§Ù„Ø©
                        </button>
                    </div>
                `;
                discountMessage.style.display = 'block';
            }

            let finalProductTotalYER = productSubTotal - totalDiscountAmount;
            let shippingCostYER = parseInt(shippingSelect.value || "1000");
            let finalTotalYER = finalProductTotalYER + shippingCostYER;

            let displayCurrencySymbol = ' Ø±.ÙŠ';
            let productsTotalDisplayValue = productSubTotal;
            let gradualDiscountDisplayValue = gradualDiscountAmount;
            let codeDiscountDisplayValue = codeDiscountAmount;
            let shippingDisplayValue = shippingCostYER;
            let finalTotalDisplayValue = finalTotalYER;

            if (currentCurrency === 'SAR') {
                displayCurrencySymbol = ' Ø±.Ø³';
                productsTotalDisplayValue = Math.ceil(productSubTotal / SAR_RATE);
                gradualDiscountDisplayValue = Math.ceil(gradualDiscountAmount / SAR_RATE);
                codeDiscountDisplayValue = Math.ceil(codeDiscountAmount / SAR_RATE);
                shippingDisplayValue = Math.ceil(shippingCostYER / SAR_RATE);
                finalTotalDisplayValue = Math.ceil(finalTotalYER / SAR_RATE);
            }
            
            productsTotalDisplay.innerText = productsTotalDisplayValue.toLocaleString() + displayCurrencySymbol;
            
            if (gradualDiscountPercentage > 0) {
                gradualDiscountRow.style.display = 'flex';
                gradualDiscountPercent.innerText = gradualDiscountPercentage + '%';
                gradualDiscountDisplay.innerText = '-' + gradualDiscountDisplayValue.toLocaleString() + displayCurrencySymbol;
            } else {
                gradualDiscountRow.style.display = 'none';
            }
            
            if (codeDiscountAmount > 0) {
                codeDiscountRow.style.display = 'flex';
                codeDiscountCode.innerText = appliedDiscountCode;
                codeDiscountDisplay.innerText = '-' + codeDiscountDisplayValue.toLocaleString() + displayCurrencySymbol;
            } else {
                codeDiscountRow.style.display = 'none';
            }
            
            shippingDisplay.innerText = shippingDisplayValue.toLocaleString() + displayCurrencySymbol;
            finalTotalDisplay.innerText = finalTotalDisplayValue.toLocaleString() + displayCurrencySymbol;
            
            updateCartTotalDisplay();
        };

        /* ====================== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ====================== */
        window.sendCart = function(){
            cart = JSON.parse(localStorage.getItem("cart")||"[]") || cart;
            if(cart.length === 0) return;
            
            let msg = "ğŸ“¦ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø±*\n\n";
            msg += "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\n";
            msg += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
            
            let productSubTotal = 0;
            
            cart.forEach((i, idx) => {
                let rawPrice = (i.price || "").toString().replace(/[^0-9.]/g, '');
                let priceVal = parseFloat(rawPrice) || 0;
                let itemTotal = priceVal * (i.qty || 0);
                productSubTotal += itemTotal;
                
                let displayPrice = priceVal.toLocaleString() + " Ø±.ÙŠ";
                let displayItemTotal = itemTotal.toLocaleString() + " Ø±.ÙŠ";
                
                if (currentCurrency === 'SAR') {
                    displayPrice = Math.ceil(priceVal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                    displayItemTotal = Math.ceil(itemTotal / SAR_RATE).toLocaleString() + " Ø±.Ø³";
                }
                
                msg += `${idx+1}. ${i.name}\n`;
                if (i.sizeName) {
                    msg += `   Ø§Ù„Ù…Ù‚Ø§Ø³: ${i.sizeName}\n`;
                }
                msg += `   Ø§Ù„ÙƒÙ…ÙŠØ©: ${i.qty}\n`;
                msg += `   Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙˆØ§Ø­Ø¯Ø©: ${displayPrice}\n`;
                msg += `   Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${displayItemTotal}\n`;
                msg += `   â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            });
            
            const gradualDiscountPercentage = calculateGradualDiscount(productSubTotal);
            const gradualDiscountAmount = gradualDiscountPercentage > 0 ? (productSubTotal * gradualDiscountPercentage) / 100 : 0;
            
            let codeDiscountAmount = 0;
            let codeDiscountInfo = '';
            if (appliedDiscount) {
                if (appliedDiscount.type === 'percentage') {
                    codeDiscountAmount = (productSubTotal * appliedDiscount.value) / 100;
                    codeDiscountInfo = `Ø®ØµÙ… ${appliedDiscount.value}% (${appliedDiscountCode})`;
                } else {
                    codeDiscountAmount = appliedDiscount.value;
                    codeDiscountInfo = `Ø®ØµÙ… ${appliedDiscount.value.toLocaleString()} Ø±.ÙŠ (${appliedDiscountCode})`;
                }
            }
            
            const totalDiscountAmount = gradualDiscountAmount + codeDiscountAmount;
            
            let finalProductTotalYER = productSubTotal - totalDiscountAmount;
            let shippingCostYER = parseInt(shippingSelect.value || "1000");
            let finalTotalYER = finalProductTotalYER + shippingCostYER;
            
            let displayCurrencySymbol = ' Ø±.ÙŠ';
            let displayProductSubTotal = productSubTotal;
            let displayGradualDiscount = gradualDiscountAmount;
            let displayCodeDiscount = codeDiscountAmount;
            let displayShippingCost = shippingCostYER;
            let displayFinalTotal = finalTotalYER;

            if (currentCurrency === 'SAR') {
                displayCurrencySymbol = ' Ø±.Ø³';
                displayProductSubTotal = Math.ceil(productSubTotal / SAR_RATE);
                displayGradualDiscount = Math.ceil(gradualDiscountAmount / SAR_RATE);
                displayCodeDiscount = Math.ceil(codeDiscountAmount / SAR_RATE);
                displayShippingCost = Math.ceil(shippingCostYER / SAR_RATE);
                displayFinalTotal = Math.ceil(finalTotalYER / SAR_RATE);
            }
            
            const shippingLocation = shippingSelect.options[shippingSelect.selectedIndex].text;
            
            msg += `\nğŸ“Š *Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:*\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            msg += `ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${displayProductSubTotal.toLocaleString()}${displayCurrencySymbol}\n`;
            
            if (gradualDiscountPercentage > 0) {
                msg += `ğŸ¯ Ø§Ù„Ø®ØµÙ… Ø§Ù„ØªØ¯Ø±ÙŠØ¬ÙŠ (${gradualDiscountPercentage}%): -${displayGradualDiscount.toLocaleString()}${displayCurrencySymbol}\n`;
            }
            
            if (codeDiscountAmount > 0) {
                msg += `ğŸ ${codeDiscountInfo}: -${displayCodeDiscount.toLocaleString()}${displayCurrencySymbol}\n`;
            }
            
            msg += `ğŸ“ Ø§Ù„ØªÙˆØµÙŠÙ„ (${shippingLocation.split('(')[0]}): +${displayShippingCost.toLocaleString()}${displayCurrencySymbol}\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            msg += `ğŸŒŸ *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${displayFinalTotal.toLocaleString()}${displayCurrencySymbol}*\n\n`;
            
            msg += `ğŸ“ *Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„:*\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            msg += `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${shippingLocation.split('(')[0]}\n`;
            msg += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-YE')}\n`;
            msg += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
            msg += `Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨ÙƒÙ… Ù…Ù† Ù…ØªØ¬Ø± Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ğŸ âœ¨\n`;
            msg += `Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªÙˆØµÙŠÙ„.`;

            window.open(`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`);
        };

        /* ====================== Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± ====================== */
        async function fetchAllProductsLite() {
            console.log('ğŸ”„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©...');
            
            try {
                if (sb) {
                    // âœ… Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙŠØ© ÙÙ‚Ø· Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø­Ù‚Ù„ image
                    const { data, error } = await sb
                        .from('products')
                        .select('id, name, price, category, sizes, created_at, image, description')
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
                        return false;
                    }

                    if (data && Array.isArray(data) && data.length > 0) {
                        window.allProducts = data.map(product => {
                            let sizesData = null;
                            if (product.sizes) {
                                try {
                                    if (typeof product.sizes === 'string') {
                                        sizesData = JSON.parse(product.sizes);
                                    } else {
                                        sizesData = product.sizes;
                                    }
                                } catch (e) {
                                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:', e);
                                    sizesData = null;
                                }
                            }
                            
                            // âœ… ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Storage Ù…Ø¨Ø§Ø´Ø±
                            const imageUrl = product.image ? getProductImageUrl(product.image) : null;
                            
                            return {
                                id: product.id.toString(),
                                name: product.name || 'Ù…Ù†ØªØ¬',
                                price: parseFloat(product.price) || 0,
                                category: product.category || 'Ø¹Ø§Ù…',
                                image: imageUrl,
                                sizes: sizesData,
                                created_at: product.created_at || null,
                                updated_at: product.created_at || null,
                                description: product.description || 'Ù…Ù†ØªØ¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©'
                            };
                        });
                        
                        console.log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${window.allProducts.length} Ù…Ù†ØªØ¬ Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©`);
                        return true;
                    } else {
                        window.allProducts = [];
                        return false;
                    }
                }
            } catch (err) {
                console.error('ğŸš¨ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', err);
            }
            
            return false;
        }

        window.loadMoreProducts = function() {
            if (hasMoreProducts && !isLoadingProducts) {
                console.log(`ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ø§Ù„ØµÙØ­Ø©: ${currentPage}`);
                fetchProducts(true);
            }
        };

        async function fetchProducts(loadMore = false) {
            if (isLoadingProducts) {
                console.log('â³ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ù†ØªØ¸Ø±...');
                return;
            }
            
            isLoadingProducts = true;
            
            if (!loadMore) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ù‡ÙŠØ§ÙƒÙ„ Ø¹Ø¸Ù…ÙŠØ© Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„
                showSkeletons();
                currentPage = 1;
                hasMoreProducts = true;
                window.allProducts = [];
                loadingIndicator.style.display = 'block';
                loadMoreContainer.style.display = 'none';
            } else {
                loadingIndicator.style.display = 'block';
                loadMoreContainer.style.display = 'none';
            }
            
            try {
                console.log('ğŸ“¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...');
                
                if (sb) {
                    console.log(`âœ… Supabase Ù…ØªØ§Ø­ØŒ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø§Ù„ØµÙØ­Ø©: ${currentPage}`);
                    
                    const from = (currentPage - 1) * productsPerPage;
                    const to = from + productsPerPage - 1;
                    
                    let query = sb
                        .from('products')
                        .select('id, name, price, category, sizes, created_at, image, description')
                        .order('created_at', { ascending: false });
                    
                    if (loadMore) {
                        query = query.range(from, to);
                    }
                        
                    const { data: products, error } = await query;
                    
                    if (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase:', error);
                        throw error;
                    }
                    
                    console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', products ? products.length : 0, 'Ù…Ù†ØªØ¬');
                    
                    if (products && Array.isArray(products) && products.length > 0) {
                        const newProducts = products.map(product => {
                            let sizesData = null;
                            if (product.sizes) {
                                try {
                                    if (typeof product.sizes === 'string') {
                                        sizesData = JSON.parse(product.sizes);
                                    } else {
                                        sizesData = product.sizes;
                                    }
                                } catch (e) {
                                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:', e);
                                    sizesData = null;
                                }
                            }
                            
                            // âœ… ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Storage Ù…Ø¨Ø§Ø´Ø±
                            const imageUrl = product.image ? getProductImageUrl(product.image) : null;
                            
                            return {
                                id: product.id.toString(),
                                name: product.name || 'Ù…Ù†ØªØ¬',
                                price: parseFloat(product.price) || 0,
                                category: product.category || 'Ø¹Ø§Ù…',
                                image: imageUrl,
                                sizes: sizesData,
                                created_at: product.created_at || null,
                                updated_at: product.created_at || null,
                                description: product.description || 'Ù…Ù†ØªØ¬ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† Ø§Ø¨Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©'
                            };
                        });
                        
                        if (loadMore) {
                            window.allProducts = [...window.allProducts, ...newProducts];
                        } else {
                            window.allProducts = newProducts;
                        }
                        
                        console.log(`ğŸ”„ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${window.allProducts.length} Ù…Ù†ØªØ¬ Ø¥Ø¬Ù…Ø§Ù„Ø§Ù‹`);
                        console.log(`ğŸ“Š Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ù…Ù‚Ø§Ø³Ø§Øª: ${window.allProducts.filter(p => p.sizes && p.sizes.length > 0).length}`);
                        
                        hasMoreProducts = newProducts.length === productsPerPage;
                        
                        if (hasMoreProducts) {
                            currentPage++;
                        }
                    } else {
                        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª
                        window.allProducts = [];
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                    renderProducts();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø§Øª
                    if (!loadMore) {
                        fetchCategories();
                    }
                    
                } else {
                    console.warn('âš ï¸ Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±');
                    if (!loadMore) {
                        window.allProducts = [];
                        renderProducts();
                        fetchCategories();
                    }
                }
            } catch (err) {
                console.error('ğŸš¨ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', err);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                showErrorMessage('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.');
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                if (!loadMore) {
                    window.allProducts = [];
                    renderProducts();
                    fetchCategories();
                }
            } finally {
                isLoadingProducts = false;
                loadingIndicator.style.display = 'none';
            }
        }

        /* ====================== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ====================== */
        async function fetchCategories() {
            const categoriesBar = document.getElementById('categoriesBar');
            if (!categoriesBar) return;

            categoriesBar.innerHTML = '<span style="color:#999; font-size:12px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</span>';

            try {
                const { data: serverCats, error } = await sb
                    .from('categories')
                    .select('*')
                    .eq('active', true)
                    .order('order', { ascending: true });

                if (error) throw error;

                categoriesBar.innerHTML = '';

                const allBtn = document.createElement('button');
                allBtn.className = 'filter-btn active';
                allBtn.innerHTML = 'ğŸ‘ï¸ Ø§Ù„ÙƒÙ„';
                allBtn.onclick = () => {
                    window.filterProducts('all', allBtn);
                    window.scrollTo({top: 0, behavior: 'smooth'});
                };
                categoriesBar.appendChild(allBtn);

                if (serverCats && serverCats.length > 0) {
                    serverCats.forEach(cat => {
                        const btn = document.createElement('button');
                        btn.className = 'filter-btn';
                        
                        const icon = (cat.type === 'apps') ? 'ğŸ“± ' : '';
                        btn.innerHTML = icon + cat.name;
                        
                        btn.onclick = (e) => {
                            window.filterProducts(cat.name, e.target);
                            window.scrollTo({top: 0, behavior: 'smooth'});
                        };
                        categoriesBar.appendChild(btn);
                    });
                    console.log(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${serverCats.length} ØªØµÙ†ÙŠÙ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±`);
                } else {
                    renderDefaultCategories(categoriesBar);
                }

            } catch (err) {
                console.error('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:', err.message);
                const localSaved = JSON.parse(localStorage.getItem('headerCategories') || '[]');
                if (localSaved.length > 0) {
                    renderLocalFallback(categoriesBar, localSaved);
                }
            }
        }

        function renderDefaultCategories(container) {
            const defaults = ["Ø§Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠÙ‡", "Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©", "Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª ÙˆØ¹Ù†Ø§ÙŠÙ‡ Ø´Ø®ØµÙŠÙ‡"];
            defaults.forEach(name => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = name;
                btn.onclick = (e) => window.filterProducts(name, e.target);
                container.appendChild(btn);
            });
        }

        function renderLocalFallback(container, localData) {
            localData.filter(c => c.active).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.innerText = cat.name;
                btn.onclick = (e) => window.filterProducts(cat.name, e.target);
                container.appendChild(btn);
            });
        }

        setInterval(() => {
            console.log("ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...");
            fetchCategories();
        }, 60000);

        /* ====================== Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ====================== */
        window.addEventListener('storage', function(e) {
            if (e.key === 'headerCategories' || e.key === 'categoriesUpdated') {
                console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙÙŠ localStorageØŒ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±...');
                fetchCategories();
                showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            }
        });

        window.addEventListener('focus', function() {
            console.log('ğŸ”„ Ø§Ù„ØµÙØ­Ø© Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ÙƒÙŠØ²ØŒ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª...');
        });

        /* ====================== Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ====================== */
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product');
            
            loadGradualDiscountSettings();
            
            const savedDiscount = localStorage.getItem('appliedDiscount');
            if (savedDiscount) {
                const discountData = JSON.parse(savedDiscount);
                appliedDiscount = discountData.discount;
                appliedDiscountCode = discountData.code;
            }
            
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Egress...');
            
            try {
                const connectionTest = await testSupabaseConnection();
                
                if (connectionTest) {
                    console.log('âœ… Ø§ØªØµØ§Ù„ Supabase Ø¬Ø§Ù‡Ø²ØŒ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ±...');
                    const success = await fetchAllProductsLite();
                    
                    if (!success) {
                        // Ø¥Ø°Ø§ ÙØ´Ù„ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…
                        console.log('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„ØªØ­Ù…ÙŠÙ„');
                        await fetchProducts(false);
                    } else {
                        renderProducts();
                        fetchCategories();
                    }
                } else {
                    console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase');
                    showErrorMessage('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±.');
                    window.allProducts = [];
                    renderProducts();
                    fetchCategories();
                }
            } catch (error) {
                console.error('ğŸš¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
                showErrorMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
                window.allProducts = [];
                renderProducts();
                fetchCategories();
            }
            
            if (productId && window.allProducts && window.allProducts.length > 0) {
                const productExists = window.allProducts.some(p => p.id === productId);
                if (productExists) {
                    openProductPage(productId);
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« badge Ø§Ù„Ø³Ù„Ø© ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„Ø©
            updateCartBadge();
            updateCartTotalDisplay();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØµØ­ÙŠØ­
            console.log('âœ… Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Egress:', {
                totalProducts: window.allProducts ? window.allProducts.length : 0,
                cartItems: cart.length
            });
            
            // ØªÙ‡ÙŠØ¦Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙˆØ±
            setTimeout(() => {
                initImageObserver();
                observeImages();
            }, 1000);
        };

        /* ====================== Initial setup ====================== */
        window.onpageshow = function(event){
            if(event.persisted || performance?.navigation?.type == 2){
                cart = JSON.parse(localStorage.getItem("cart")||"[]") || [];
                updateCartBadge();
                updateCartTotalDisplay();
            }
        };

        updateCartBadge();
        updateCartTotalDisplay();
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Error', err));
            });
        }
        
        async function trackVisit() {
            let visitorId = localStorage.getItem('visitor_id');
            if (!visitorId) {
                visitorId = 'v-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('visitor_id', visitorId);
            }

            try {
                await sb.from('visits').insert([{ 
                    page_path: window.location.pathname,
                    visitor_id: visitorId
                }]);
            } catch (error) {
                console.error('Error tracking visit:', error);
            }
        }
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ trackVisit Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        setTimeout(trackVisit, 1000);
    </script>
</body>
</html>